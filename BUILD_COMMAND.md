# Build Command Documentation

## Overview

The `build` command flattens your modular workshop structure into a deployable, self-contained directory. This command is **essential for deployment** - it takes your workshop configuration and creates a complete, navigable workshop ready for GitHub Pages, LMS platforms, or standalone use.

## What It Does

The build process performs these operations:

1. **Resolves Modules** - Locates all canonical and customized modules from your workshop configuration
2. **Copies Content** - Flattens module content files into numbered directories
3. **Creates Indexes** - Generates README.md files for modules that don't have one
4. **Injects Navigation** - Adds navigation controls to all module pages
5. **Generates Home Page** - Creates a workshop home page with full metadata

## Usage

### Basic Build

```bash
python3 shared/tools/workshop-builder.py build --workshop <workshop-name>
```

This creates a `build/` directory inside your workshop with the flattened structure.

### Custom Output Directory

```bash
python3 shared/tools/workshop-builder.py build \
  --workshop <workshop-name> \
  --output-dir /path/to/custom/output
```

## Output Structure

After running build, you get this structure:

```
workshops/my-workshop/
â”œâ”€â”€ build/                          # â† Generated by build command
â”‚   â”œâ”€â”€ README.md                   # Workshop home page
â”‚   â”œâ”€â”€ 01-redis-fundamentals/      # Module 1 (numbered)
â”‚   â”‚   â”œâ”€â”€ README.md               # Module index (auto-generated or copied)
â”‚   â”‚   â””â”€â”€ content/                # Module content files
â”‚   â”‚       â”œâ”€â”€ 01-what-is-redis.md
â”‚   â”‚       â”œâ”€â”€ 02-data-structures.md
â”‚   â”‚       â””â”€â”€ 03-use-cases.md
â”‚   â”œâ”€â”€ 02-azure-options/           # Module 2
â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ 03-waf-overview/            # Module 3
â”‚       â”œâ”€â”€ README.md
â”‚       â””â”€â”€ ...
```

### Key Features

1. **Sequential Numbering**: Modules are numbered `01-`, `02-`, etc., reflecting workshop order
2. **Self-Contained**: All files copied from source modules (canonical or customized)
3. **Navigation Ready**: Every module README includes navigation controls
4. **Home Page**: Workshop README with full metadata and module links

## Build Process Details

### 1. Module Resolution

The build command supports multiple module reference formats:

```json
// Module ID format (recommended)
{
  "modules": [
    {
      "moduleRef": "core.redis-fundamentals.v1",
      "order": 1
    }
  ]
}

// Path format (legacy)
{
  "chapters": [
    {
      "chapterRef": "shared/modules/redis-fundamentals",
      "order": 1
    }
  ]
}
```

Resolution logic:
- **Module ID** (`core.redis-fundamentals.v1`) â†’ Searches `workshops/*/modules/` then `shared/modules/`
- **Shared path** (`shared/modules/...`) â†’ Canonical module
- **Relative path** (`modules/...`) â†’ Customized module in workshop directory

### 2. Content Flattening

The build process:
- Copies all files except `module.yaml`, `.lineage`, `.DS_Store`
- Preserves directory structure (e.g., `content/` subdirectories)
- Counts files for progress reporting

### 3. Module Index Generation

If a module doesn't have `README.md`, the build creates one with:
- Module title and description
- Duration and difficulty
- Learning objectives
- Links to content files (if in `content/` subdirectory)

Example auto-generated README:

```markdown
# Redis Fundamentals

**Module 1 of 5**

Introduction to Redis core concepts, data structures, and common use cases.

## ğŸ“‹ Module Details

- **Duration**: 60 minutes
- **Difficulty**: Beginner

## ğŸ¯ Learning Objectives

- Understand what Redis is and when to use it
- Master the five core data structures
- Learn common Redis use cases

## ğŸ“š Content

- [What Is Redis](content/01-what-is-redis.md)
- [Data Structures](content/02-data-structures.md)
- [Use Cases](content/03-use-cases.md)
```

### 4. Navigation Injection

Navigation is read from `.nav/*.html` files and injected into module READMEs:

```markdown
<!-- NAV:START -->
<!-- This navigation is auto-generated. Do not edit manually. -->
## ğŸ§­ Navigation

<table>
<tr>
<td width="33%" align="left">

### â† [Previous](../01-redis-fundamentals/README.md)
**Redis Fundamentals**

</td>
<td width="34%" align="center">

### [ğŸ  Home](../../README.md)
**Workshop Home**  
ğŸ“ Module 2 of 5

</td>
<td width="33%" align="right">

### [Next](../03-waf-overview/README.md) â†’
**WAF Overview**

</td>
</tr>
</table>

---

### ğŸ“š Workshop Modules

1. Redis Fundamentals
2. **Azure Redis Options** â† *You are here*
3. WAF Overview
4. ...

---
<!-- NAV:END -->
```

Navigation markers:
- `<!-- NAV:START -->` and `<!-- NAV:END -->` wrap the navigation
- If markers exist, navigation is updated
- If markers don't exist, navigation is inserted at the top (after title)

### 5. Workshop Home Page

The home page (`build/README.md`) includes:

- Workshop title and description
- Duration, difficulty, last updated
- Learning objectives
- Prerequisites
- Module listing with links
- Author information
- Getting started instructions

## Workflow Examples

### Development Workflow

```bash
# 1. Create workshop
bash shared/tools/create-workshop.sh my-workshop "My Workshop" "4 hours"

# 2. Add modules
python3 shared/tools/workshop-builder.py add \
  --workshop my-workshop \
  --module core.redis-fundamentals.v1

python3 shared/tools/workshop-builder.py add \
  --workshop my-workshop \
  --module core.azure-redis-options.v1

# 3. Generate navigation
python3 shared/tools/workshop-builder.py update-navigation \
  --workshop my-workshop

# 4. Build for deployment
python3 shared/tools/workshop-builder.py build \
  --workshop my-workshop

# 5. Test locally
open workshops/my-workshop/build/README.md

# 6. Deploy
cp -r workshops/my-workshop/build/* docs/workshops/my-workshop/
git add docs/workshops/my-workshop
git commit -m "Deploy my-workshop"
git push
```

### Customization Workflow

```bash
# 1. Fork a canonical module
python3 shared/tools/module-manager.py fork \
  --source core.redis-fundamentals.v1 \
  --workshop my-workshop

# 2. Edit customized module
vim workshops/my-workshop/modules/redis-fundamentals/content/01-what-is-redis.md

# 3. Rebuild
python3 shared/tools/workshop-builder.py build \
  --workshop my-workshop
```

### Continuous Deployment

```bash
# rebuild.sh - Run after any workshop changes
#!/bin/bash

WORKSHOP=$1

# Update navigation
python3 shared/tools/workshop-builder.py update-navigation --workshop $WORKSHOP

# Build
python3 shared/tools/workshop-builder.py build --workshop $WORKSHOP

# Deploy to docs/
mkdir -p docs/workshops/$WORKSHOP
cp -r workshops/$WORKSHOP/build/* docs/workshops/$WORKSHOP/

echo "âœ… Rebuilt and deployed: $WORKSHOP"
```

## Build Output Validation

After building, verify:

```bash
# Check structure
ls -R workshops/my-workshop/build/

# Verify navigation exists
grep -r "NAV:START" workshops/my-workshop/build/

# Check home page
cat workshops/my-workshop/build/README.md

# Count modules
ls -d workshops/my-workshop/build/*/  | wc -l
```

## Error Handling

### Common Errors

**Module not found:**
```
âŒ Error: Module not found: core.redis-fundamentals.v1 
   (searched: workshops/my-workshop/modules/redis-fundamentals, shared/modules/redis-fundamentals)
```
**Solution**: Check module ID spelling, ensure module exists in `shared/modules/` or `workshops/my-workshop/modules/`

**No navigation files:**
```
âš ï¸  No navigation files found in .nav/ directory
ğŸ’¡ Run: workshop-builder.py update-navigation --workshop my-workshop
```
**Solution**: Generate navigation before building

**Invalid workshop config:**
```
âŒ Error: Workshop 'my-workshop' not found at workshops/my-workshop/workshop.config.json
```
**Solution**: Check workshop name, ensure `workshop.config.json` exists

## Best Practices

### 1. Always Update Navigation First

```bash
# âœ… Good
python3 shared/tools/workshop-builder.py update-navigation --workshop my-workshop
python3 shared/tools/workshop-builder.py build --workshop my-workshop

# âŒ Bad (navigation will be missing)
python3 shared/tools/workshop-builder.py build --workshop my-workshop
```

### 2. Version Control Build Output (Optional)

```bash
# Add build/ to .gitignore if you regenerate on deployment
echo "build/" >> workshops/my-workshop/.gitignore

# OR commit build/ for static hosting
git add workshops/my-workshop/build/
git commit -m "Add built workshop"
```

### 3. Clean Builds

The build command automatically cleans the output directory:
```
ğŸ—‘ï¸  Cleaning existing build directory: workshops/my-workshop/build
```

This ensures no stale files remain from previous builds.

### 4. Test Before Deployment

```bash
# Build locally
python3 shared/tools/workshop-builder.py build --workshop my-workshop

# Test in browser
open workshops/my-workshop/build/README.md

# Check all modules load
for module in workshops/my-workshop/build/*/README.md; do
  echo "Testing: $module"
  open "$module"
  sleep 2
done
```

## Integration with Other Tools

### With GitHub Pages

```bash
# Build to docs/ directory (GitHub Pages source)
python3 shared/tools/workshop-builder.py build \
  --workshop my-workshop \
  --output-dir docs/workshops/my-workshop
```

### With CI/CD

```yaml
# .github/workflows/deploy-workshops.yml
name: Deploy Workshops

on:
  push:
    paths:
      - 'workshops/**'
      - 'shared/modules/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Build all workshops
        run: |
          for workshop in workshops/*/; do
            name=$(basename "$workshop")
            python3 shared/tools/workshop-builder.py update-navigation --workshop "$name"
            python3 shared/tools/workshop-builder.py build --workshop "$name" --output-dir "docs/workshops/$name"
          done
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
```

## Performance

Build performance scales linearly with module count and content size:

- **Small workshop** (1-3 modules): < 1 second
- **Medium workshop** (4-8 modules): 1-2 seconds
- **Large workshop** (9+ modules): 2-5 seconds

Operations:
- File copying: ~100-500 files/second (depends on disk)
- Navigation injection: ~50-100 files/second
- Home page generation: < 100ms

## Troubleshooting

### Navigation not appearing

1. Check `.nav/` directory exists
2. Verify navigation files are `.html` format
3. Ensure filenames match module directory names
4. Run `update-navigation` before `build`

### Module content missing

1. Check `module.yaml` lists content in metadata
2. Verify content files aren't filtered (not `.DS_Store`, etc.)
3. Check source module directory structure

### Build directory permissions

```bash
# Fix permissions
chmod -R u+w workshops/my-workshop/build/

# Or delete and rebuild
rm -rf workshops/my-workshop/build/
python3 shared/tools/workshop-builder.py build --workshop my-workshop
```

## Next Steps

After building:

1. **Review** - Check generated files in `build/` directory
2. **Test** - Open `build/README.md` and navigate through modules
3. **Deploy** - Copy to `docs/`, push to GitHub Pages, or upload to LMS
4. **Iterate** - Make changes, rebuild, redeploy

See also:
- [WORKSHOP_CREATOR_GUIDE.md](WORKSHOP_CREATOR_GUIDE.md) - Complete workflow
- [NAVIGATION_DESIGN.md](NAVIGATION_DESIGN.md) - Navigation system
- [QUICK_REFERENCE.md](QUICK_REFERENCE.md) - Command cheat sheet
