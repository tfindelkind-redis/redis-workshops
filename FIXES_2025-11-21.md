# Fixes Applied - 2025-11-21

## Summary
Fixed multiple issues related to module customization, duplicate directory creation, and file overwriting when saving workshops.

## Issues Fixed

### 1. Removed Automatic `-custom` Suffix
**Problem:** When customizing a module, `-custom` was automatically appended to the folder name.

**Fix:** Removed automatic `-custom` suffix in two places:
- `shared/tools/workshop-builder-gui.html` line ~2535 (customizeModuleFromBrowser)
- `shared/tools/workshop-builder-gui.html` line ~4220 (copy as template flow)

**Result:** Users can now control the folder name themselves when customizing modules.

### 2. Auto-Update Folder Name When Title Changes
**Problem:** When user changed the module title in the customize dialog, the folder name didn't update.

**Fix:** 
- Added `oninput="updateModuleRefFromName()"` to the custom-module-name input field
- Created new function `updateModuleRefFromName()` that updates the folder name while preserving the `module-03-` prefix

**Result:** Folder name now automatically reflects the new module title while keeping the sequential prefix.

### 3. Fixed README Generation Using Wrong Folder Names
**Problem:** Workshop README was generating folder names from module titles instead of using actual folder names from `moduleRef`, causing duplicate directories.

**Fix:** Modified `generateModulesTableOfContents()` in `shared/tools/workshop-ops.js`:
- Added `workshopId` parameter
- Check if `moduleRef` points to same workshop → Use actual folder name from `moduleRef`
- Otherwise generate folder name from index and title (for inherited modules)

**Result:** README links now use actual directory names, preventing duplicate creation.

### 4. Fixed Module Files Being Overwritten on Save
**Problem:** When saving workshop, `module.yaml` and other files were being overwritten in existing modules.

**Fix:** Refactored `createModuleDirectory()` in `shared/tools/workshop-ops.js`:
- **FIRST:** Check if `moduleRef` points to same workshop → Return immediately without any file operations
- **SECOND:** Generate folder name for inherited modules  
- **THIRD:** Check if directory exists → Return immediately without file operations
- **FOURTH:** Only create/copy files for genuinely new modules

**Fix:** Modified `generateModuleStructure()` to call `updateModuleNavigation()` after processing all modules:
- This function ONLY updates navigation header/footer in README.md
- Does NOT touch module.yaml or any other files

**Result:** Existing modules are never overwritten. Only navigation is updated in README.md.

### 5. Fixed 500 Error on `/api/modules/exists` Endpoint
**Problem:** Endpoint was using undefined `BASE_PATH` variable, causing 500 errors.

**Fix:** Updated `shared/tools/server.js` line ~1087:
```javascript
// OLD (broken):
const fullPath = `${BASE_PATH}/${path}`;

// NEW (fixed):
const fullPath = path.join(gitOps.repoRoot, modulePath);
```

**Result:** Endpoint now correctly checks if modules exist, preventing duplicate creation attempts.

### 6. Fixed Module Navigation to Use Actual Folder Names
**Problem:** `updateModuleNavigation()` was generating folder names from module index/title, missing customized folders.

**Fix:** Modified `updateModuleNavigation()` in `shared/tools/workshop-ops.js`:
- Check if `moduleRef` points to same workshop → Extract actual folder name
- Otherwise generate from index and title

**Result:** Navigation correctly links to customized module folders.

## Files Changed

1. **shared/tools/workshop-builder-gui.html**
   - Removed `-custom` suffix auto-generation (2 places)
   - Added `updateModuleRefFromName()` function
   - Added `oninput` handler to module name field

2. **shared/tools/workshop-ops.js**
   - Refactored `createModuleDirectory()` with clear early returns
   - Modified `generateModulesTableOfContents()` to accept workshopId and use actual folder names
   - Modified `generateModuleStructure()` to call `updateModuleNavigation()` after all modules processed
   - Modified `updateModuleNavigation()` to use actual folder names from moduleRef

3. **shared/tools/server.js**
   - Fixed `/api/modules/exists` endpoint to use `gitOps.repoRoot` instead of undefined `BASE_PATH`

## Testing Checklist

After restarting the container, test the following workflow:

1. ✅ Load workshop with existing modules
2. ✅ Click "Add Module" → "Customize" on a parent module
3. ✅ Change the module title in the dialog
4. ✅ Verify folder name updates automatically (keeping `module-03-` prefix)
5. ✅ Click "Save" → Module created with correct folder name
6. ✅ Verify no 500 errors in browser console
7. ✅ Click "Save Workshop"
8. ✅ Verify NO duplicate directory is created
9. ✅ Verify module.yaml is NOT overwritten (check timestamps)
10. ✅ Verify README.md navigation is updated correctly
11. ✅ Verify workshop README links to correct folder names

## Expected Behavior After Fixes

**Customize Workflow:**
- Suggested folder name: `module-03-performance-efficiency--data-modeling` (no `-custom`)
- User changes title to "My Custom Module"
- Folder name updates to: `module-03-my-custom-module`
- User clicks Save → Directory created
- module.yaml contains: `parentPath: workshops/deploy-redis-for-developers-amr/module-06-...` (original parent)

**Save Workshop:**
- Reads existing modules from README
- Skips file operations for existing modules (same-workshop moduleRef or existing directories)
- Only updates navigation header/footer in README.md files
- Does NOT touch module.yaml or any other files
- Creates new modules only if they're inherited from parent and don't exist yet

## Container Restart Required

**The Node.js server must be restarted** for these fixes to take effect:
```bash
# Restart your container with the updated code
docker-compose restart  # or whatever command you use
```
