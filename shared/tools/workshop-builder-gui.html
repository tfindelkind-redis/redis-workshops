<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Builder GUI - Redis Workshops</title>
    <style>
        :root {
            --primary-color: #DC382D;
            --primary-dark: #B42D23;
            --secondary-color: #2C3E50;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --border-color: #e5e7eb;
            --bg-light: #f9fafb;
            --text-color: #1f2937;
            --text-light: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: var(--text-color);
            background: var(--bg-light);
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 3px solid var(--primary-color);
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-light);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .main-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 56, 45, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #1a252f;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-outline {
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .module-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .module-card {
            background: var(--bg-light);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            cursor: move;
            transition: all 0.3s;
        }

        .module-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .module-card.dragging {
            opacity: 0.5;
        }

        .module-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .module-card-title {
            font-weight: 600;
            color: var(--text-color);
            flex: 1;
        }

        .module-card-order {
            background: var(--primary-color);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 0.75rem;
        }

        .module-card-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }

        .module-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge.canonical {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge.customized {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.beginner {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.intermediate {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.advanced {
            background: #fee2e2;
            color: #991b1b;
        }

        .workshop-summary {
            background: var(--bg-light);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .workshop-summary h3 {
            margin-bottom: 1rem;
            color: var(--text-color);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .summary-label {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .module-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .module-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-light);
        }

        .module-browser {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
        }

        .module-browser-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s;
        }

        .module-browser-item:hover {
            background: var(--bg-light);
        }

        .module-browser-item:last-child {
            border-bottom: none;
        }

        .module-browser-item h4 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .module-browser-item p {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .action-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
        }

        .code-preview {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            overflow-x: auto;
            white-space: pre;
        }

        /* Tooltip styles */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--info-color);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: help;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .tooltip-text {
            visibility: hidden;
            position: absolute;
            z-index: 1001;
            background: var(--secondary-color);
            color: white;
            text-align: left;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            line-height: 1.4;
            width: 280px;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--secondary-color) transparent transparent transparent;
        }

        .tooltip-wrapper:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .workshop-browser {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .workshop-browser-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s;
            border-radius: 4px;
        }

        .workshop-browser-item:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
        }

        .workshop-browser-item:last-child {
            border-bottom: none;
        }

        .workshop-browser-item h4 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .workshop-browser-item p {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .workshop-browser-item .meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .empty-browser {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        @media (max-width: 1024px) {
            .layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
            }

            .tooltip-text {
                width: 220px;
            }
        }

        /* Notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 100%;">
            <div style="flex: 1;">
                <h1>üéì Workshop Builder GUI</h1>
                <p id="header-subtitle">Create and manage Redis workshops with visual tools - No command line required!</p>
            </div>
            <div id="github-pr-section" style="display: none; margin-left: 20px;">
                <button class="btn btn-success" onclick="createPullRequest()" style="padding: 10px 20px; font-size: 14px; white-space: nowrap;">
                    <span id="pr-button-text">üöÄ Create Pull Request</span>
                </button>
                <div id="pr-status" style="margin-top: 5px; font-size: 12px; text-align: center;"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="layout">
            <!-- Sidebar: Workshop Details -->
            <div class="sidebar">
                <h2 style="margin-bottom: 1.5rem;">Workshop Details</h2>
                
                <div class="form-group">
                    <label for="workshop-id">
                        Workshop ID *
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">A unique identifier for your workshop. Use lowercase letters, numbers, and hyphens only. Example: redis-caching-101</span>
                        </span>
                    </label>
                    <input type="text" id="workshop-id" placeholder="my-workshop">
                    <small>Lowercase letters, numbers, and hyphens only</small>
                </div>

                <div class="form-group">
                    <label for="workshop-title">
                        Title *
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">The display name of your workshop. This can include spaces, capitals, and special characters.</span>
                        </span>
                    </label>
                    <input type="text" id="workshop-title" placeholder="My Redis Workshop">
                </div>

                <div class="form-group">
                    <label for="workshop-description">
                        Description *
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">A brief overview of what participants will learn in this workshop. Keep it to 1-2 sentences.</span>
                        </span>
                    </label>
                    <textarea id="workshop-description" placeholder="Brief description of your workshop"></textarea>
                </div>

                <div class="form-group">
                    <label for="workshop-duration">
                        Duration *
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Estimated time to complete the workshop. Examples: "2 hours", "4 hours", "Full day"</span>
                        </span>
                    </label>
                    <input type="text" id="workshop-duration" placeholder="4 hours">
                </div>

                <div class="form-group">
                    <label for="workshop-difficulty">
                        Difficulty *
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Choose the appropriate skill level: Beginner (no prior experience), Intermediate (basic knowledge), or Advanced (expert level)</span>
                        </span>
                    </label>
                    <select id="workshop-difficulty">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="workshop-author">Author</label>
                    <input type="text" id="workshop-author" placeholder="Your Name">
                </div>

                <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="auto-generate-modules" checked style="margin-right: 0.5rem; width: auto; cursor: pointer;">
                        <span style="flex: 1;">
                            Auto-generate module directories
                            <span class="tooltip-wrapper" style="margin-left: 0.25rem;">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Automatically creates individual module directories with navigation when you save the workshop. Uncheck to manually control when modules are generated.</span>
                            </span>
                        </span>
                    </label>
                    <p style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem; color: var(--text-light);">
                        Creates separate README.md files with navigation for each module
                    </p>
                </div>

                <button class="btn btn-primary" style="width: 100%;" onclick="saveWorkshop()">
                    üíæ Save Workshop
                    <span class="tooltip-wrapper">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Saves your workshop to browser storage. You can load it later from the same browser.</span>
                    </span>
                </button>

                <button class="btn btn-outline" style="width: 100%; margin-top: 0.5rem;" onclick="openWorkshopBrowser()">
                    üìÇ Load Existing Workshop
                    <span class="tooltip-wrapper">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Load a previously saved workshop from browser storage to continue editing.</span>
                    </span>
                </button>
            </div>

            <!-- Main Content: Tabs -->
            <div class="main-content">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('modules')">üìö Modules</button>
                    <button class="tab" onclick="switchTab('navigation')">üß≠ Navigation</button>
                    <button class="tab" onclick="switchTab('preview')">üëÅÔ∏è Preview</button>
                    <button class="tab" onclick="switchTab('module-manager')">üîó Module Manager</button>
                </div>

                <!-- Modules Tab -->
                <div id="modules-tab" class="tab-content active">
                    <div class="workshop-summary">
                        <h3>üìä Workshop Summary</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-value" id="modules-count">0</div>
                                <div class="summary-label">Modules</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="total-duration">0</div>
                                <div class="summary-label">Total Minutes</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="canonical-count">0</div>
                                <div class="summary-label">Canonical</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="customized-count">0</div>
                                <div class="summary-label">Customized</div>
                            </div>
                        </div>
                    </div>

                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="openModuleBrowser()">
                            ‚ûï Add Module
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="clearAllModules()">
                            üóëÔ∏è Clear All
                        </button>
                    </div>

                    <div id="modules-list" class="module-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <h3>No Modules Yet</h3>
                            <p>Click "Add Module" to start building your workshop</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation Tab -->
                <div id="navigation-tab" class="tab-content">
                    <div class="alert alert-success">
                        <strong>‚úÖ Auto-Generation Enabled</strong><br>
                        Module directories with navigation are automatically created when you save the workshop.
                        Each module gets its own folder with protected navigation sections.
                    </div>
                    
                    <div class="alert alert-info" style="margin-top: 15px;">
                        <strong>üìÅ Module Structure</strong><br>
                        Each module directory contains a README.md with:
                        <ul style="margin: 10px 0 0 20px; padding: 0;">
                            <li><strong>Protected Navigation Header:</strong> Breadcrumb, progress bar, workshop title</li>
                            <li><strong>Editable Content Section:</strong> Your module content (between markers)</li>
                            <li><strong>Protected Navigation Footer:</strong> Previous/Home/Next navigation buttons</li>
                        </ul>
                        Protected sections use <code>&lt;!-- ‚ö†Ô∏è DO NOT EDIT --&gt;</code> markers.
                    </div>
                    
                    <div style="margin-top: 20px; padding: 20px; background: var(--bg-light); border-radius: 8px; border: 1px solid var(--border-color);">
                        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üîß</span>
                            <span>Manual Regeneration</span>
                        </h3>
                        <p style="color: var(--text-light); margin-bottom: 1rem;">
                            Need to manually regenerate all module directories? Use this if you've reordered modules 
                            or want to update navigation without saving.
                        </p>
                        <button class="btn btn-secondary" onclick="generateModuleStructure()" style="padding: 10px 24px;">
                            ÔøΩ Regenerate Module Directories
                        </button>
                        <p style="margin-top: 0.75rem; font-size: 0.875rem; color: var(--text-light);">
                            This will recreate all module folders with updated navigation
                        </p>
                    </div>
                    
                    <div id="navigation-preview" style="margin-top: 30px;">
                        <div class="empty-state">
                            <div class="empty-state-icon">üß≠</div>
                            <h3>No Navigation Yet</h3>
                            <p>Add modules to see the navigation structure</p>
                        </div>
                    </div>
                </div>

                <!-- Preview Tab -->
                <div id="preview-tab" class="tab-content">
                    <div class="alert alert-info">
                        <strong>üëÅÔ∏è Workshop Preview</strong><br>
                        See how your workshop will look when built.
                    </div>
                    <div id="workshop-preview">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÑ</div>
                            <h3>Complete Workshop Details</h3>
                            <p>Fill in the workshop details and add modules to see the preview</p>
                        </div>
                    </div>
                </div>

                <!-- Module Manager Tab -->
                <div id="module-manager-tab" class="tab-content">
                    <div class="alert alert-info">
                        <strong>üîó Module Manager</strong><br>
                        Discover, browse, and link modules across all workshops. Create parent-child relationships to enable module reusability.
                    </div>

                    <div class="tabs" style="margin-top: 1rem; border-bottom: 2px solid var(--border-color);">
                        <button class="tab active" onclick="switchModuleManagerTab('all')">üìö All Modules</button>
                        <button class="tab" onclick="switchModuleManagerTab('roots')">üå≥ Root Modules</button>
                        <button class="tab" onclick="switchModuleManagerTab('duplicates')">üîç Find Duplicates</button>
                        <button class="tab" onclick="switchModuleManagerTab('link')">üîó Link Modules</button>
                    </div>

                    <!-- All Modules Sub-Tab -->
                    <div id="mm-all-tab" class="tab-content active" style="margin-top: 1rem;">
                        <div class="action-bar" style="margin-bottom: 1rem;">
                            <button class="btn btn-primary btn-sm" onclick="loadAllModules()">
                                üîÑ Refresh Modules
                            </button>
                            <div style="flex: 1;"></div>
                            <input type="text" id="all-modules-search" placeholder="Search modules..." style="max-width: 300px;" oninput="filterAllModules()">
                        </div>

                        <div class="workshop-summary">
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <div class="summary-value" id="mm-total-count">-</div>
                                    <div class="summary-label">Total Modules</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value" id="mm-root-count">-</div>
                                    <div class="summary-label">Root Modules</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value" id="mm-child-count">-</div>
                                    <div class="summary-label">Child Modules</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value" id="mm-standalone-count">-</div>
                                    <div class="summary-label">Standalone</div>
                                </div>
                            </div>
                        </div>

                        <div id="all-modules-list" style="margin-top: 1rem;">
                            <div class="empty-state">
                                <div class="empty-state-icon">üì¶</div>
                                <h3>No Modules Loaded</h3>
                                <p>Click "Refresh Modules" to discover modules across all workshops</p>
                            </div>
                        </div>
                    </div>

                    <!-- Root Modules Sub-Tab -->
                    <div id="mm-roots-tab" class="tab-content" style="margin-top: 1rem;">
                        <div class="alert alert-success">
                            <strong>üå≥ Root Modules</strong><br>
                            These modules are parents that can be reused in other workshops. They track all child modules that link to them.
                        </div>

                        <div id="root-modules-list" style="margin-top: 1rem;">
                            <div class="empty-state">
                                <div class="empty-state-icon">üå≥</div>
                                <h3>No Root Modules Yet</h3>
                                <p>Root modules are created when you link modules together</p>
                            </div>
                        </div>
                    </div>

                    <!-- Find Duplicates Sub-Tab -->
                    <div id="mm-duplicates-tab" class="tab-content" style="margin-top: 1rem;">
                        <div class="alert alert-warning">
                            <strong>üîç Find Duplicates</strong><br>
                            Discover modules with similar names across workshops. Link them to establish parent-child relationships.
                        </div>

                        <div class="action-bar" style="margin-bottom: 1rem;">
                            <button class="btn btn-primary btn-sm" onclick="findDuplicateModules()">
                                üîç Scan for Duplicates
                            </button>
                        </div>

                        <div id="duplicates-list" style="margin-top: 1rem;">
                            <div class="empty-state">
                                <div class="empty-state-icon">üîç</div>
                                <h3>Click "Scan for Duplicates"</h3>
                                <p>We'll search for modules with similar names across all workshops</p>
                            </div>
                        </div>
                    </div>

                    <!-- Link Modules Sub-Tab -->
                    <div id="mm-link-tab" class="tab-content" style="margin-top: 1rem;">
                        <div class="alert alert-info">
                            <strong>üîó Link Modules</strong><br>
                            Create parent-child relationships between modules. The child module will reference the parent.
                        </div>

                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="link-child-module">Child Module (will link TO parent) *</label>
                            <select id="link-child-module" style="width: 100%;">
                                <option value="">Select a module to make a child...</option>
                            </select>
                            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-light);">
                                This module will reference the parent module
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="link-parent-module">Parent Module (will be referenced) *</label>
                            <select id="link-parent-module" style="width: 100%;">
                                <option value="">Select a parent module...</option>
                            </select>
                            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-light);">
                                This module will be marked as root and tracked
                            </p>
                        </div>

                        <div class="action-bar">
                            <button class="btn btn-primary" onclick="linkModules()" id="link-modules-btn" disabled>
                                üîó Link Modules
                            </button>
                            <button class="btn btn-outline" onclick="resetLinkForm()">
                                üîÑ Reset
                            </button>
                        </div>

                        <div id="link-result" style="margin-top: 1rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Module Browser Modal -->
    <div id="module-browser-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìö Add Module</h2>
                <button class="modal-close" onclick="closeModuleBrowser()">‚úï</button>
            </div>

            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button class="btn btn-primary" onclick="showCreateCustomModule()">‚ûï Create Custom Module</button>
                <div style="flex: 1;"></div>
            </div>

            <div class="form-group">
                <label for="module-search">Search Modules</label>
                <input type="text" id="module-search" placeholder="Search by name or tags..." oninput="filterModules()">
            </div>

            <div class="form-group">
                <label>Filter by Type</label>
                <select id="module-type-filter" onchange="filterModules()">
                    <option value="all">All Modules</option>
                    <option value="canonical">Canonical Only</option>
                    <option value="customized">Customized Only</option>
                </select>
            </div>

            <div class="module-browser" id="module-browser-list">
                <!-- Modules will be populated here -->
            </div>
        </div>
    </div>

    <!-- Create Custom Module Modal -->
    <div id="custom-module-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Create Custom Module</h2>
                <button class="modal-close" onclick="closeCustomModule()">‚úï</button>
            </div>

            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <strong>‚ÑπÔ∏è Custom Module</strong><br>
                Create a standalone module that doesn't reference an existing module in the repository.
            </div>

            <div class="form-group">
                <label for="custom-module-name">Module Name *</label>
                <input type="text" id="custom-module-name" placeholder="e.g., Advanced Redis Patterns" required>
            </div>

            <div class="form-group">
                <label for="custom-module-description">Description *</label>
                <textarea id="custom-module-description" rows="3" placeholder="Describe what students will learn in this module..." required></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="custom-module-duration">Duration (minutes) *</label>
                    <input type="number" id="custom-module-duration" value="30" min="5" max="300" required>
                </div>

                <div class="form-group">
                    <label for="custom-module-difficulty">Difficulty *</label>
                    <select id="custom-module-difficulty" required>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="custom-module-type">Type *</label>
                    <select id="custom-module-type" required>
                        <option value="lecture">Lecture</option>
                        <option value="hands-on" selected>Hands-on</option>
                        <option value="demo">Demo</option>
                        <option value="lab">Lab</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="custom-module-ref">Module Reference (optional)</label>
                <input type="text" id="custom-module-ref" placeholder="e.g., custom/advanced-patterns">
                <small style="color: var(--text-light);">Optional: A reference ID for this module</small>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeCustomModule()">Cancel</button>
                <button class="btn btn-primary" onclick="createCustomModule()">Create Module</button>
            </div>
        </div>
    </div>

    <!-- Edit Module Modal -->
    <div id="edit-module-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Module</h2>
                <button class="modal-close" onclick="closeEditModule()">‚úï</button>
            </div>

            <div class="alert alert-warning" style="margin-bottom: 1rem;">
                <strong>‚ö†Ô∏è Edit Module Settings</strong><br>
                Changes will be saved when you click "Save Changes" and then save the workshop.
            </div>

            <div class="form-group">
                <label for="edit-module-name">Module Name *</label>
                <input type="text" id="edit-module-name" placeholder="e.g., Advanced Redis Patterns" required>
            </div>

            <div class="form-group">
                <label for="edit-module-description">Description *</label>
                <textarea id="edit-module-description" rows="3" placeholder="Describe what students will learn in this module..." required></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="edit-module-duration">Duration (minutes) *</label>
                    <input type="number" id="edit-module-duration" value="30" min="5" max="300" required>
                </div>

                <div class="form-group">
                    <label for="edit-module-difficulty">Difficulty *</label>
                    <select id="edit-module-difficulty" required>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-module-type">Type *</label>
                    <select id="edit-module-type" required>
                        <option value="lecture">Lecture</option>
                        <option value="hands-on">Hands-on</option>
                        <option value="demo">Demo</option>
                        <option value="lab">Lab</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="edit-module-required" checked style="width: auto; margin-right: 0.5rem;">
                    Required Module
                </label>
                <small style="display: block; color: var(--text-light); margin-top: 0.25rem;">
                    Uncheck if this module is optional for learners
                </small>
            </div>

            <div class="form-group">
                <label for="edit-module-ref">Module Reference</label>
                <input type="text" id="edit-module-ref" placeholder="e.g., modules/redis-basics" readonly style="background: var(--bg-light);">
                <small style="color: var(--text-light);">Reference path (read-only)</small>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="closeEditModule()">Cancel</button>
                <button class="btn btn-primary" onclick="saveModuleEdits()">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Workshop Browser Modal -->
    <div id="workshop-browser-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÇ Load Workshop</h2>
                <button class="modal-close" onclick="closeWorkshopBrowser()">‚úï</button>
            </div>

            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <strong>‚ÑπÔ∏è Saved Workshops</strong><br>
                Select a workshop from your browser storage to continue editing.
            </div>

            <div class="form-group">
                <label for="workshop-search">Search Workshops</label>
                <input type="text" id="workshop-search" placeholder="Search by ID or title..." oninput="filterWorkshops()">
            </div>

            <div class="workshop-browser" id="workshop-browser-list">
                <!-- Workshops will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // API Client Configuration
        // ========================================================================
        
        const API_CONFIG = {
            baseURL: 'http://localhost:3000/api',
            timeout: 10000
        };

        // Current Git branch
        let currentBranch = '';
        let useFilesystem = false; // Flag to determine if using filesystem backend

        // ========================================================================
        // API Client Functions
        // ========================================================================

        /**
         * Make API request
         */
        async function apiRequest(endpoint, options = {}) {
            try {
                const url = `${API_CONFIG.baseURL}${endpoint}`;
                const config = {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                };

                const response = await fetch(url, config);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `API request failed: ${response.status}`);
                }

                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        /**
         * Check if server is available
         */
        async function checkServerAvailability() {
            try {
                await apiRequest('/health');
                return true;
            } catch (error) {
                return false;
            }
        }

        /**
         * Show notification message
         */
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '10000';
            notification.style.minWidth = '300px';
            notification.style.maxWidth = '500px';
            notification.style.animation = 'slideIn 0.3s ease-out';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        /**
         * Initialize Git (create branch if on main)
         */
        async function initGit() {
            try {
                const result = await apiRequest('/git/init');
                currentBranch = result.branch;
                updateBranchDisplay(result.branch, result.created);
                return result;
            } catch (error) {
                console.error('Failed to initialize Git:', error);
                throw error;
            }
        }

        /**
         * Load workshops from filesystem
         */
        async function loadWorkshopsFromFilesystem() {
            try {
                const result = await apiRequest('/workshops');
                return result.workshops;
            } catch (error) {
                console.error('Failed to load workshops:', error);
                throw error;
            }
        }

        /**
         * Load specific workshop from filesystem
         */
        async function loadWorkshopFromFilesystem(workshopId) {
            try {
                const result = await apiRequest(`/workshops/${workshopId}`);
                return result.workshop;
            } catch (error) {
                console.error(`Failed to load workshop ${workshopId}:`, error);
                throw error;
            }
        }

        /**
         * Save workshop to filesystem
         */
        async function saveWorkshopToFilesystem(workshopId, workshopData) {
            try {
                const endpoint = `/workshops/${workshopId}`;
                const result = await apiRequest(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(workshopData)
                });
                return result.workshop;
            } catch (error) {
                console.error('Failed to save workshop:', error);
                throw error;
            }
        }

        /**
         * Create new workshop in filesystem
         */
        async function createWorkshopInFilesystem(workshopData) {
            try {
                const result = await apiRequest('/workshops', {
                    method: 'POST',
                    body: JSON.stringify(workshopData)
                });
                return result.workshop;
            } catch (error) {
                console.error('Failed to create workshop:', error);
                throw error;
            }
        }

        /**
         * Commit changes
         */
        async function commitChanges(files, message) {
            try {
                const result = await apiRequest('/git/commit', {
                    method: 'POST',
                    body: JSON.stringify({ files, message })
                });
                return result;
            } catch (error) {
                console.error('Failed to commit changes:', error);
                throw error;
            }
        }

        /**
         * Generate module directories with navigation
         */
        async function generateModuleStructure() {
            // Check if workshop is loaded and has modules
            if (!workshop.workshopId) {
                showNotification('‚ö†Ô∏è Please load or create a workshop first', 'error');
                return;
            }
            
            if (!workshop.modules || workshop.modules.length === 0) {
                showNotification('‚ö†Ô∏è Please add modules to the workshop first', 'error');
                return;
            }
            
            // Confirm action
            const confirmed = confirm(
                `This will create ${workshop.modules.length} module directories with protected navigation headers and footers.\n\n` +
                `Each module will have:\n` +
                `‚Ä¢ Auto-generated navigation header (DO NOT EDIT)\n` +
                `‚Ä¢ Editable content section\n` +
                `‚Ä¢ Auto-generated navigation footer (DO NOT EDIT)\n\n` +
                `Continue?`
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                showNotification('üóÇÔ∏è Generating module directories...', 'info');
                
                // Call API to generate modules
                const result = await apiRequest(`/workshops/${workshop.workshopId}/generate-modules`, {
                    method: 'POST'
                });
                
                if (result.success) {
                    showNotification(
                        `‚úÖ Successfully created ${result.modules.length} module directories with navigation!`,
                        'success'
                    );
                    
                    // Ask if user wants to commit
                    const shouldCommit = confirm('Module structure created! Do you want to commit these changes to Git?');
                    if (shouldCommit) {
                        const commitMessage = prompt(
                            'Enter commit message:',
                            `Add module structure with navigation for ${workshop.title}`
                        );
                        if (commitMessage) {
                            // Prepare list of files to commit
                            const filesToCommit = [
                                `workshops/${workshop.workshopId}/README.md`
                            ];
                            
                            // Add each module's README
                            result.modules.forEach(module => {
                                filesToCommit.push(`workshops/${workshop.workshopId}/${module.folderName}/README.md`);
                            });
                            
                            await commitChanges(filesToCommit, commitMessage);
                            showNotification('‚úÖ Module structure created and committed!', 'success');
                        } else {
                            showNotification('‚úÖ Module structure created (not committed)', 'success');
                        }
                    } else {
                        showNotification('‚úÖ Module structure created (not committed)', 'success');
                    }
                    
                    // Show details
                    console.log('Created modules:', result.modules);
                    
                    // Update navigation preview
                    renderNavigation();
                } else {
                    showNotification(`‚ùå Failed to generate modules: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Generate modules error:', error);
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        /**
         * Update branch display in header
         */
        function updateBranchDisplay(branch, wasCreated = false) {
            const header = document.getElementById('header-subtitle');
            if (wasCreated) {
                header.innerHTML = `
                    <span style="display: inline-block; background: var(--success-color); color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; margin-right: 0.5rem;">
                        üåø Branch: <strong>${branch}</strong> (newly created)
                    </span>
                    <span style="color: var(--text-light);">Changes will be saved to your local filesystem</span>
                `;
            } else {
                header.innerHTML = `
                    <span style="display: inline-block; background: var(--info-color); color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; margin-right: 0.5rem;">
                        üåø Branch: <strong>${branch}</strong>
                    </span>
                    <span style="color: var(--text-light);">Changes will be saved to your local filesystem</span>
                `;
            }
            
            // Check GitHub PR status
            checkGitHubStatus();
        }

        /**
         * Check GitHub status and show/hide PR button
         */
        async function checkGitHubStatus() {
            try {
                const status = await apiRequest('/github/status');
                
                if (status.configured && status.currentBranch && 
                    status.currentBranch !== 'main' && status.currentBranch !== 'master') {
                    // Show PR button
                    const prSection = document.getElementById('github-pr-section');
                    prSection.style.display = 'block';
                    
                    // Update button based on existing PR
                    const buttonText = document.getElementById('pr-button-text');
                    const prStatus = document.getElementById('pr-status');
                    
                    if (status.existingPR) {
                        buttonText.textContent = 'üìã View Pull Request';
                        prStatus.innerHTML = `<a href="${status.existingPR.url}" target="_blank" style="color: var(--success-color);">PR #${status.existingPR.number} exists</a>`;
                    } else {
                        buttonText.textContent = 'üöÄ Create Pull Request';
                        prStatus.textContent = '';
                    }
                }
            } catch (error) {
                console.log('GitHub not configured or error:', error.message);
                // Hide PR button if GitHub is not configured
                document.getElementById('github-pr-section').style.display = 'none';
            }
        }

        /**
         * Create or view Pull Request
         */
        async function createPullRequest() {
            try {
                // Check status first
                const status = await apiRequest('/github/status');
                
                // If PR already exists, open it
                if (status.existingPR) {
                    window.open(status.existingPR.url, '_blank');
                    return;
                }
                
                // Get PR details from user
                const title = prompt('Enter Pull Request title:', `Workshop updates from ${status.currentBranch}`);
                if (!title) {
                    return; // User cancelled
                }
                
                const body = prompt('Enter PR description (optional):', 
                    'This PR contains workshop updates made through the Workshop Builder GUI.');
                
                showNotification('üöÄ Creating Pull Request...', 'info');
                
                // Create PR
                const result = await apiRequest('/github/pull-request', {
                    method: 'POST',
                    body: JSON.stringify({
                        title,
                        body: body || undefined
                    })
                });
                
                if (result.success) {
                    if (result.exists) {
                        showNotification(`‚úÖ Pull Request already exists: PR #${result.number}`, 'success');
                    } else {
                        showNotification(`‚úÖ Pull Request created: PR #${result.number}`, 'success');
                    }
                    
                    // Update button to show "View PR"
                    await checkGitHubStatus();
                    
                    // Open PR in browser
                    if (confirm('Would you like to open the Pull Request in your browser?')) {
                        window.open(result.url, '_blank');
                    }
                } else {
                    showNotification(`‚ùå Failed to create PR: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Create PR error:', error);
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // ========================================================================
        // Workshop State
        // ========================================================================
        
        let workshop = {
            workshopId: '',
            version: '1.0.0',
            title: '',
            description: '',
            duration: '',
            difficulty: 'intermediate',
            author: '',
            modules: [],
            prerequisites: [],
            learningObjectives: []
        };

        // Available modules (in a real app, this would be fetched from the server)
        const availableModules = [
            {
                moduleRef: 'core.redis-fundamentals.v1',
                name: 'Redis Fundamentals',
                description: 'Introduction to Redis core concepts and data structures',
                duration: 60,
                difficulty: 'beginner',
                type: 'canonical',
                tags: ['fundamentals', 'basics', 'data-structures']
            },
            {
                moduleRef: 'core.redis-security.v1',
                name: 'Redis Security',
                description: 'Securing Redis deployments with authentication and encryption',
                duration: 45,
                difficulty: 'intermediate',
                type: 'canonical',
                tags: ['security', 'authentication', 'encryption']
            },
            {
                moduleRef: 'core.redis-performance.v1',
                name: 'Redis Performance',
                description: 'Optimizing Redis for high performance applications',
                duration: 90,
                difficulty: 'advanced',
                type: 'canonical',
                tags: ['performance', 'optimization', 'tuning']
            },
            {
                moduleRef: 'core.redis-clustering.v1',
                name: 'Redis Clustering',
                description: 'Setting up and managing Redis clusters',
                duration: 75,
                difficulty: 'advanced',
                type: 'canonical',
                tags: ['clustering', 'scalability', 'high-availability']
            },
            {
                moduleRef: 'core.redis-streams.v1',
                name: 'Redis Streams',
                description: 'Working with Redis Streams for event processing',
                duration: 60,
                difficulty: 'intermediate',
                type: 'canonical',
                tags: ['streams', 'messaging', 'events']
            },
            {
                moduleRef: 'core.redis-json.v1',
                name: 'RedisJSON',
                description: 'Using Redis as a JSON document store',
                duration: 45,
                difficulty: 'beginner',
                type: 'canonical',
                tags: ['json', 'documents', 'data-structures']
            }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if server is available
            const serverAvailable = await checkServerAvailability();
            
            if (serverAvailable) {
                useFilesystem = true;
                console.log('‚úÖ Server available - using filesystem mode');
                
                try {
                    // Initialize Git
                    const gitResult = await initGit();
                    console.log('Git initialized:', gitResult);
                    
                    // Show success notification
                    showNotification(
                        gitResult.created 
                            ? `Created new branch: ${gitResult.branch}` 
                            : `Working on branch: ${gitResult.branch}`,
                        'success'
                    );
                } catch (error) {
                    console.error('Git initialization failed:', error);
                    showNotification('Warning: Git initialization failed. Changes won\'t be committed automatically.', 'warning');
                    useFilesystem = false;
                }
            } else {
                useFilesystem = false;
                console.log('‚ÑπÔ∏è Server not available - using localStorage mode');
                showNotification('Server not available. Working in browser-only mode. Start server for filesystem integration.', 'info');
            }
            
            updateSummary();
            renderModules();
        });

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Update specific tab content
            if (tabName === 'navigation') {
                renderNavigation();
            } else if (tabName === 'preview') {
                renderPreview();
            } else if (tabName === 'module-manager') {
                // Load all modules when opening Module Manager tab
                loadAllModules();
            }
        }

        // ========================================================================
        // Module Manager Functions
        // ========================================================================

        let allModulesData = [];
        let rootModulesData = [];

        // Switch between Module Manager sub-tabs
        function switchModuleManagerTab(tabName) {
            // Update tab buttons within module manager
            const mmTabs = document.querySelectorAll('#module-manager-tab .tabs .tab');
            mmTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update sub-tab content
            const subTabs = ['mm-all-tab', 'mm-roots-tab', 'mm-duplicates-tab', 'mm-link-tab'];
            subTabs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });
            document.getElementById(`mm-${tabName}-tab`).classList.add('active');

            // Load data for specific tabs
            if (tabName === 'roots') {
                loadRootModules();
            } else if (tabName === 'link') {
                populateLinkSelects();
            }
        }

        // Load all modules from API
        async function loadAllModules() {
            try {
                showNotification('Loading modules...', 'info');
                
                const response = await fetch('http://localhost:3000/api/modules/all');
                const data = await response.json();
                
                if (data.success) {
                    allModulesData = data.modules;
                    renderAllModules(allModulesData);
                    updateModuleManagerStats(allModulesData);
                    showNotification(`Loaded ${data.count} modules`, 'success');
                } else {
                    throw new Error(data.error || 'Failed to load modules');
                }
            } catch (error) {
                console.error('Error loading modules:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Render all modules list
        function renderAllModules(modules) {
            const container = document.getElementById('all-modules-list');
            
            if (!modules || modules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No Modules Found</h3>
                        <p>No modules discovered in any workshop</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
            
            modules.forEach(module => {
                const inheritanceIcon = module.inheritance?.isRoot ? 'üå≥' : 
                                       (module.inheritance?.parentPath ? 'üîó' : '‚≠ê');
                const inheritanceLabel = module.inheritance?.isRoot ? 'Root' : 
                                        (module.inheritance?.parentPath ? 'Child' : 'Standalone');
                const inheritanceColor = module.inheritance?.isRoot ? 'var(--success-color)' : 
                                        (module.inheritance?.parentPath ? 'var(--info-color)' : 'var(--text-light)');
                
                html += `
                    <div class="module-card" style="border-left: 4px solid ${inheritanceColor};">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">${inheritanceIcon}</span>
                                    <strong style="font-size: 1.1rem;">${module.title}</strong>
                                    <span class="badge" style="background: ${inheritanceColor}; color: white;">
                                        ${inheritanceLabel}
                                    </span>
                                </div>
                                <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    üìÅ ${module.workshopId} / ${module.moduleDir}
                                </div>
                                ${module.description ? `<p style="margin: 0.5rem 0; color: var(--text-color);">${module.description}</p>` : ''}
                                ${module.duration ? `<p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">‚è±Ô∏è ${module.duration}</p>` : ''}
                                ${module.inheritance?.parentPath ? `
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-light); border-radius: 4px; font-size: 0.875rem;">
                                        üîó Parent: <code>${module.inheritance.parentPath}</code>
                                    </div>
                                ` : ''}
                                ${module.inheritance?.usedBy?.length > 0 ? `
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-light); border-radius: 4px; font-size: 0.875rem;">
                                        üë∂ Used by ${module.inheritance.usedBy.length} module(s)
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${!module.inheritance?.isRoot && !module.inheritance?.parentPath ? `
                                    <button class="btn btn-sm btn-primary" onclick="promoteModuleToRoot('${module.modulePath}')" title="Make this module a root/parent">
                                        üå≥ Make Root
                                    </button>
                                ` : ''}
                                ${module.inheritance?.parentPath ? `
                                    <button class="btn btn-sm btn-outline" onclick="promoteModuleToRoot('${module.modulePath}')" title="Make this module independent">
                                        ‚≠ê Make Independent
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Update Module Manager statistics
        function updateModuleManagerStats(modules) {
            const total = modules.length;
            const roots = modules.filter(m => m.inheritance?.isRoot).length;
            const children = modules.filter(m => m.inheritance?.parentPath).length;
            const standalone = total - roots - children;
            
            document.getElementById('mm-total-count').textContent = total;
            document.getElementById('mm-root-count').textContent = roots;
            document.getElementById('mm-child-count').textContent = children;
            document.getElementById('mm-standalone-count').textContent = standalone;
        }

        // Filter all modules
        function filterAllModules() {
            const searchTerm = document.getElementById('all-modules-search').value.toLowerCase();
            const filtered = allModulesData.filter(module => 
                module.title.toLowerCase().includes(searchTerm) ||
                module.moduleDir.toLowerCase().includes(searchTerm) ||
                module.workshopId.toLowerCase().includes(searchTerm) ||
                (module.description && module.description.toLowerCase().includes(searchTerm))
            );
            renderAllModules(filtered);
        }

        // Load root modules
        async function loadRootModules() {
            try {
                showNotification('Loading root modules...', 'info');
                
                const response = await fetch('http://localhost:3000/api/modules/roots');
                const data = await response.json();
                
                if (data.success) {
                    rootModulesData = data.modules;
                    renderRootModules(rootModulesData);
                    showNotification(`Found ${data.count} root modules`, 'success');
                } else {
                    throw new Error(data.error || 'Failed to load root modules');
                }
            } catch (error) {
                console.error('Error loading root modules:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Render root modules
        function renderRootModules(modules) {
            const container = document.getElementById('root-modules-list');
            
            if (!modules || modules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üå≥</div>
                        <h3>No Root Modules Yet</h3>
                        <p>Root modules are created when you link modules together</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
            
            modules.forEach(module => {
                const childCount = module.inheritance?.usedBy?.length || 0;
                
                html += `
                    <div class="module-card" style="border-left: 4px solid var(--success-color);">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">üå≥</span>
                                    <strong style="font-size: 1.1rem;">${module.title}</strong>
                                    <span class="badge" style="background: var(--success-color); color: white;">
                                        Root Module
                                    </span>
                                </div>
                                <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    üìÅ ${module.workshopId} / ${module.moduleDir}
                                </div>
                                ${module.description ? `<p style="margin: 0.5rem 0;">${module.description}</p>` : ''}
                                ${childCount > 0 ? `
                                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 4px;">
                                        <strong>üë∂ Used by ${childCount} module(s):</strong>
                                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                            ${module.inheritance.usedBy.map(child => `
                                                <li style="margin: 0.25rem 0;">
                                                    <code>${child.workshop}</code> ‚Üí <code>${child.modulePath}</code>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : `
                                    <div style="margin-top: 1rem; padding: 0.5rem; background: var(--bg-light); border-radius: 4px; color: var(--text-light);">
                                        No child modules yet
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Find duplicate modules
        async function findDuplicateModules() {
            try {
                showNotification('Scanning for duplicates...', 'info');
                
                const response = await fetch('http://localhost:3000/api/modules/similar');
                const data = await response.json();
                
                if (data.success) {
                    renderDuplicates(data.groups);
                    showNotification(`Found ${data.count} duplicate group(s)`, data.count > 0 ? 'warning' : 'success');
                } else {
                    throw new Error(data.error || 'Failed to find duplicates');
                }
            } catch (error) {
                console.error('Error finding duplicates:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Render duplicate groups
        function renderDuplicates(groups) {
            const container = document.getElementById('duplicates-list');
            
            if (!groups || groups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <h3>No Duplicates Found</h3>
                        <p>All modules have unique names</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 1.5rem;">';
            
            groups.forEach(group => {
                const hasRoot = group.modules.some(m => m.inheritance?.isRoot);
                const rootModule = hasRoot ? group.modules.find(m => m.inheritance?.isRoot) : group.modules[0];
                
                html += `
                    <div class="module-card" style="border-left: 4px solid var(--warning-color); background: #fff9f0;">
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">üîç</span>
                                <strong style="font-size: 1.1rem;">Duplicate Group: "${group.name}"</strong>
                                <span class="badge" style="background: var(--warning-color); color: white;">
                                    ${group.count} modules
                                </span>
                            </div>
                            ${hasRoot ? `
                                <div style="padding: 0.5rem; background: var(--success-color); color: white; border-radius: 4px; font-size: 0.875rem;">
                                    ‚úÖ Already has a root module
                                </div>
                            ` : `
                                <div style="padding: 0.5rem; background: var(--warning-color); color: white; border-radius: 4px; font-size: 0.875rem;">
                                    ‚ö†Ô∏è No root module - consider linking these together
                                </div>
                            `}
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            ${group.modules.map((module, index) => `
                                <div style="padding: 0.75rem; background: white; border: 1px solid var(--border-color); border-radius: 4px;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        ${module.inheritance?.isRoot ? 'üå≥' : (module.inheritance?.parentPath ? 'üîó' : '‚≠ê')}
                                        <strong>${module.workshopId}</strong> / <code>${module.moduleDir}</code>
                                        ${index === 0 && !hasRoot ? '<span class="badge" style="background: var(--info-color); color: white; font-size: 0.75rem;">Suggested Parent</span>' : ''}
                                        ${module.inheritance?.isRoot ? '<span class="badge" style="background: var(--success-color); color: white; font-size: 0.75rem;">Root</span>' : ''}
                                        ${module.inheritance?.parentPath ? '<span class="badge" style="background: var(--info-color); color: white; font-size: 0.75rem;">Linked</span>' : ''}
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--text-light);">
                                        ${module.title}
                                    </div>
                                    ${!module.inheritance?.parentPath && !module.inheritance?.isRoot && index > 0 ? `
                                        <button class="btn btn-sm btn-primary" style="margin-top: 0.5rem;" 
                                                onclick="quickLinkToRoot('${module.modulePath}', '${rootModule.modulePath}')">
                                            üîó Link to ${rootModule.workshopId}
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Populate link module selects
        function populateLinkSelects() {
            const childSelect = document.getElementById('link-child-module');
            const parentSelect = document.getElementById('link-parent-module');
            
            // Clear existing options
            childSelect.innerHTML = '<option value="">Select a module to make a child...</option>';
            parentSelect.innerHTML = '<option value="">Select a parent module...</option>';
            
            // Populate with modules (exclude already linked children from parent options)
            allModulesData.forEach(module => {
                const option = new Option(
                    `${module.workshopId} / ${module.moduleDir}`,
                    module.modulePath
                );
                childSelect.add(option.cloneNode(true));
                
                // Only add to parent if it's not a child
                if (!module.inheritance?.parentPath) {
                    parentSelect.add(option.cloneNode(true));
                }
            });
            
            // Enable/disable link button based on selection
            childSelect.onchange = parentSelect.onchange = () => {
                const btn = document.getElementById('link-modules-btn');
                btn.disabled = !childSelect.value || !parentSelect.value || childSelect.value === parentSelect.value;
            };
        }

        // Link modules
        async function linkModules() {
            const childPath = document.getElementById('link-child-module').value;
            const parentPath = document.getElementById('link-parent-module').value;
            
            if (!childPath || !parentPath) {
                showNotification('Please select both child and parent modules', 'error');
                return;
            }
            
            if (childPath === parentPath) {
                showNotification('Cannot link a module to itself', 'error');
                return;
            }
            
            try {
                showNotification('Linking modules...', 'info');
                
                const response = await fetch('http://localhost:3000/api/modules/link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ childPath, parentPath })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('‚úÖ Modules linked successfully!', 'success');
                    document.getElementById('link-result').innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ Success!</strong><br>
                            Child: <code>${childPath}</code><br>
                            Parent: <code>${parentPath}</code><br>
                            The modules are now linked. The child references the parent.
                        </div>
                    `;
                    resetLinkForm();
                    // Reload all modules to refresh the data
                    loadAllModules();
                } else {
                    throw new Error(data.error || 'Failed to link modules');
                }
            } catch (error) {
                console.error('Error linking modules:', error);
                showNotification(`Error: ${error.message}`, 'error');
                document.getElementById('link-result').innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Quick link from duplicate finder
        async function quickLinkToRoot(childPath, parentPath) {
            if (confirm(`Link ${childPath} to ${parentPath}?`)) {
                try {
                    showNotification('Linking modules...', 'info');
                    
                    const response = await fetch('http://localhost:3000/api/modules/link', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ childPath, parentPath })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('‚úÖ Modules linked successfully!', 'success');
                        // Refresh duplicates view
                        findDuplicateModules();
                        // Reload all modules
                        loadAllModules();
                    } else {
                        throw new Error(data.error || 'Failed to link modules');
                    }
                } catch (error) {
                    console.error('Error linking modules:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                }
            }
        }

        // Promote module to root
        async function promoteModuleToRoot(modulePath) {
            if (confirm(`Promote ${modulePath} to root/independent module?`)) {
                try {
                    showNotification('Promoting module...', 'info');
                    
                    const response = await fetch('http://localhost:3000/api/modules/promote', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ modulePath })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('‚úÖ Module promoted successfully!', 'success');
                        // Reload modules
                        loadAllModules();
                    } else {
                        throw new Error(data.error || 'Failed to promote module');
                    }
                } catch (error) {
                    console.error('Error promoting module:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                }
            }
        }

        // Reset link form
        function resetLinkForm() {
            document.getElementById('link-child-module').value = '';
            document.getElementById('link-parent-module').value = '';
            document.getElementById('link-modules-btn').disabled = true;
            document.getElementById('link-result').innerHTML = '';
        }

        // Workshop management
        async function saveWorkshop() {
            workshop.workshopId = document.getElementById('workshop-id').value;
            workshop.title = document.getElementById('workshop-title').value;
            workshop.description = document.getElementById('workshop-description').value;
            workshop.difficulty = document.getElementById('workshop-difficulty').value;
            workshop.author = document.getElementById('workshop-author').value;
            
            // Calculate duration from modules (auto-sync)
            const totalDuration = workshop.modules.reduce((sum, m) => sum + (m.duration || 0), 0);
            workshop.duration = totalDuration;
            document.getElementById('workshop-duration').value = totalDuration;

            if (!workshop.workshopId || !workshop.title || !workshop.description) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }

            // Validate workshop ID format
            const idRegex = /^[a-z0-9-]+$/;
            if (!idRegex.test(workshop.workshopId)) {
                alert('Workshop ID can only contain lowercase letters, numbers, and hyphens');
                return;
            }

            // Update lastUpdated timestamp
            workshop.lastUpdated = new Date().toISOString().split('T')[0];

            if (useFilesystem) {
                // Save to filesystem via API
                try {
                    showNotification('Saving workshop to filesystem...', 'info');
                    
                    const workshopData = {
                        title: workshop.title,
                        description: workshop.description,
                        duration: workshop.duration,
                        difficulty: workshop.difficulty,
                        modules: workshop.modules
                    };
                    
                    await saveWorkshopToFilesystem(workshop.workshopId, workshopData);
                    
                    // Check if auto-generate is enabled
                    const autoGenerate = document.getElementById('auto-generate-modules').checked;
                    let generatedModules = null;
                    let filesToCommit = [`workshops/${workshop.workshopId}/README.md`];
                    
                    // Auto-generate module directories if enabled and there are modules
                    if (autoGenerate && workshop.modules && workshop.modules.length > 0) {
                        try {
                            showNotification('üóÇÔ∏è Auto-generating module directories...', 'info');
                            const result = await apiRequest(`/workshops/${workshop.workshopId}/generate-modules`, {
                                method: 'POST'
                            });
                            
                            if (result.success) {
                                generatedModules = result.modules;
                                showNotification(`‚úÖ Generated ${result.modules.length} module directories!`, 'success');
                                
                                // Add module files to commit list
                                result.modules.forEach(module => {
                                    filesToCommit.push(`workshops/${workshop.workshopId}/${module.folderName}/README.md`);
                                });
                            }
                        } catch (error) {
                            console.error('Auto-generate modules error:', error);
                            showNotification(`‚ö†Ô∏è Module auto-generation failed: ${error.message}`, 'warning');
                        }
                    }
                    
                    // Ask if user wants to commit
                    const commitPrompt = generatedModules 
                        ? `Workshop saved with ${generatedModules.length} module directories! Commit to Git?`
                        : 'Workshop saved! Do you want to commit these changes to Git?';
                    
                    const shouldCommit = confirm(commitPrompt);
                    if (shouldCommit) {
                        const defaultMessage = generatedModules
                            ? `Update ${workshop.title} with ${generatedModules.length} modules`
                            : `Update ${workshop.title}`;
                        const commitMessage = prompt('Enter commit message:', defaultMessage);
                        
                        if (commitMessage) {
                            await commitChanges(filesToCommit, commitMessage);
                            showNotification('‚úÖ Workshop saved and committed!', 'success');
                        } else {
                            showNotification('‚úÖ Workshop saved (not committed)', 'success');
                        }
                    } else {
                        const savedMsg = generatedModules
                            ? `‚úÖ Workshop saved with ${generatedModules.length} modules (not committed)`
                            : '‚úÖ Workshop saved (not committed)';
                        showNotification(savedMsg, 'success');
                    }
                    
                    // Also save to localStorage as backup
                    localStorage.setItem(`workshop-${workshop.workshopId}`, JSON.stringify(workshop));
                } catch (error) {
                    showNotification(`‚ùå Failed to save: ${error.message}`, 'error');
                    console.error('Save error:', error);
                }
            } else {
                // Save to localStorage only
                localStorage.setItem(`workshop-${workshop.workshopId}`, JSON.stringify(workshop));
                showNotification('‚úÖ Workshop saved to browser storage!', 'success');
            }
        }

        async function loadWorkshop(workshopId) {
            if (useFilesystem) {
                // Load from filesystem via API
                try {
                    showNotification('Loading workshop from filesystem...', 'info');
                    const workshopData = await loadWorkshopFromFilesystem(workshopId);
                    
                    console.log('=== LOAD WORKSHOP DEBUG ===');
                    console.log('Full workshopData:', workshopData);
                    console.log('workshopData.modules:', workshopData.modules);
                    console.log('workshopData.frontmatter?.modules:', workshopData.frontmatter?.modules);
                    
                    // Get modules from frontmatter first, fallback to top-level modules
                    const modulesList = workshopData.frontmatter?.modules || workshopData.modules || [];
                    
                    console.log('Selected modulesList:', modulesList);
                    console.log('modulesList.length:', modulesList.length);
                    
                    // Transform modules - handle both object and string formats
                    const transformedModules = modulesList.map((moduleRef, index) => {
                        // If it's already an object with proper structure, use it with minimal additions
                        if (typeof moduleRef === 'object' && moduleRef !== null) {
                            return {
                                order: index + 1,
                                name: moduleRef.name || 'Unnamed Module',
                                description: moduleRef.description || '',
                                duration: moduleRef.duration || 30,
                                difficulty: moduleRef.difficulty || 'intermediate',
                                type: moduleRef.type || 'lecture',
                                moduleRef: moduleRef.moduleRef || moduleRef.name || `module-${index + 1}`,
                                required: moduleRef.required !== undefined ? moduleRef.required : true
                            };
                        }
                        
                        // If it's a string reference, create a full module object
                        const moduleName = moduleRef.split('/').pop() || moduleRef;
                        return {
                            order: index + 1,
                            name: moduleName.replace(/-/g, ' ').replace(/^\d+\s*/, '').trim(),
                            moduleRef: moduleRef,
                            type: 'canonical',
                            difficulty: 'intermediate',
                            duration: 30,
                            description: `Module from ${moduleRef}`,
                            required: true
                        };
                    });
                    
                    console.log('Transformed modules:', transformedModules);
                    console.log('Transformed modules length:', transformedModules.length);
                    
                    // Update workshop object
                    workshop = {
                        workshopId: workshopData.workshopId,
                        version: '1.0.0',
                        title: workshopData.title,
                        description: workshopData.description,
                        duration: workshopData.duration,
                        difficulty: workshopData.difficulty,
                        author: workshopData.frontmatter?.author || '',
                        modules: transformedModules,
                        prerequisites: workshopData.frontmatter?.prerequisites || [],
                        learningObjectives: workshopData.frontmatter?.learningObjectives || [],
                        lastUpdated: new Date().toISOString().split('T')[0]
                    };
                    
                    console.log('Final workshop object:', workshop);
                    console.log('Final workshop.modules:', workshop.modules);
                    console.log('Final workshop.modules.length:', workshop.modules.length);
                    
                    // Update form fields
                    document.getElementById('workshop-id').value = workshop.workshopId;
                    document.getElementById('workshop-title').value = workshop.title;
                    document.getElementById('workshop-description').value = workshop.description;
                    document.getElementById('workshop-duration').value = workshop.duration;
                    document.getElementById('workshop-difficulty').value = workshop.difficulty;
                    document.getElementById('workshop-author').value = workshop.author || '';

                    updateSummary();
                    renderModules();
                    renderNavigation();
                    closeWorkshopBrowser();
                    
                    showNotification('‚úÖ Workshop loaded from filesystem!', 'success');
                } catch (error) {
                    showNotification(`‚ùå Failed to load: ${error.message}`, 'error');
                    console.error('Load error:', error);
                }
            } else {
                // Load from localStorage
                const saved = localStorage.getItem(`workshop-${workshopId}`);
                if (!saved) {
                    alert('Workshop not found in browser storage');
                    return;
                }

                workshop = JSON.parse(saved);
                
                // Update form fields
                document.getElementById('workshop-id').value = workshop.workshopId;
                document.getElementById('workshop-title').value = workshop.title;
                document.getElementById('workshop-description').value = workshop.description;
                document.getElementById('workshop-duration').value = workshop.duration;
                document.getElementById('workshop-difficulty').value = workshop.difficulty;
                document.getElementById('workshop-author').value = workshop.author || '';

                updateSummary();
                renderModules();
                renderNavigation();
                closeWorkshopBrowser();
                
                showNotification('‚úÖ Workshop loaded from browser storage!', 'success');
            }
        }

        // Workshop browser functions
        function openWorkshopBrowser() {
            document.getElementById('workshop-browser-modal').classList.add('active');
            renderWorkshopBrowser();
        }

        function closeWorkshopBrowser() {
            document.getElementById('workshop-browser-modal').classList.remove('active');
        }

        async function renderWorkshopBrowser() {
            const container = document.getElementById('workshop-browser-list');
            let savedWorkshops = [];

            if (useFilesystem) {
                // Load from filesystem
                try {
                    const workshops = await loadWorkshopsFromFilesystem();
                    savedWorkshops = workshops.map(ws => ({
                        workshopId: ws.workshopId,
                        title: ws.title,
                        description: ws.description,
                        duration: ws.duration,
                        difficulty: ws.difficulty,
                        modules: ws.frontmatter?.modules || ws.modules || [],
                        lastUpdated: 'From filesystem'
                    }));
                } catch (error) {
                    console.error('Failed to load workshops from filesystem:', error);
                    showNotification('Failed to load workshops from filesystem', 'error');
                }
            } else {
                // Get all workshops from localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('workshop-')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            savedWorkshops.push(data);
                        } catch (e) {
                            console.error('Error parsing workshop:', key, e);
                        }
                    }
                }
            }

            if (savedWorkshops.length === 0) {
                container.innerHTML = `
                    <div class="empty-browser">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                        <h3>No Saved Workshops</h3>
                        <p>${useFilesystem ? 'No workshops found in filesystem.' : 'Create and save a workshop to see it here.'}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            savedWorkshops.forEach(ws => {
                const item = document.createElement('div');
                item.className = 'workshop-browser-item';
                const moduleCount = ws.modules ? ws.modules.length : 0;
                const totalDuration = ws.modules ? ws.modules.reduce((sum, m) => {
                    // Handle both array of strings and array of objects
                    if (typeof m === 'string') return sum;
                    return sum + (m.duration || 0);
                }, 0) : 0;
                
                item.innerHTML = `
                    <h4>
                        ${ws.title || ws.workshopId}
                        <span class="badge ${ws.difficulty}">${ws.difficulty}</span>
                    </h4>
                    <p><strong>ID:</strong> ${ws.workshopId}</p>
                    <p>${ws.description || 'No description'}</p>
                    <div class="meta">
                        <span>üìö ${moduleCount} modules</span>
                        ${totalDuration > 0 ? `<span>‚è±Ô∏è ${totalDuration} min</span>` : ''}
                        <span>üìÖ ${ws.lastUpdated || 'Unknown date'}</span>
                        ${useFilesystem ? '<span style="color: var(--success-color)">üíæ Filesystem</span>' : '<span>üåê Browser</span>'}
                    </div>
                `;
                item.onclick = () => {
                    // Populate the Workshop ID field
                    document.getElementById('workshop-id').value = ws.workshopId;
                    // Load the workshop
                    loadWorkshop(ws.workshopId);
                    // Close the browser modal
                    closeWorkshopBrowser();
                };
                container.appendChild(item);
            });
        }

        async function filterWorkshops() {
            const search = document.getElementById('workshop-search').value.toLowerCase();
            const container = document.getElementById('workshop-browser-list');
            let savedWorkshops = [];

            // Get workshops based on mode
            if (useFilesystem) {
                // Load from filesystem
                try {
                    const workshops = await loadWorkshopsFromFilesystem();
                    savedWorkshops = workshops.map(ws => ({
                        workshopId: ws.workshopId,
                        title: ws.title,
                        description: ws.description,
                        duration: ws.duration,
                        difficulty: ws.difficulty,
                        modules: ws.frontmatter?.modules || ws.modules || [],
                        lastUpdated: 'From filesystem'
                    }));
                } catch (error) {
                    console.error('Failed to load workshops from filesystem:', error);
                }
            } else {
                // Get all workshops from localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('workshop-')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            savedWorkshops.push(data);
                        } catch (e) {
                            console.error('Error parsing workshop:', key, e);
                        }
                    }
                }
            }

            // Filter workshops
            const filtered = savedWorkshops.filter(ws => {
                return ws.workshopId.toLowerCase().includes(search) ||
                       (ws.title && ws.title.toLowerCase().includes(search)) ||
                       (ws.description && ws.description.toLowerCase().includes(search));
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-browser">
                        <p>No workshops found matching "${search}"</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            filtered.forEach(ws => {
                const item = document.createElement('div');
                item.className = 'workshop-browser-item';
                const moduleCount = ws.modules ? ws.modules.length : 0;
                const totalDuration = ws.modules ? ws.modules.reduce((sum, m) => sum + (m.duration || 0), 0) : 0;
                
                item.innerHTML = `
                    <h4>
                        ${ws.title || ws.workshopId}
                        <span class="badge ${ws.difficulty}">${ws.difficulty}</span>
                    </h4>
                    <p><strong>ID:</strong> ${ws.workshopId}</p>
                    <p>${ws.description || 'No description'}</p>
                    <div class="meta">
                        <span>üìö ${moduleCount} modules</span>
                        <span>‚è±Ô∏è ${totalDuration} min</span>
                        <span>üìÖ ${ws.lastUpdated || 'Unknown date'}</span>
                    </div>
                `;
                item.onclick = () => {
                    // Populate the Workshop ID field
                    document.getElementById('workshop-id').value = ws.workshopId;
                    // Load the workshop
                    loadWorkshop(ws.workshopId);
                    // Close the browser modal
                    closeWorkshopBrowser();
                };
                container.appendChild(item);
            });
        }

        // Module management
        function openModuleBrowser() {
            document.getElementById('module-browser-modal').classList.add('active');
            renderModuleBrowser();
        }

        function closeModuleBrowser() {
            document.getElementById('module-browser-modal').classList.remove('active');
        }

        function showCreateCustomModule() {
            document.getElementById('module-browser-modal').classList.remove('active');
            document.getElementById('custom-module-modal').classList.add('active');
            // Clear form
            document.getElementById('custom-module-name').value = '';
            document.getElementById('custom-module-description').value = '';
            document.getElementById('custom-module-duration').value = '30';
            document.getElementById('custom-module-difficulty').value = 'intermediate';
            document.getElementById('custom-module-type').value = 'hands-on';
            document.getElementById('custom-module-ref').value = '';
        }

        function closeCustomModule() {
            document.getElementById('custom-module-modal').classList.remove('active');
        }

        function createCustomModule() {
            const name = document.getElementById('custom-module-name').value.trim();
            const description = document.getElementById('custom-module-description').value.trim();
            const duration = parseInt(document.getElementById('custom-module-duration').value);
            const difficulty = document.getElementById('custom-module-difficulty').value;
            const type = document.getElementById('custom-module-type').value;
            const ref = document.getElementById('custom-module-ref').value.trim();

            // Validate required fields
            if (!name) {
                alert('Please enter a module name');
                document.getElementById('custom-module-name').focus();
                return;
            }

            if (!description) {
                alert('Please enter a module description');
                document.getElementById('custom-module-description').focus();
                return;
            }

            if (!duration || duration < 5 || duration > 300) {
                alert('Please enter a valid duration (5-300 minutes)');
                document.getElementById('custom-module-duration').focus();
                return;
            }

            // Create module reference if not provided
            const moduleRef = ref || `custom/${name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')}`;

            // Check if module with same ref already exists
            if (workshop.modules.some(m => m.moduleRef === moduleRef)) {
                alert('A module with this reference already exists in the workshop');
                return;
            }

            // Add the custom module
            const newModule = {
                order: workshop.modules.length + 1,
                name: name,
                description: description,
                duration: duration,
                difficulty: difficulty,
                type: type,
                moduleRef: moduleRef,
                required: true
            };

            workshop.modules.push(newModule);
            
            closeCustomModule();
            updateSummary();
            renderModules();
            renderNavigation();
            
            showNotification(`‚úÖ Custom module "${name}" added successfully!`, 'success');
        }

        // Edit Module Functions
        let editingModuleIndex = -1;

        function editModule(index) {
            editingModuleIndex = index;
            const module = workshop.modules[index];
            
            // Populate form with module data
            document.getElementById('edit-module-name').value = module.name || '';
            document.getElementById('edit-module-description').value = module.description || '';
            document.getElementById('edit-module-duration').value = module.duration || 30;
            document.getElementById('edit-module-difficulty').value = module.difficulty || 'intermediate';
            document.getElementById('edit-module-type').value = module.type || 'hands-on';
            document.getElementById('edit-module-required').checked = module.required !== false;
            document.getElementById('edit-module-ref').value = module.moduleRef || '';
            
            // Show modal
            document.getElementById('edit-module-modal').classList.add('active');
        }

        function closeEditModule() {
            document.getElementById('edit-module-modal').classList.remove('active');
            editingModuleIndex = -1;
        }

        function saveModuleEdits() {
            if (editingModuleIndex < 0 || editingModuleIndex >= workshop.modules.length) {
                alert('Invalid module index');
                return;
            }

            const name = document.getElementById('edit-module-name').value.trim();
            const description = document.getElementById('edit-module-description').value.trim();
            const duration = parseInt(document.getElementById('edit-module-duration').value);
            const difficulty = document.getElementById('edit-module-difficulty').value;
            const type = document.getElementById('edit-module-type').value;
            const required = document.getElementById('edit-module-required').checked;

            // Validate required fields
            if (!name) {
                alert('Please enter a module name');
                document.getElementById('edit-module-name').focus();
                return;
            }

            if (!description) {
                alert('Please enter a module description');
                document.getElementById('edit-module-description').focus();
                return;
            }

            if (!duration || duration < 5 || duration > 300) {
                alert('Please enter a valid duration (5-300 minutes)');
                document.getElementById('edit-module-duration').focus();
                return;
            }

            // Update the module
            workshop.modules[editingModuleIndex] = {
                ...workshop.modules[editingModuleIndex],
                name: name,
                description: description,
                duration: duration,
                difficulty: difficulty,
                type: type,
                required: required
            };

            closeEditModule();
            updateSummary();
            renderModules();
            renderNavigation();
            
            showNotification(`‚úÖ Module "${name}" updated successfully!`, 'success');
        }

        function renderModuleBrowser() {
            const container = document.getElementById('module-browser-list');
            container.innerHTML = '';

            availableModules.forEach(module => {
                const item = document.createElement('div');
                item.className = 'module-browser-item';
                item.innerHTML = `
                    <h4>${module.name} <span class="badge ${module.type}">${module.type}</span></h4>
                    <p>${module.description}</p>
                    <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text-light);">
                        <span>‚è±Ô∏è ${module.duration} min</span>
                        <span class="badge ${module.difficulty}">${module.difficulty}</span>
                    </div>
                `;
                item.onclick = () => addModule(module);
                container.appendChild(item);
            });
        }

        function filterModules() {
            const search = document.getElementById('module-search').value.toLowerCase();
            const typeFilter = document.getElementById('module-type-filter').value;

            const container = document.getElementById('module-browser-list');
            container.innerHTML = '';

            const filtered = availableModules.filter(module => {
                const matchesSearch = module.name.toLowerCase().includes(search) || 
                                     module.description.toLowerCase().includes(search) ||
                                     module.tags.some(tag => tag.includes(search));
                const matchesType = typeFilter === 'all' || module.type === typeFilter;
                return matchesSearch && matchesType;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-light);">No modules found</div>';
                return;
            }

            filtered.forEach(module => {
                const item = document.createElement('div');
                item.className = 'module-browser-item';
                item.innerHTML = `
                    <h4>${module.name} <span class="badge ${module.type}">${module.type}</span></h4>
                    <p>${module.description}</p>
                    <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text-light);">
                        <span>‚è±Ô∏è ${module.duration} min</span>
                        <span class="badge ${module.difficulty}">${module.difficulty}</span>
                    </div>
                `;
                item.onclick = () => addModule(module);
                container.appendChild(item);
            });
        }

        function addModule(module) {
            // Check if module already exists
            if (workshop.modules.some(m => m.moduleRef === module.moduleRef)) {
                alert('This module is already in the workshop');
                return;
            }

            workshop.modules.push({
                moduleRef: module.moduleRef,
                name: module.name,
                description: module.description,
                duration: module.duration,
                difficulty: module.difficulty,
                type: module.type,
                required: true,
                order: workshop.modules.length + 1
            });

            closeModuleBrowser();
            updateSummary();
            renderModules();
            renderNavigation();
        }

        function removeModule(index) {
            if (confirm('Remove this module from the workshop?')) {
                workshop.modules.splice(index, 1);
                // Renumber
                workshop.modules.forEach((m, i) => m.order = i + 1);
                updateSummary();
                renderModules();
                renderNavigation();
            }
        }

        function moveModuleUp(index) {
            if (index === 0) return;
            [workshop.modules[index], workshop.modules[index - 1]] = 
            [workshop.modules[index - 1], workshop.modules[index]];
            workshop.modules.forEach((m, i) => m.order = i + 1);
            updateSummary();
            renderModules();
            renderNavigation();
        }

        function moveModuleDown(index) {
            if (index === workshop.modules.length - 1) return;
            [workshop.modules[index], workshop.modules[index + 1]] = 
            [workshop.modules[index + 1], workshop.modules[index]];
            workshop.modules.forEach((m, i) => m.order = i + 1);
            updateSummary();
            renderModules();
            renderNavigation();
        }

        function clearAllModules() {
            if (confirm('Remove all modules from the workshop?')) {
                workshop.modules = [];
                updateSummary();
                renderModules();
            }
        }

        function renderModules() {
            console.log('=== RENDER MODULES DEBUG ===');
            console.log('workshop object:', workshop);
            console.log('workshop.modules:', workshop.modules);
            console.log('workshop.modules.length:', workshop.modules.length);
            
            const container = document.getElementById('modules-list');
            
            if (workshop.modules.length === 0) {
                console.log('No modules - showing empty state');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No Modules Yet</h3>
                        <p>Click "Add Module" to start building your workshop</p>
                    </div>
                `;
                return;
            }
            
            console.log('Rendering', workshop.modules.length, 'modules');

            container.innerHTML = '';
            workshop.modules.forEach((module, index) => {
                // Handle both object and string formats
                const moduleData = typeof module === 'object' ? module : {
                    order: index + 1,
                    name: module,
                    moduleRef: module,
                    type: 'canonical',
                    difficulty: 'intermediate',
                    duration: 30,
                    description: module
                };
                
                const card = document.createElement('div');
                card.className = 'module-card';
                card.innerHTML = `
                    <div class="module-card-header" onclick="editModule(${index})" style="cursor: pointer;" title="Click to edit module">
                        <div style="display: flex; align-items: center; flex: 1;">
                            <div class="module-card-order">${moduleData.order || index + 1}</div>
                            <div>
                                <div class="module-card-title">
                                    ${moduleData.name || moduleData.moduleRef || 'Unnamed Module'}
                                    <span style="font-size: 0.75rem; color: var(--primary-color); margin-left: 0.5rem;">‚úèÔ∏è Click to edit</span>
                                </div>
                                <div style="font-size: 0.875rem; color: var(--text-light); margin-top: 0.25rem;">
                                    ${moduleData.moduleRef || ''}
                                </div>
                            </div>
                        </div>
                        <span class="badge ${moduleData.type || 'canonical'}">${moduleData.type || 'canonical'}</span>
                    </div>
                    <div style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.75rem;" onclick="editModule(${index})" style="cursor: pointer;">
                        ${moduleData.description || 'No description'}
                    </div>
                    <div class="module-card-meta">
                        <span>‚è±Ô∏è ${moduleData.duration || 30} min</span>
                        <span class="badge ${moduleData.difficulty || 'intermediate'}">${moduleData.difficulty || 'intermediate'}</span>
                    </div>
                    <div class="module-card-actions">
                        <button class="btn btn-secondary btn-sm btn-icon" onclick="event.stopPropagation(); moveModuleUp(${index})" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button class="btn btn-secondary btn-sm btn-icon" onclick="event.stopPropagation(); moveModuleDown(${index})" ${index === workshop.modules.length - 1 ? 'disabled' : ''}>‚Üì</button>
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); removeModule(${index})">üóëÔ∏è Remove</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateSummary() {
            document.getElementById('modules-count').textContent = workshop.modules.length;
            
            // Handle both object and string formats for duration
            const totalDuration = workshop.modules.reduce((sum, m) => {
                if (typeof m === 'object') {
                    return sum + (m.duration || 0);
                }
                return sum;
            }, 0);
            document.getElementById('total-duration').textContent = totalDuration;
            
            // Auto-update the workshop duration field
            const durationField = document.getElementById('workshop-duration');
            if (durationField && totalDuration > 0) {
                durationField.value = totalDuration;
                workshop.duration = totalDuration;
            }
            
            // Handle both object and string formats for type
            const canonical = workshop.modules.filter(m => {
                if (typeof m === 'object') {
                    return m.type === 'canonical';
                }
                return true; // String modules default to canonical
            }).length;
            document.getElementById('canonical-count').textContent = canonical;
            
            const customized = workshop.modules.filter(m => {
                if (typeof m === 'object') {
                    return m.type === 'customized';
                }
                return false;
            }).length;
            document.getElementById('customized-count').textContent = customized;
        }

        function renderNavigation() {
            const container = document.getElementById('navigation-preview');
            
            if (workshop.modules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üß≠</div>
                        <h3>No Navigation Yet</h3>
                        <p>Add modules to see the navigation structure</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="max-width: 600px; margin: 0 auto;">';
            
            workshop.modules.forEach((module, index) => {
                // Handle both object and string formats
                const moduleData = typeof module === 'object' ? module : {
                    order: index + 1,
                    name: module,
                    duration: 30,
                    difficulty: 'intermediate'
                };
                
                const isFirst = index === 0;
                const isLast = index === workshop.modules.length - 1;
                
                html += `
                    <div style="background: var(--bg-light); border: 2px solid var(--border-color); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem;">
                            Module ${moduleData.order || (index + 1)} of ${workshop.modules.length}
                        </div>
                        <h3 style="margin-bottom: 0.5rem;">${moduleData.name || 'Unnamed Module'}</h3>
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <span>‚è±Ô∏è ${moduleData.duration || 30} min</span>
                            <span class="badge ${moduleData.difficulty || 'intermediate'}">${moduleData.difficulty || 'intermediate'}</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            ${!isFirst ? '<button class="btn btn-outline btn-sm">‚Üê Previous Module</button>' : ''}
                            <button class="btn btn-outline btn-sm">üè† Workshop Home</button>
                            ${!isLast ? '<button class="btn btn-primary btn-sm">Next Module ‚Üí</button>' : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function renderPreview() {
            const container = document.getElementById('workshop-preview');
            
            if (!workshop.title || workshop.modules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <h3>Complete Workshop Details</h3>
                        <p>Fill in the workshop details and add modules to see the preview</p>
                    </div>
                `;
                return;
            }

            const totalDuration = workshop.modules.reduce((sum, m) => sum + m.duration, 0);
            const hours = (totalDuration / 60).toFixed(1);

            let html = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <h1 style="color: var(--primary-color); margin-bottom: 1rem;">${workshop.title}</h1>
                    <p style="font-size: 1.125rem; color: var(--text-light); margin-bottom: 2rem;">${workshop.description}</p>
                    
                    <div style="background: var(--bg-light); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem;">üìã Workshop Details</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div><strong>Duration:</strong> ${workshop.duration} (~${hours} hours)</div>
                            <div><strong>Difficulty:</strong> <span class="badge ${workshop.difficulty}">${workshop.difficulty}</span></div>
                            <div><strong>Modules:</strong> ${workshop.modules.length}</div>
                            <div><strong>Total Time:</strong> ${totalDuration} minutes</div>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 1rem;">üìñ Workshop Modules</h3>
            `;

            workshop.modules.forEach((module, index) => {
                html += `
                    <div style="border-left: 4px solid var(--primary-color); padding-left: 1.5rem; margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 0.5rem;">${index + 1}. ${module.name}</h4>
                        <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                            <span>‚è±Ô∏è ${module.duration} minutes</span>
                            <span class="badge ${module.difficulty}">${module.difficulty}</span>
                            <span class="badge ${module.type}">${module.type}</span>
                        </div>
                        <p style="color: var(--text-light);">${module.description}</p>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }
    </script>
</body>
</html>
