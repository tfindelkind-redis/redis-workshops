<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Builder GUI - Redis Workshops</title>
    <style>
        :root {
            --primary-color: #DC382D;
            --primary-dark: #B42D23;
            --secondary-color: #2C3E50;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --border-color: #e5e7eb;
            --bg-light: #f9fafb;
            --text-color: #1f2937;
            --text-light: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: var(--text-color);
            background: var(--bg-light);
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 3px solid var(--primary-color);
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-light);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .main-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 56, 45, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #1a252f;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #bb2d3b;
        }

        .btn-danger:disabled {
            background: #f8d7da;
            color: #842029;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-outline {
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .module-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .module-card {
            background: var(--bg-light);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            cursor: move;
            transition: all 0.3s;
        }

        .module-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .module-card.dragging {
            opacity: 0.5;
        }

        .module-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .module-card-title {
            font-weight: 600;
            color: var(--text-color);
            flex: 1;
        }

        .module-card-order {
            background: var(--primary-color);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 0.75rem;
        }

        .module-card-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }

        .module-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }



        .badge.beginner {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.intermediate {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.advanced {
            background: #fee2e2;
            color: #991b1b;
        }

        .workshop-summary {
            background: var(--bg-light);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .workshop-summary h3 {
            margin-bottom: 1rem;
            color: var(--text-color);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .summary-label {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .module-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .module-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-light);
        }

        .module-browser {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
        }

        .module-browser-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s;
        }

        .module-browser-item:hover {
            background: var(--bg-light);
        }

        .module-browser-item:last-child {
            border-bottom: none;
        }

        .module-browser-item h4 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .module-browser-item p {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .action-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
        }

        .code-preview {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            overflow-x: auto;
            white-space: pre;
        }

        /* Tooltip styles */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--info-color);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: help;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .tooltip-text {
            visibility: hidden;
            position: absolute;
            z-index: 1001;
            background: var(--secondary-color);
            color: white;
            text-align: left;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            line-height: 1.4;
            width: 280px;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--secondary-color) transparent transparent transparent;
        }

        .tooltip-wrapper:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .workshop-browser {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .workshop-browser-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s;
            border-radius: 4px;
        }

        .workshop-browser-item:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
        }

        .workshop-browser-item:last-child {
            border-bottom: none;
        }

        .workshop-browser-item h4 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .workshop-browser-item p {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .workshop-browser-item .meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .empty-browser {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        @media (max-width: 1024px) {
            .layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
            }

            .tooltip-text {
                width: 220px;
            }
        }

        /* Notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* ========================================
           File Browser Styles
           ======================================== */
        .file-browser-item {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-browser-item:hover {
            background: #f8f9fa;
        }

        .file-browser-item:last-child {
            border-bottom: none;
        }

        .workshop-item {
            font-weight: 600;
            background: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding-left: calc(0.75rem - 4px);
        }

        .workshop-item:hover {
            background: #e9ecef;
        }

        /* Module hierarchy indentation */
        .module-item {
            padding-left: 2.5rem;
            font-size: 0.95rem;
        }

        .module-item-child {
            padding-left: 4rem;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .module-item-grandchild {
            padding-left: 5.5rem;
            font-size: 0.85rem;
            color: #868e96;
        }

        /* Item components */
        .item-icon {
            display: inline-block;
            width: 1.5rem;
            text-align: center;
            flex-shrink: 0;
        }

        .item-label {
            flex: 1;
            min-width: 0;
        }

        .item-badge {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            background: #e9ecef;
            color: #495057;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }

        .item-badge.parent {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Child module states */
        .item-badge.child {
            background: #e2e3e5;
            color: #383d41;
        }

        .item-badge.child-in-sync {
            background: #d4edda;
            color: #155724;
            font-weight: 500;
        }

        .item-badge.child-out-of-sync {
            background: #fff3cd;
            color: #856404;
            font-weight: 500;
        }

        .item-badge.child-customized {
            background: #d1ecf1;
            color: #0c5460;
            font-weight: 500;
        }

        /* Collapse/expand functionality */
        .workshop-collapsed .workshop-modules {
            display: none;
        }

        .workshop-expanded .workshop-modules {
            display: block;
        }

        .item-chevron {
            display: inline-block;
            width: 1rem;
            transition: transform 0.2s;
            margin-right: 0.25rem;
            flex-shrink: 0;
        }

        .workshop-collapsed .item-chevron {
            transform: rotate(-90deg);
        }

        .module-path {
            font-size: 0.75rem;
            color: #868e96;
            margin-left: 0.25rem;
        }

        /* Module collapse/expand */
        .module-parent-item {
            position: relative;
        }

        .module-children {
            padding-left: 1.5rem;
            transition: all 0.2s ease-in-out;
        }

        .module-collapsed .item-chevron {
            transform: rotate(0deg);
        }

        .module-expanded .item-chevron {
            transform: rotate(90deg);
        }

        /* Branch management styles */
        #branch-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #branch-selector {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 200px;
        }

        #branch-selector:hover {
            border-color: var(--primary-color);
        }

        #branch-section button {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            font-size: 1rem;
        }

        #branch-section button:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
        }

        #gh-pages-section button,
        #github-pr-section button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        #gh-pages-section button:hover,
        #github-pr-section button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header > div {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 100%; gap: 1rem;">
            <div style="flex: 1;">
                <h1>üéì Workshop Builder GUI</h1>
                <p id="header-subtitle">Create and manage Redis workshops with visual tools - No command line required!</p>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <!-- Branch Management -->
                <div id="branch-section" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; background: white; padding: 0.5rem; border-radius: 4px; border: 1px solid #dee2e6;">
                        <span style="font-size: 0.875rem; font-weight: 500;">üåø Branch:</span>
                        <select id="branch-selector" onchange="switchBranch()" style="border: none; background: transparent; font-size: 0.875rem; cursor: pointer; min-width: 150px;">
                            <option value="">Loading...</option>
                        </select>
                        <button class="btn btn-sm btn-outline" onclick="showCreateBranchModal()" title="Create new branch" style="padding: 0.25rem 0.5rem;">
                            ‚ûï
                        </button>
                    </div>
                </div>
                <!-- GitHub Pages Link -->
                <div id="gh-pages-section" style="display: none; align-items: center;">
                    <button class="btn btn-outline" onclick="openGitHubPages()" style="padding: 10px 15px; font-size: 14px; white-space: nowrap;">
                        üìñ View GitHub Pages
                    </button>
                </div>
                <!-- PR Button -->
                <div id="github-pr-section" style="display: none; flex-direction: column; align-items: center;">
                    <button class="btn btn-success" onclick="showCreatePRModal()" style="padding: 10px 20px; font-size: 14px; white-space: nowrap;">
                        <span id="pr-button-text">üöÄ Create Pull Request</span>
                    </button>
                    <div id="pr-status" style="margin-top: 5px; font-size: 12px; text-align: center;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="layout">
            <!-- Sidebar: Workshop Details -->
            <div class="sidebar">
                <h2 style="margin-bottom: 1.5rem;">Workshop Details</h2>
                
                <div class="form-group">
                    <label for="workshop-id">
                        Workshop ID *
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">A unique identifier for your workshop. Use lowercase letters, numbers, and hyphens only. Example: redis-caching-101</span>
                        </span>
                    </label>
                    <input type="text" id="workshop-id" placeholder="my-workshop">
                    <small>Lowercase letters, numbers, and hyphens only</small>
                </div>

                <div class="form-group">
                    <label for="workshop-title">
                        Title *
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">The display name of your workshop. This can include spaces, capitals, and special characters.</span>
                        </span>
                    </label>
                    <input type="text" id="workshop-title" placeholder="My Redis Workshop">
                </div>

                <div class="form-group">
                    <label for="workshop-description">
                        Description *
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">A brief overview of what participants will learn in this workshop. Keep it to 1-2 sentences.</span>
                        </span>
                    </label>
                    <textarea id="workshop-description" placeholder="Brief description of your workshop"></textarea>
                </div>

                <div class="form-group">
                    <label for="workshop-duration">
                        Duration *
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Estimated time to complete the workshop. Examples: "2 hours", "4 hours", "Full day"</span>
                        </span>
                    </label>
                    <input type="text" id="workshop-duration" placeholder="4 hours">
                </div>

                <div class="form-group">
                    <label for="workshop-difficulty">
                        Difficulty *
                        <span class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Choose the appropriate skill level: Beginner (no prior experience), Intermediate (basic knowledge), or Advanced (expert level)</span>
                        </span>
                    </label>
                    <select id="workshop-difficulty">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="workshop-author">Author</label>
                    <input type="text" id="workshop-author" placeholder="Your Name">
                </div>

                <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="auto-generate-modules" checked style="margin-right: 0.5rem; width: auto; cursor: pointer;">
                        <span style="flex: 1;">
                            Auto-generate module directories
                            <span class="tooltip-wrapper" style="margin-left: 0.25rem;">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Automatically creates individual module directories with navigation when you save the workshop. Uncheck to manually control when modules are generated.</span>
                            </span>
                        </span>
                    </label>
                    <p style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem; color: var(--text-light);">
                        Creates separate README.md files with navigation for each module
                    </p>
                </div>

                <button class="btn btn-primary" style="width: 100%;" onclick="saveWorkshop()">
                    üíæ Save Workshop
                    <span class="tooltip-wrapper">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Saves your workshop to browser storage. You can load it later from the same browser.</span>
                    </span>
                </button>

                <button class="btn btn-outline" style="width: 100%; margin-top: 0.5rem;" onclick="openWorkshopBrowser()">
                    üìÇ Load Existing Workshop
                    <span class="tooltip-wrapper">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Load a previously saved workshop from browser storage to continue editing.</span>
                    </span>
                </button>

                <button class="btn btn-danger" style="width: 100%; margin-top: 0.5rem;" onclick="deleteCurrentWorkshop()" id="delete-workshop-btn" disabled>
                    üóëÔ∏è Delete Workshop
                    <span class="tooltip-wrapper">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Permanently delete the current workshop and all its files. This action cannot be undone!</span>
                    </span>
                </button>
            </div>

            <!-- Main Content: Tabs -->
            <div class="main-content">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('modules')">üìö Modules</button>
                    <button class="tab" onclick="switchTab('navigation')">üß≠ Navigation</button>
                    <button class="tab" onclick="switchTab('module-manager')">üîó Module Manager</button>
                </div>

                <!-- Modules Tab -->
                <div id="modules-tab" class="tab-content active">
                    <div class="workshop-summary">
                        <h3>üìä Workshop Summary</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-value" id="modules-count">0</div>
                                <div class="summary-label">Modules</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="total-duration">0</div>
                                <div class="summary-label">Total Minutes</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="hands-on-count">0</div>
                                <div class="summary-label">Hands-on</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="lecture-count">0</div>
                                <div class="summary-label">Lectures</div>
                            </div>
                        </div>
                    </div>

                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="openModuleBrowser()">
                            ‚ûï Add Module
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="clearAllModules()">
                            üóëÔ∏è Clear All
                        </button>
                    </div>

                    <div id="modules-list" class="module-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <h3>No Modules Yet</h3>
                            <p>Click "Add Module" to start building your workshop</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation Tab -->
                <div id="navigation-tab" class="tab-content">
                    <div class="alert alert-success">
                        <strong>‚úÖ Auto-Generation Enabled</strong><br>
                        Module directories with navigation are automatically created when you save the workshop.
                        Each module gets its own folder with protected navigation sections.
                    </div>
                    
                    <div class="alert alert-info" style="margin-top: 15px;">
                        <strong>üìÅ Module Structure</strong><br>
                        Each module directory contains a README.md with:
                        <ul style="margin: 10px 0 0 20px; padding: 0;">
                            <li><strong>Protected Navigation Header:</strong> Breadcrumb, progress bar, workshop title</li>
                            <li><strong>Editable Content Section:</strong> Your module content (between markers)</li>
                            <li><strong>Protected Navigation Footer:</strong> Previous/Home/Next navigation buttons</li>
                        </ul>
                        Protected sections use <code>&lt;!-- ‚ö†Ô∏è DO NOT EDIT --&gt;</code> markers.
                    </div>
                    
                    <div style="margin-top: 20px; padding: 20px; background: var(--bg-light); border-radius: 8px; border: 1px solid var(--border-color);">
                        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üîß</span>
                            <span>Manual Regeneration</span>
                        </h3>
                        <p style="color: var(--text-light); margin-bottom: 1rem;">
                            Need to manually regenerate all module directories? Use this if you've reordered modules 
                            or want to update navigation without saving.
                        </p>
                        <button class="btn btn-secondary" onclick="generateModuleStructure()" style="padding: 10px 24px;">
                            ÔøΩ Regenerate Module Directories
                        </button>
                        <p style="margin-top: 0.75rem; font-size: 0.875rem; color: var(--text-light);">
                            This will recreate all module folders with updated navigation
                        </p>
                    </div>
                    
                    <div id="navigation-preview" style="margin-top: 30px;">
                        <div class="empty-state">
                            <div class="empty-state-icon">üß≠</div>
                            <h3>No Navigation Yet</h3>
                            <p>Add modules to see the navigation structure</p>
                        </div>
                    </div>
                </div>

                <!-- Module Manager Tab -->
                <div id="module-manager-tab" class="tab-content">
                    <div class="alert alert-info">
                        <strong>üîó Module Manager - Hierarchical Browser</strong><br>
                        Explore modules in a hierarchical structure. Click on any module to view its children, or navigate using breadcrumbs.
                    </div>

                    <div class="tabs" style="margin-top: 1rem; border-bottom: 2px solid var(--border-color);">
                        <button class="tab active" onclick="switchModuleManagerTab('browse')">üìö Browse Modules</button>
                        <button class="tab" onclick="switchModuleManagerTab('duplicates')">üîç Find Duplicates</button>
                        <button class="tab" onclick="switchModuleManagerTab('link')">üîó Link Modules</button>
                    </div>

                    <!-- Browse Modules Sub-Tab (File Browser View) -->
                    <div id="mm-browse-tab" class="tab-content active" style="margin-top: 1rem;">
                        <!-- Action Bar -->
                        <div class="action-bar" style="margin-bottom: 1rem;">
                            <button class="btn btn-primary btn-sm" onclick="loadModuleBrowser()">
                                üîÑ Refresh
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="expandAllWorkshops()">
                                üìÇ Expand All
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="collapseAllWorkshops()">
                                üìÅ Collapse All
                            </button>
                            <label style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="show-test-modules" onchange="loadModuleBrowser()">
                                <span>Show test modules</span>
                            </label>
                        </div>

                        <!-- Search Box -->
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <input 
                                type="text" 
                                id="module-manager-search" 
                                placeholder="üîç Filter by module name, workshop, or path..." 
                                oninput="filterModuleBrowser()"
                                style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem;"
                            >
                        </div>

                        <!-- Statistics Summary -->
                        <div class="workshop-summary" style="margin-bottom: 1.5rem;">
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <div class="summary-value" id="mm-total-count">-</div>
                                    <div class="summary-label">Total Modules</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value" id="mm-workshops-count">-</div>
                                    <div class="summary-label">Workshops</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value" id="mm-parent-count">-</div>
                                    <div class="summary-label">Parents</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value" id="mm-depth-count">-</div>
                                    <div class="summary-label">Max Depth</div>
                                </div>
                            </div>
                        </div>

                        <!-- File Browser Tree View -->
                        <div id="module-browser" style="border: 1px solid var(--border-color); border-radius: 6px; background: white; max-height: 600px; overflow-y: auto;">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìÅ</div>
                                <h3>No Modules Loaded</h3>
                                <p>Click "Refresh" to browse modules organized by workshop</p>
                            </div>
                        </div>
                    </div>

                    <!-- Find Duplicates Sub-Tab -->
                    <div id="mm-duplicates-tab" class="tab-content" style="margin-top: 1rem;">
                        <div class="alert alert-warning">
                            <strong>üîç Find Duplicates</strong><br>
                            Discover modules with similar names across workshops. Link them to establish parent-child relationships.
                        </div>

                        <div class="action-bar" style="margin-bottom: 1rem;">
                            <button class="btn btn-primary btn-sm" onclick="findDuplicateModules()">
                                üîç Scan for Duplicates
                            </button>
                        </div>

                        <div id="duplicates-list" style="margin-top: 1rem;">
                            <div class="empty-state">
                                <div class="empty-state-icon">üîç</div>
                                <h3>Click "Scan for Duplicates"</h3>
                                <p>We'll search for modules with similar names across all workshops</p>
                            </div>
                        </div>
                    </div>

                    <!-- Link Modules Sub-Tab -->
                    <div id="mm-link-tab" class="tab-content" style="margin-top: 1rem;">
                        <div class="alert alert-info">
                            <strong>üîó Link Modules</strong><br>
                            Create parent-child relationships between modules. The child module will reference the parent.
                        </div>

                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="link-child-module">Child Module (will link TO parent) *</label>
                            <select id="link-child-module" style="width: 100%;">
                                <option value="">Select a module to make a child...</option>
                            </select>
                            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-light);">
                                This module will reference the parent module
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="link-parent-module">Parent Module (will be referenced) *</label>
                            <select id="link-parent-module" style="width: 100%;">
                                <option value="">Select a parent module...</option>
                            </select>
                            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-light);">
                                This module will be marked as root and tracked
                            </p>
                        </div>

                        <div class="action-bar">
                            <button class="btn btn-primary" onclick="linkModules()" id="link-modules-btn" disabled>
                                üîó Link Modules
                            </button>
                            <button class="btn btn-outline" onclick="resetLinkForm()">
                                üîÑ Reset
                            </button>
                        </div>

                        <div id="link-result" style="margin-top: 1rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Module Browser Modal -->
    <div id="module-browser-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìö Add Module</h2>
                <button class="modal-close" onclick="closeModuleBrowser()">‚úï</button>
            </div>

            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button class="btn btn-primary" onclick="showCreateCustomModule()">‚ûï Create Custom Module</button>
                <div style="flex: 1;"></div>
            </div>

            <div class="form-group">
                <label for="module-search">Search Modules</label>
                <input type="text" id="module-search" placeholder="Search by name, description, workshop, or module ID..." oninput="filterModules()">
            </div>

            <div class="module-browser" id="module-browser-list">
                <!-- Modules will be populated here -->
            </div>
        </div>
    </div>

    <!-- Create Custom Module Modal -->
    <div id="custom-module-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Create Custom Module</h2>
                <button class="modal-close" onclick="closeCustomModule()">‚úï</button>
            </div>

            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <strong>‚ÑπÔ∏è Custom Module</strong><br>
                Create a standalone module that doesn't reference an existing module in the repository.
            </div>

            <div class="form-group">
                <label for="custom-module-name">Module Name *</label>
                <input type="text" id="custom-module-name" placeholder="e.g., Advanced Redis Patterns" required oninput="updateModuleRefFromName()">
            </div>

            <div class="form-group">
                <label for="custom-module-description">Description *</label>
                <textarea id="custom-module-description" rows="3" placeholder="Describe what students will learn in this module..." required></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="custom-module-duration">Duration (minutes) *</label>
                    <input type="number" id="custom-module-duration" value="30" min="5" max="300" required>
                </div>

                <div class="form-group">
                    <label for="custom-module-difficulty">Difficulty *</label>
                    <select id="custom-module-difficulty" required>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="custom-module-type">Type *</label>
                    <select id="custom-module-type" required>
                        <option value="lecture">Lecture</option>
                        <option value="hands-on" selected>Hands-on</option>
                        <option value="demo">Demo</option>
                        <option value="lab">Lab</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="custom-module-ref">Module Reference (optional)</label>
                <input type="text" id="custom-module-ref" placeholder="e.g., custom/advanced-patterns">
                <small style="color: var(--text-light);">Optional: A reference ID for this module</small>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeCustomModule()">Cancel</button>
                <button class="btn btn-primary" onclick="createCustomModule()">Create Module</button>
            </div>
        </div>
    </div>

    <!-- Edit Module Modal -->
    <div id="edit-module-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Module</h2>
                <button class="modal-close" onclick="closeEditModule()">‚úï</button>
            </div>

            <div class="alert alert-warning" style="margin-bottom: 1rem;">
                <strong>‚ö†Ô∏è Edit Module Settings</strong><br>
                Changes will be saved when you click "Save Changes" and then save the workshop.
            </div>

            <div class="form-group">
                <label for="edit-module-name">Module Name *</label>
                <input type="text" id="edit-module-name" placeholder="e.g., Advanced Redis Patterns" required>
            </div>

            <div class="form-group">
                <label for="edit-module-description">Description *</label>
                <textarea id="edit-module-description" rows="3" placeholder="Describe what students will learn in this module..." required></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="edit-module-duration">Duration (minutes) *</label>
                    <input type="number" id="edit-module-duration" value="30" min="5" max="300" required>
                </div>

                <div class="form-group">
                    <label for="edit-module-difficulty">Difficulty *</label>
                    <select id="edit-module-difficulty" required>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-module-type">Type *</label>
                    <select id="edit-module-type" required>
                        <option value="lecture">Lecture</option>
                        <option value="hands-on">Hands-on</option>
                        <option value="demo">Demo</option>
                        <option value="lab">Lab</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="edit-module-required" checked style="width: auto; margin-right: 0.5rem;">
                    Required Module
                </label>
                <small style="display: block; color: var(--text-light); margin-top: 0.25rem;">
                    Uncheck if this module is optional for learners
                </small>
            </div>

            <div class="form-group">
                <label for="edit-module-ref">Module Reference</label>
                <input type="text" id="edit-module-ref" placeholder="e.g., modules/redis-basics" readonly style="background: var(--bg-light);">
                <small style="color: var(--text-light);">Reference path (read-only)</small>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="closeEditModule()">Cancel</button>
                <button class="btn btn-primary" onclick="saveModuleEdits()">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Create Branch Modal -->
    <div id="create-branch-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üåø Create New Branch</h2>
                <button class="modal-close" onclick="closeCreateBranchModal()">‚úï</button>
            </div>

            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <strong>‚ÑπÔ∏è New Branch</strong><br>
                Create a new branch to work on your changes independently.
            </div>

            <div class="form-group">
                <label for="new-branch-name">Branch Name *</label>
                <input type="text" id="new-branch-name" placeholder="e.g., my-workshop-updates" required>
                <small style="color: var(--text-light);">Use lowercase, hyphens, and no spaces</small>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeCreateBranchModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createNewBranch()">üåø Create Branch</button>
            </div>
        </div>
    </div>

    <!-- Create PR Modal -->
    <div id="create-pr-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üöÄ Create Pull Request</h2>
                <button class="modal-close" onclick="closeCreatePRModal()">‚úï</button>
            </div>

            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <strong>üìù Pull Request Details</strong><br>
                Review the changes and provide details for your pull request.
            </div>

            <div id="pr-workshop-summary" style="background: var(--bg-light); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <h3 style="margin-bottom: 0.5rem;">Workshop Summary</h3>
                <div id="pr-summary-content">Loading...</div>
            </div>

            <div class="form-group">
                <label for="pr-title">Pull Request Title *</label>
                <input type="text" id="pr-title" placeholder="e.g., Add Redis Fundamentals Workshop" required>
            </div>

            <div class="form-group">
                <label for="pr-description">Description</label>
                <textarea id="pr-description" rows="6" placeholder="Describe the changes in this pull request..."></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeCreatePRModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmCreatePR()">üöÄ Create Pull Request</button>
            </div>
        </div>
    </div>

    <!-- Workshop Browser Modal -->
    <div id="workshop-browser-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÇ Load Workshop</h2>
                <button class="modal-close" onclick="closeWorkshopBrowser()">‚úï</button>
            </div>

            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <strong>‚ÑπÔ∏è Saved Workshops</strong><br>
                Select a workshop from your browser storage to continue editing.
            </div>

            <div class="form-group">
                <label for="workshop-search">Search Workshops</label>
                <input type="text" id="workshop-search" placeholder="Search by ID or title..." oninput="filterWorkshops()">
            </div>

            <div class="workshop-browser" id="workshop-browser-list">
                <!-- Workshops will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // API Client Configuration
        // ========================================================================
        
        const API_CONFIG = {
            baseURL: 'http://localhost:3000/api',
            timeout: 10000
        };

        // Current Git branch
        let currentBranch = '';
        let useFilesystem = false; // Flag to determine if using filesystem backend

        // ========================================================================
        // API Client Functions
        // ========================================================================

        /**
         * Make API request
         */
        async function apiRequest(endpoint, options = {}) {
            try {
                const url = `${API_CONFIG.baseURL}${endpoint}`;
                const config = {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                };

                const response = await fetch(url, config);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `API request failed: ${response.status}`);
                }

                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        /**
         * Check if server is available
         */
        async function checkServerAvailability() {
            try {
                await apiRequest('/health');
                return true;
            } catch (error) {
                return false;
            }
        }

        /**
         * Show notification message
         */
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '10000';
            notification.style.minWidth = '300px';
            notification.style.maxWidth = '500px';
            notification.style.animation = 'slideIn 0.3s ease-out';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        /**
         * Initialize Git (create branch if on main)
         */
        async function initGit() {
            try {
                const result = await apiRequest('/git/init');
                currentBranch = result.branch;
                updateBranchDisplay(result.branch, result.created);
                return result;
            } catch (error) {
                console.error('Failed to initialize Git:', error);
                throw error;
            }
        }

        /**
         * Load workshops from filesystem
         */
        async function loadWorkshopsFromFilesystem() {
            try {
                const result = await apiRequest('/workshops');
                return result.workshops;
            } catch (error) {
                console.error('Failed to load workshops:', error);
                throw error;
            }
        }

        /**
         * Load specific workshop from filesystem
         */
        async function loadWorkshopFromFilesystem(workshopId) {
            try {
                const result = await apiRequest(`/workshops/${workshopId}`);
                return result.workshop;
            } catch (error) {
                console.error(`Failed to load workshop ${workshopId}:`, error);
                throw error;
            }
        }

        /**
         * Save workshop to filesystem
         */
        async function saveWorkshopToFilesystem(workshopId, workshopData) {
            try {
                const endpoint = `/workshops/${workshopId}`;
                const result = await apiRequest(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(workshopData)
                });
                return result.workshop;
            } catch (error) {
                console.error('Failed to save workshop:', error);
                throw error;
            }
        }

        /**
         * Create new workshop in filesystem
         */
        async function createWorkshopInFilesystem(workshopData) {
            try {
                const result = await apiRequest('/workshops', {
                    method: 'POST',
                    body: JSON.stringify(workshopData)
                });
                return result.workshop;
            } catch (error) {
                console.error('Failed to create workshop:', error);
                throw error;
            }
        }

        /**
         * Commit changes
         */
        async function commitChanges(files, message) {
            try {
                const result = await apiRequest('/git/commit', {
                    method: 'POST',
                    body: JSON.stringify({ files, message })
                });
                return result;
            } catch (error) {
                console.error('Failed to commit changes:', error);
                throw error;
            }
        }

        /**
         * Generate module directories with navigation
         */
        async function generateModuleStructure() {
            // Check if workshop is loaded and has modules
            if (!workshop.workshopId) {
                showNotification('‚ö†Ô∏è Please load or create a workshop first', 'error');
                return;
            }
            
            if (!workshop.modules || workshop.modules.length === 0) {
                showNotification('‚ö†Ô∏è Please add modules to the workshop first', 'error');
                return;
            }
            
            // Confirm action
            const confirmed = confirm(
                `This will create ${workshop.modules.length} module directories with protected navigation headers and footers.\n\n` +
                `Each module will have:\n` +
                `‚Ä¢ Auto-generated navigation header (DO NOT EDIT)\n` +
                `‚Ä¢ Editable content section\n` +
                `‚Ä¢ Auto-generated navigation footer (DO NOT EDIT)\n\n` +
                `Continue?`
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                showNotification('üóÇÔ∏è Generating module directories...', 'info');
                
                // Call API to generate modules
                const result = await apiRequest(`/workshops/${workshop.workshopId}/generate-modules`, {
                    method: 'POST'
                });
                
                if (result.success) {
                    showNotification(
                        `‚úÖ Successfully created ${result.modules.length} module directories with navigation!`,
                        'success'
                    );
                    
                    // Ask if user wants to commit
                    const shouldCommit = confirm('Module structure created! Do you want to commit these changes to Git?');
                    if (shouldCommit) {
                        const commitMessage = prompt(
                            'Enter commit message:',
                            `Add module structure with navigation for ${workshop.title}`
                        );
                        if (commitMessage) {
                            // Prepare list of files to commit
                            const filesToCommit = [
                                `workshops/${workshop.workshopId}/README.md`
                            ];
                            
                            // Add each module's README
                            result.modules.forEach(module => {
                                filesToCommit.push(`workshops/${workshop.workshopId}/${module.folderName}/README.md`);
                            });
                            
                            await commitChanges(filesToCommit, commitMessage);
                            showNotification('‚úÖ Module structure created and committed!', 'success');
                        } else {
                            showNotification('‚úÖ Module structure created (not committed)', 'success');
                        }
                    } else {
                        showNotification('‚úÖ Module structure created (not committed)', 'success');
                    }
                    
                    // Show details
                    console.log('Created modules:', result.modules);
                    
                    // Update navigation preview
                    renderNavigation();
                } else {
                    showNotification(`‚ùå Failed to generate modules: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Generate modules error:', error);
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        /**
         * Update branch display in header (no longer shows branch in subtitle)
         */
        function updateBranchDisplay(branch, wasCreated = false) {
            const header = document.getElementById('header-subtitle');
            // Branch is now shown in the top-right selector, so just show the description
            header.innerHTML = `Create and manage Redis workshops with visual tools - No command line required!`;
            
            // Check GitHub PR status
            checkGitHubStatus();
        }

        /**
         * Check GitHub status and show/hide PR button
         */
        async function checkGitHubStatus() {
            try {
                // Get current branch - API returns { success: true, branch: "branch-name" }
                const branchResponse = await apiRequest('/git/branch/current');
                const currentBranch = branchResponse.branch;
                console.log('üìç Current branch:', currentBranch);
                
                // Show PR button on any branch except main/master
                if (currentBranch && currentBranch !== 'main' && currentBranch !== 'master') {
                    const prSection = document.getElementById('github-pr-section');
                    if (prSection) {
                        prSection.style.display = 'flex';
                        console.log('‚úÖ PR button shown for branch:', currentBranch);
                    } else {
                        console.error('‚ùå PR section not found in DOM');
                    }
                    
                    // Try to get GitHub status for existing PR info
                    try {
                        const status = await apiRequest('/github/status');
                        const buttonText = document.getElementById('pr-button-text');
                        const prStatus = document.getElementById('pr-status');
                        
                        if (status.existingPR) {
                            buttonText.textContent = 'üìã View Pull Request';
                            prStatus.innerHTML = `<a href="${status.existingPR.url}" target="_blank" style="color: var(--success-color);">PR #${status.existingPR.number} exists</a>`;
                            console.log('üìã Existing PR found:', status.existingPR.number);
                        } else {
                            buttonText.textContent = 'üöÄ Create Pull Request';
                            prStatus.textContent = '';
                            console.log('üöÄ No existing PR, ready to create');
                        }
                    } catch (ghError) {
                        // GitHub not configured, but still show the button
                        console.log('‚ÑπÔ∏è GitHub status not available:', ghError.message);
                    }
                } else {
                    // Hide PR button on main/master
                    console.log('‚ÑπÔ∏è Hiding PR button (on main/master)');
                    document.getElementById('github-pr-section').style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to check branch status:', error);
                // Don't hide the button on error - let user try anyway
                const prSection = document.getElementById('github-pr-section');
                if (prSection) {
                    prSection.style.display = 'flex';
                    console.log('‚ö†Ô∏è Showing PR button despite error');
                }
            }
        }

        /**
         * Load branches from Git and populate the branch selector
         */
        async function loadBranches() {
            try {
                const response = await apiRequest('/git/branches');
                
                // API returns { success: true, current, all, branches }
                // where 'all' is an array of branch names (includes remote branches)
                const allBranches = response.all || [];
                const currentBranch = response.current;
                
                // Filter to only show LOCAL branches (exclude remotes/*)
                const localBranches = allBranches.filter(branch => !branch.startsWith('remotes/'));
                
                const branchSelector = document.getElementById('branch-selector');
                branchSelector.innerHTML = '';
                
                localBranches.forEach(branchName => {
                    const option = document.createElement('option');
                    option.value = branchName;
                    option.textContent = branchName + (branchName === currentBranch ? ' (current)' : '');
                    option.selected = branchName === currentBranch;
                    branchSelector.appendChild(option);
                });
                
                // Show branch section if we have branches
                if (localBranches.length > 0) {
                    document.getElementById('branch-section').style.display = 'flex';
                }
                
                console.log('Loaded local branches:', localBranches.length);
            } catch (error) {
                console.error('Failed to load branches:', error);
                document.getElementById('branch-selector').innerHTML = '<option>Error loading branches</option>';
            }
        }

        /**
         * Switch to the selected branch
         */
        async function switchBranch() {
            const branchSelector = document.getElementById('branch-selector');
            const selectedBranch = branchSelector.value;
            
            if (!selectedBranch) return;
            
            if (!confirm(`Switch to branch "${selectedBranch}"? Any unsaved changes will be lost.`)) {
                // Reset selection to current branch
                await loadBranches();
                return;
            }
            
            try {
                showNotification('Switching branches...', 'info');
                
                const result = await apiRequest('/git/branch/switch', {
                    method: 'POST',
                    body: JSON.stringify({ branchName: selectedBranch })
                });
                
                showNotification(`Switched to branch "${selectedBranch}"`, 'success');
                
                // Reload the page to reflect the new branch state
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } catch (error) {
                console.error('Failed to switch branch:', error);
                showNotification('Failed to switch branch: ' + error.message, 'error');
                // Reset selection
                await loadBranches();
            }
        }

        /**
         * Show the create branch modal
         */
        function showCreateBranchModal() {
            document.getElementById('new-branch-name').value = '';
            document.getElementById('create-branch-modal').classList.add('active');
        }

        /**
         * Close the create branch modal
         */
        function closeCreateBranchModal() {
            document.getElementById('create-branch-modal').classList.remove('active');
        }

        /**
         * Create a new branch
         */
        async function createNewBranch() {
            const branchName = document.getElementById('new-branch-name').value.trim();
            
            if (!branchName) {
                showNotification('Please enter a branch name', 'error');
                return;
            }
            
            // Validate branch name format
            if (!/^[a-z0-9-_\/]+$/.test(branchName)) {
                showNotification('Branch name can only contain lowercase letters, numbers, hyphens, underscores, and slashes', 'error');
                return;
            }
            
            try {
                showNotification('Creating branch...', 'info');
                
                const result = await apiRequest('/git/branch/create', {
                    method: 'POST',
                    body: JSON.stringify({ branchName })
                });
                
                closeCreateBranchModal();
                showNotification(`Created and switched to branch "${branchName}"`, 'success');
                
                // Reload branches and page
                await loadBranches();
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } catch (error) {
                console.error('Failed to create branch:', error);
                showNotification('Failed to create branch: ' + error.message, 'error');
            }
        }

        /**
         * Show the create PR modal with workshop summary
         */
        async function showCreatePRModal() {
            try {
                // Get current branch - API returns { success: true, branch: "branch-name" }
                const branchResponse = await apiRequest('/git/branch/current');
                const currentBranch = branchResponse.branch;
                
                // Check if we have a workshop loaded
                const workshop = window.currentWorkshop;
                let summaryHTML = `<p><strong>Branch:</strong> ${currentBranch}</p>`;
                
                if (workshop) {
                    const moduleCount = workshop.modules ? workshop.modules.length : 0;
                    summaryHTML += `
                        <p><strong>Workshop:</strong> ${workshop.title || 'Untitled'}</p>
                        <p><strong>Description:</strong> ${workshop.description || 'No description'}</p>
                        <p><strong>Modules:</strong> ${moduleCount}</p>
                    `;
                    
                    // Pre-fill title
                    document.getElementById('pr-title').value = `Update: ${workshop.title || currentBranch}`;
                    
                    // Pre-fill description
                    let description = `## Workshop Changes\n\n`;
                    description += `**Workshop:** ${workshop.title || 'Untitled'}\n`;
                    description += `**Description:** ${workshop.description || 'No description'}\n`;
                    description += `**Modules:** ${moduleCount}\n\n`;
                    
                    if (moduleCount > 0) {
                        description += `### Modules Included:\n`;
                        workshop.modules.forEach((mod, idx) => {
                            description += `${idx + 1}. ${mod.title || mod.moduleRef}\n`;
                        });
                    }
                    
                    document.getElementById('pr-description').value = description;
                } else {
                    summaryHTML += `<p><em>No workshop currently loaded</em></p>`;
                    document.getElementById('pr-title').value = `Update: ${currentBranch}`;
                    document.getElementById('pr-description').value = `Changes made in branch ${currentBranch}`;
                }
                
                document.getElementById('pr-summary-content').innerHTML = summaryHTML;
                document.getElementById('create-pr-modal').classList.add('active');
            } catch (error) {
                console.error('Failed to prepare PR modal:', error);
                showNotification('Failed to open PR modal: ' + error.message, 'error');
            }
        }

        /**
         * Close the create PR modal
         */
        function closeCreatePRModal() {
            document.getElementById('create-pr-modal').classList.remove('active');
        }

        /**
         * Confirm and create the pull request
         */
        async function confirmCreatePR() {
            const title = document.getElementById('pr-title').value.trim();
            const body = document.getElementById('pr-description').value.trim();
            
            if (!title) {
                showNotification('Please enter a PR title', 'error');
                return;
            }
            
            try {
                showNotification('Creating pull request...', 'info');
                
                const result = await apiRequest('/github/pull-request', {
                    method: 'POST',
                    body: JSON.stringify({ title, body })
                });
                
                closeCreatePRModal();
                
                if (result.url) {
                    showNotification('Pull request created successfully!', 'success');
                    
                    // Ask if user wants to open the PR
                    if (confirm('Pull request created! Would you like to open it in your browser?')) {
                        window.open(result.url, '_blank');
                    }
                    
                    // Refresh GitHub status
                    await checkGitHubStatus();
                } else {
                    showNotification('Pull request created!', 'success');
                }
            } catch (error) {
                console.error('Failed to create PR:', error);
                showNotification('Failed to create PR: ' + error.message, 'error');
            }
        }

        /**
         * Open GitHub Pages for the repository
         */
        async function openGitHubPages() {
            try {
                // Try to get GitHub status which includes repository info
                const status = await apiRequest('/github/status');
                
                if (status.repoOwner && status.repoName) {
                    const pagesUrl = `https://${status.repoOwner}.github.io/${status.repoName}/`;
                    window.open(pagesUrl, '_blank');
                } else {
                    // Fallback: ask user for the URL
                    const url = prompt('Enter your GitHub Pages URL:');
                    if (url) {
                        window.open(url, '_blank');
                    }
                }
            } catch (error) {
                console.error('Failed to open GitHub Pages:', error);
                // Fallback: ask user for the URL
                const url = prompt('Enter your GitHub Pages URL:');
                if (url) {
                    window.open(url, '_blank');
                }
            }
        }

        /**
         * Create or view Pull Request
         */
        async function createPullRequest() {
            try {
                // Check status first
                const status = await apiRequest('/github/status');
                
                // If PR already exists, open it
                if (status.existingPR) {
                    window.open(status.existingPR.url, '_blank');
                    return;
                }
                
                // Get PR details from user
                const title = prompt('Enter Pull Request title:', `Workshop updates from ${status.currentBranch}`);
                if (!title) {
                    return; // User cancelled
                }
                
                const body = prompt('Enter PR description (optional):', 
                    'This PR contains workshop updates made through the Workshop Builder GUI.');
                
                showNotification('üöÄ Creating Pull Request...', 'info');
                
                // Create PR
                const result = await apiRequest('/github/pull-request', {
                    method: 'POST',
                    body: JSON.stringify({
                        title,
                        body: body || undefined
                    })
                });
                
                if (result.success) {
                    if (result.exists) {
                        showNotification(`‚úÖ Pull Request already exists: PR #${result.number}`, 'success');
                    } else {
                        showNotification(`‚úÖ Pull Request created: PR #${result.number}`, 'success');
                    }
                    
                    // Update button to show "View PR"
                    await checkGitHubStatus();
                    
                    // Open PR in browser
                    if (confirm('Would you like to open the Pull Request in your browser?')) {
                        window.open(result.url, '_blank');
                    }
                } else {
                    showNotification(`‚ùå Failed to create PR: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Create PR error:', error);
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // ========================================================================
        // Workshop State
        // ========================================================================
        
        let workshop = {
            workshopId: '',
            version: '1.0.0',
            title: '',
            description: '',
            duration: '',
            difficulty: 'intermediate',
            author: '',
            modules: [],
            prerequisites: [],
            learningObjectives: []
        };

        // Available modules (in a real app, this would be fetched from the server)
        // Available modules - loaded dynamically from API
        const availableModules = [];

        // Load available modules from the API
        async function loadAvailableModules() {
            try {
                console.log('üì¶ Loading available modules...');
                const response = await apiRequest('/modules/all');
                const modules = response.modules || response;
                
                if (!modules || modules.length === 0) {
                    console.warn('No modules found from API');
                    return;
                }
                
                // Clear existing modules
                availableModules.length = 0;
                
                // Filter out test modules and transform to workshop module format
                modules.forEach(module => {
                    // Skip test modules (workshop or module names starting with 'test-')
                    if (module.workshopId?.startsWith('test-') || 
                        module.moduleDir?.startsWith('test-')) {
                        return;
                    }
                    
                    availableModules.push({
                        name: module.title || module.moduleDir,
                        title: module.title,
                        description: module.description || `Module from ${module.workshopId}`,
                        duration: module.duration || 60,
                        difficulty: module.difficulty || 'intermediate',
                        type: module.type || 'hands-on',
                        moduleRef: module.modulePath,
                        workshopId: module.workshopId,
                        moduleDir: module.moduleDir,
                        modulePath: module.modulePath,
                        childrenCount: module.childrenCount || 0,
                        inheritance: module.inheritance,
                        tags: [module.workshopId, module.moduleDir]
                    });
                });
                
                console.log(`‚úÖ Loaded ${availableModules.length} available modules (test modules filtered out)`);
                showNotification(`Loaded ${availableModules.length} available modules`, 'success');
            } catch (error) {
                console.error('Failed to load available modules:', error);
                showNotification('Warning: Could not load available modules', 'warning');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if server is available
            const serverAvailable = await checkServerAvailability();
            
            if (serverAvailable) {
                useFilesystem = true;
                console.log('‚úÖ Server available - using filesystem mode');
                
                try {
                    // Initialize Git
                    const gitResult = await initGit();
                    console.log('Git initialized:', gitResult);
                    
                    // Load branches and show branch selector
                    await loadBranches();
                    
                    // Load available modules from API
                    await loadAvailableModules();
                    
                    // Show GitHub Pages button
                    const ghPagesSection = document.getElementById('gh-pages-section');
                    if (ghPagesSection) {
                        ghPagesSection.style.display = 'flex';
                        console.log('‚úÖ GitHub Pages button shown');
                    }
                    
                    // Check GitHub status and show PR button if applicable
                    await checkGitHubStatus();
                    
                    // Show success notification
                    showNotification(
                        gitResult.created 
                            ? `Created new branch: ${gitResult.branch}` 
                            : `Working on branch: ${gitResult.branch}`,
                        'success'
                    );
                } catch (error) {
                    console.error('Git initialization failed:', error);
                    showNotification('Warning: Git initialization failed. Changes won\'t be committed automatically.', 'warning');
                    useFilesystem = false;
                }
            } else {
                useFilesystem = false;
                console.log('‚ÑπÔ∏è Server not available - using localStorage mode');
                showNotification('Server not available. Working in browser-only mode. Start server for filesystem integration.', 'info');
            }
            
            updateSummary();
            renderModules();
        });

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Update specific tab content
            if (tabName === 'navigation') {
                renderNavigation();
            } else if (tabName === 'module-manager') {
                // Ensure Browse Modules sub-tab is selected and load modules
                initializeModuleManager();
            }
        }
        
        // Initialize Module Manager tab
        function initializeModuleManager() {
            // Ensure Browse tab is active
            const browseTabs = document.querySelectorAll('#module-manager-tab .tabs .tab');
            browseTabs.forEach(tab => tab.classList.remove('active'));
            browseTabs[0]?.classList.add('active'); // First tab is Browse
            
            // Show browse tab content
            const subTabs = ['mm-browse-tab', 'mm-duplicates-tab', 'mm-link-tab'];
            subTabs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });
            document.getElementById('mm-browse-tab')?.classList.add('active');
            
            // Load top-level modules
            loadModuleBrowser();
        }

        // ========================================================================
        // Module Manager Functions - Hierarchical Navigation
        // ========================================================================

        // ========================================================================
        // File Browser Functions (New Implementation)
        // ========================================================================
        let browserData = { workshops: {}, allModules: [], filteredModules: [] };

        async function loadModuleBrowser() {
            try {
                const showTest = document.getElementById('show-test-modules').checked;
                const response = await apiRequest('/modules/all');
                const modules = response.modules || response;
                
                if (!modules || modules.length === 0) {
                    document.getElementById('module-browser').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><h3>No Modules Found</h3></div>';
                    updateBrowserStats([], 0, 0, 0);
                    return;
                }

                browserData.allModules = showTest ? modules : modules.filter(m => !m.workshopId.startsWith('test-'));
                browserData.filteredModules = [...browserData.allModules];
                browserData.workshops = {};
                browserData.allModules.forEach(module => {
                    if (!browserData.workshops[module.workshopId]) {
                        browserData.workshops[module.workshopId] = { id: module.workshopId, modules: [], expanded: false };
                    }
                    browserData.workshops[module.workshopId].modules.push(module);
                });

                const parents = browserData.allModules.filter(m => m.childrenCount > 0).length;
                const maxDepth = calculateMaxDepth(browserData.allModules);
                updateBrowserStats(browserData.allModules, Object.keys(browserData.workshops).length, parents, maxDepth);
                renderFileBrowser();
                showNotification(`Loaded ${browserData.allModules.length} modules from ${Object.keys(browserData.workshops).length} workshops`, 'success');
            } catch (error) {
                console.error('Failed to load:', error);
                showNotification('Failed to load modules: ' + error.message, 'error');
            }
        }

        function renderFileBrowser() {
            const container = document.getElementById('module-browser');
            if (!container) {
                console.error('module-browser container not found!');
                return;
            }
            const workshops = Object.values(browserData.workshops);
            if (workshops.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ÔøΩÔøΩ</div><h3>No Results</h3></div>';
                return;
            }
            let html = '';
            workshops.forEach(workshop => {
                const expandedClass = workshop.expanded ? 'workshop-expanded' : 'workshop-collapsed';
                const chevron = workshop.expanded ? '‚ñº' : '‚ñ∂';
                html += `<div class="${expandedClass}">
                    <div class="file-browser-item workshop-item" onclick="toggleWorkshop('${workshop.id}')">
                        <span class="item-chevron">${chevron}</span>
                        <span class="item-icon">üìÅ</span>
                        <span class="item-label">${workshop.id}</span>
                        <span class="item-badge">${workshop.modules.length} module${workshop.modules.length !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="workshop-modules">${renderWorkshopModules(workshop.modules)}</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function renderWorkshopModules(modules) {
            let html = '';
            // Get modules that don't have a parent (top-level/root modules)
            let topLevel = modules.filter(m => !m.inheritance || !m.inheritance.parentPath);
            
            // If no top-level modules (all are children), show all modules at root level
            // This handles workshops that only reference modules from other workshops
            if (topLevel.length === 0) {
                topLevel = modules;
            }
            
            topLevel.forEach(module => { html += renderModuleItem(module, modules, 'module-item', true); });
            return html;
        }

        function renderModuleItem(module, allModules, cssClass, isTopLevel = false) {
            const hasChildren = module.childrenCount > 0;
            const icon = hasChildren ? 'üìÇ' : 'üìÑ';
            const badges = [];
            
            // Add parent badge
            if (hasChildren) {
                badges.push(`<span class="item-badge parent">${module.childrenCount} child${module.childrenCount !== 1 ? 'ren' : ''}</span>`);
            }
            
            // Add child status badges (4 states)
            if (module.inheritance && module.inheritance.parentPath) {
                // State 4: Child - Customized
                if (module.inheritance.customized) {
                    badges.push(`<span class="item-badge child-customized" title="Customized from parent">‚úèÔ∏è Customized</span>`);
                } 
                // State 3: Child - Out of Sync (has syncStatus from backend)
                else if (module.syncStatus === 'out-of-sync') {
                    badges.push(`<span class="item-badge child-out-of-sync" title="Parent has been updated">‚ö†Ô∏è Out of Sync</span>`);
                } 
                // State 2: Child - In Sync
                else if (module.syncStatus === 'in-sync') {
                    badges.push(`<span class="item-badge child-in-sync" title="In sync with parent">‚úÖ In Sync</span>`);
                }
                // Fallback: Just show "Child" if sync status unknown
                else {
                    badges.push(`<span class="item-badge child" title="Inherited from parent">üë∂ Child</span>`);
                }
            }
            // State 1: No Child (no parent) - no badge needed, this is the default
            
            // Escape module path for onclick
            const escapedPath = module.modulePath.replace(/'/g, "\\'");
            const escapedTitle = (module.title || module.moduleDir).replace(/'/g, "\\'");
            
            // Generate unique ID for this module
            const moduleId = 'module-' + module.modulePath.replace(/[^a-z0-9]/gi, '-');
            
            // Only show chevron for parent modules
            const chevron = hasChildren ? '<span class="item-chevron" style="display: inline-block; width: 1rem; margin-right: 0.25rem;">‚ñ∂</span>' : '<span style="display: inline-block; width: 1rem; margin-right: 0.25rem;"></span>';
            
            let html = `<div class="module-parent-item ${hasChildren ? 'module-collapsed' : ''}" id="${moduleId}">
                <div class="file-browser-item ${cssClass}" title="${module.modulePath}" ${hasChildren ? `onclick="toggleModuleChildren('${moduleId}')" style="cursor: pointer;"` : ''}>
                    <div style="display: flex; align-items: center; flex: 1;">
                        ${chevron}
                        <span class="item-icon">${icon}</span>
                        <span class="item-label">${module.title || module.moduleDir} <span class="module-path">${module.moduleDir}</span></span>
                        ${badges.join('')}
                    </div>
                    <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); customizeModuleFromBrowser('${escapedPath}', '${escapedTitle}');" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                        ‚úèÔ∏è Customize
                    </button>
                </div>`;
            
            // Add children container (initially hidden for top-level parents)
            if (hasChildren && module.children) {
                html += `<div class="module-children" style="display: none;">`;
                module.children.forEach(childRef => {
                    const child = allModules.find(m => m.modulePath === childRef.modulePath);
                    if (child) html += renderModuleItem(child, allModules, 'module-item-child', false);
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            return html;
        }
        
        // Toggle module children visibility
        function toggleModuleChildren(moduleId) {
            const moduleDiv = document.getElementById(moduleId);
            if (!moduleDiv) return;
            
            const childrenDiv = moduleDiv.querySelector('.module-children');
            const chevron = moduleDiv.querySelector('.item-chevron');
            
            if (!childrenDiv) return;
            
            if (childrenDiv.style.display === 'none') {
                childrenDiv.style.display = 'block';
                if (chevron) chevron.textContent = '‚ñº';
                moduleDiv.classList.remove('module-collapsed');
                moduleDiv.classList.add('module-expanded');
            } else {
                childrenDiv.style.display = 'none';
                if (chevron) chevron.textContent = '‚ñ∂';
                moduleDiv.classList.remove('module-expanded');
                moduleDiv.classList.add('module-collapsed');
            }
        }

        // Customize a module from the Module Manager browser
        function customizeModuleFromBrowser(modulePath, moduleTitle) {
            if (!workshop.workshopId) {
                alert('Please set a Workshop ID first before customizing modules');
                return;
            }
            
            // Store the module path for the copy operation
            window._sourceModuleForCopy = {
                moduleRef: modulePath,
                name: moduleTitle
            };
            
            // Pre-fill the custom module form
            document.getElementById('custom-module-name').value = `${moduleTitle} (Custom)`;
            document.getElementById('custom-module-description').value = 'Customized version of ' + moduleTitle;
            document.getElementById('custom-module-duration').value = '60';
            document.getElementById('custom-module-difficulty').value = 'intermediate';
            document.getElementById('custom-module-type').value = 'hands-on';
            
            // Generate a suggested module directory name with sequential numbering
            const nextOrder = workshop.modules.length + 1;
            const baseName = moduleTitle.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            const orderPrefix = `module-${String(nextOrder).padStart(2, '0')}`;
            document.getElementById('custom-module-ref').value = `${orderPrefix}-${baseName}`;
            
            // Show the custom module modal
            document.getElementById('custom-module-modal').classList.add('active');
            
            // Update the alert message
            const alertDiv = document.querySelector('#custom-module-modal .alert');
            if (alertDiv) {
                alertDiv.innerHTML = `
                    <strong>‚úèÔ∏è Customizing Module</strong><br>
                    This will create a <strong>full copy</strong> of "<strong>${moduleTitle}</strong>" 
                    from <code>${modulePath}</code> with all its files and directories.<br><br>
                    All files, subdirectories, and content will be copied to your workshop. 
                    You can then modify the README.md and other files as needed.
                `;
            }
        }

        function toggleWorkshop(workshopId) {
            browserData.workshops[workshopId].expanded = !browserData.workshops[workshopId].expanded;
            renderFileBrowser();
        }

        function expandAllWorkshops() {
            Object.values(browserData.workshops).forEach(w => w.expanded = true);
            renderFileBrowser();
        }

        function collapseAllWorkshops() {
            Object.values(browserData.workshops).forEach(w => w.expanded = false);
            renderFileBrowser();
        }

        function filterModuleBrowser() {
            const searchTerm = document.getElementById('module-manager-search').value.toLowerCase().trim();
            if (!searchTerm) {
                browserData.filteredModules = [...browserData.allModules];
                browserData.workshops = {};
                browserData.filteredModules.forEach(module => {
                    if (!browserData.workshops[module.workshopId]) {
                        browserData.workshops[module.workshopId] = { id: module.workshopId, modules: [], expanded: false };
                    }
                    browserData.workshops[module.workshopId].modules.push(module);
                });
                renderFileBrowser();
                return;
            }
            browserData.filteredModules = browserData.allModules.filter(module => 
                module.title.toLowerCase().includes(searchTerm) ||
                module.moduleDir.toLowerCase().includes(searchTerm) ||
                module.workshopId.toLowerCase().includes(searchTerm) ||
                module.modulePath.toLowerCase().includes(searchTerm) ||
                (module.description && module.description.toLowerCase().includes(searchTerm))
            );
            browserData.workshops = {};
            browserData.filteredModules.forEach(module => {
                if (!browserData.workshops[module.workshopId]) {
                    browserData.workshops[module.workshopId] = { id: module.workshopId, modules: [], expanded: true };
                }
                browserData.workshops[module.workshopId].modules.push(module);
            });
            renderFileBrowser();
        }

        function updateBrowserStats(modules, workshopCount, parentCount, maxDepth) {
            document.getElementById('mm-total-count').textContent = modules.length;
            document.getElementById('mm-workshops-count').textContent = workshopCount;
            document.getElementById('mm-parent-count').textContent = parentCount;
            document.getElementById('mm-depth-count').textContent = maxDepth;
        }

        function calculateMaxDepth(modules) {
            let maxDepth = 0;
            modules.forEach(module => {
                let depth = 0, current = module;
                while (current.inheritance && current.inheritance.parentPath) {
                    depth++;
                    current = modules.find(m => m.modulePath === current.inheritance.parentPath);
                    if (!current || depth > 20) break;
                }
                maxDepth = Math.max(maxDepth, depth);
            });
            return maxDepth;
        }


        // Hierarchical view state
        let hierarchyView = {
            type: 'top-level', // 'top-level' or 'children'
            currentPath: null,
            currentModule: null,
            breadcrumb: [], // Array of {path, title, workshopId, moduleId}
            history: [], // Navigation history
            allModulesData: [],
            currentModules: []
        };

        let allModulesData = [];
        let rootModulesData = [];

        // Switch between Module Manager sub-tabs
        function switchModuleManagerTab(tabName) {
            // Update tab buttons within module manager
            const mmTabs = document.querySelectorAll('#module-manager-tab .tabs .tab');
            mmTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update sub-tab content
            const subTabs = ['mm-browse-tab', 'mm-duplicates-tab', 'mm-link-tab'];
            subTabs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });
            document.getElementById(`mm-${tabName}-tab`).classList.add('active');

            // Load data for specific tabs
            if (tabName === 'browse') {
                loadModuleBrowser(); // Use new file browser function
            } else if (tabName === 'link') {
                populateLinkSelects();
            }
        }

        // Load top-level modules (entry points with no parent)
        async function loadTopLevelModules() {
            try {
                showNotification('Loading modules...', 'info');
                
                const response = await fetch('http://localhost:3000/api/modules/top-level');
                const data = await response.json();
                
                if (data.success) {
                    // Apply test module filter
                    const filteredModules = applyTestFilter(data.modules);
                    
                    hierarchyView.type = 'top-level';
                    hierarchyView.currentPath = null;
                    hierarchyView.currentModule = null;
                    hierarchyView.currentModules = filteredModules;
                    hierarchyView.allModulesData = filteredModules;
                    hierarchyView.breadcrumb = [];
                    
                    // Update view
                    renderHierarchyView();
                    updateBreadcrumb();
                    await updateGlobalStats();
                    
                    const totalCount = data.modules.length;
                    const filteredCount = filteredModules.length;
                    const message = totalCount !== filteredCount ? 
                        `Loaded ${filteredCount} modules (${totalCount - filteredCount} test modules hidden)` :
                        `Loaded ${filteredCount} top-level modules`;
                    
                    showNotification(message, 'success');
                } else {
                    throw new Error(data.error || 'Failed to load modules');
                }
            } catch (error) {
                console.error('Error loading top-level modules:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Load children of a specific module
        async function loadModuleChildren(modulePath, moduleTitle, workshopId, moduleId) {
            try {
                showNotification('Loading children...', 'info');
                
                const response = await fetch(`http://localhost:3000/api/modules/children/${workshopId}/${moduleId}`);
                const data = await response.json();
                
                if (data.success) {
                    // Apply test module filter
                    const filteredChildren = applyTestFilter(data.children);
                    
                    // Save current state to history
                    hierarchyView.history.push({
                        type: hierarchyView.type,
                        path: hierarchyView.currentPath,
                        modules: hierarchyView.currentModules,
                        breadcrumb: [...hierarchyView.breadcrumb]
                    });
                    
                    // Update view state
                    hierarchyView.type = 'children';
                    hierarchyView.currentPath = modulePath;
                    hierarchyView.currentModule = { path: modulePath, title: moduleTitle, workshopId, moduleId };
                    hierarchyView.currentModules = filteredChildren;
                    
                    // Add to breadcrumb
                    hierarchyView.breadcrumb.push({ path: modulePath, title: moduleTitle, workshopId, moduleId });
                    
                    // Update view
                    renderHierarchyView();
                    updateBreadcrumb();
                    
                    const totalCount = data.children.length;
                    const filteredCount = filteredChildren.length;
                    const message = totalCount !== filteredCount ?
                        `Loaded ${filteredCount} children (${totalCount - filteredCount} test modules hidden)` :
                        `Loaded ${filteredCount} children`;
                    
                    showNotification(message, 'success');
                } else {
                    throw new Error(data.error || 'Failed to load children');
                }
            } catch (error) {
                console.error('Error loading children:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Navigate back in hierarchy
        function goBackInHierarchy() {
            if (hierarchyView.history.length === 0) {
                loadModuleBrowser();
                return;
            }
            
            const previousState = hierarchyView.history.pop();
            hierarchyView.type = previousState.type;
            hierarchyView.currentPath = previousState.path;
            hierarchyView.currentModules = previousState.modules;
            hierarchyView.breadcrumb = previousState.breadcrumb;
            
            if (previousState.path) {
                const parts = previousState.path.split('/');
                hierarchyView.currentModule = {
                    path: previousState.path,
                    workshopId: parts[1],
                    moduleId: parts[2]
                };
            } else {
                hierarchyView.currentModule = null;
            }
            
            renderHierarchyView();
            updateBreadcrumb();
        }

        // Navigate to specific breadcrumb level
        async function navigateToBreadcrumb(index) {
            if (index < 0) {
                // Navigate to top level
                await loadModuleBrowser();
                return;
            }
            
            // Navigate back to specific ancestor
            while (hierarchyView.breadcrumb.length > index + 1) {
                goBackInHierarchy();
            }
        }

        // Render hierarchical view (top-level or children)
        function renderHierarchyView() {
            const container = document.getElementById('modules-list');
            const modules = hierarchyView.currentModules;
            
            // Update view title and description
            if (hierarchyView.type === 'top-level') {
                document.getElementById('view-icon').textContent = 'üì¶';
                document.getElementById('view-title-text').textContent = 'Top-Level Modules';
                document.getElementById('view-description').textContent = 'These modules have no parent and can be used as starting points in the hierarchy.';
                document.getElementById('back-button').style.display = 'none';
            } else {
                document.getElementById('view-icon').textContent = 'üë∂';
                document.getElementById('view-title-text').textContent = `Children of ${hierarchyView.currentModule?.title || 'Module'}`;
                document.getElementById('view-description').textContent = `Modules that inherit from this parent. Click any module to drill deeper.`;
                document.getElementById('back-button').style.display = 'inline-block';
            }
            
            document.getElementById('view-count').textContent = modules.length;
            
            if (!modules || modules.length === 0) {
                const emptyMessage = hierarchyView.type === 'top-level' ? 
                    'No top-level modules found. All modules have parents.' : 
                    'This module has no children yet.';
                
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">${hierarchyView.type === 'top-level' ? 'üì¶' : 'üë∂'}</div>
                        <h3>No Modules Here</h3>
                        <p>${emptyMessage}</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
            
            modules.forEach(module => {
                const hasChildren = (module.childCount || 0) > 0;
                const hasParent = module.inheritance?.parentPath;
                const depth = module.level || hierarchyView.breadcrumb.length;
                
                // Determine color based on status
                let borderColor = 'var(--border-color)';
                if (hasChildren && hasParent) {
                    borderColor = 'var(--warning-color)'; // Middle node - orange
                } else if (hasChildren) {
                    borderColor = 'var(--success-color)'; // Parent node - green
                } else if (hasParent) {
                    borderColor = 'var(--info-color)'; // Leaf node - blue
                }
                
                html += `
                    <div class="module-card" style="border-left: 4px solid ${borderColor};">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">${hasChildren ? 'üìÅ' : 'üìÑ'}</span>
                                    <strong style="font-size: 1.1rem;">${module.title}</strong>
                                    ${depth > 0 ? `<span class="badge" style="background: var(--text-light); color: white;">Level ${depth}</span>` : ''}
                                    ${hasChildren && hasParent ? `<span class="badge" style="background: var(--warning-color); color: white;">Middle Node</span>` : ''}
                                    ${hasChildren && !hasParent ? `<span class="badge" style="background: var(--success-color); color: white;">Parent</span>` : ''}
                                    ${!hasChildren && hasParent ? `<span class="badge" style="background: var(--info-color); color: white;">Leaf</span>` : ''}
                                </div>
                                <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    üìÅ ${module.workshopId} / ${module.moduleDir}
                                </div>
                                ${module.description ? `<p style="margin: 0.5rem 0; color: var(--text-color);">${module.description}</p>` : ''}
                                ${module.duration ? `<p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">‚è±Ô∏è ${module.duration}</p>` : ''}
                                ${hasChildren ? `
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-light); border-radius: 4px; font-size: 0.875rem;">
                                        ÔøΩ <strong>${module.directChildCount || 0}</strong> direct children, 
                                        <strong>${module.childCount || 0}</strong> total descendants
                                    </div>
                                ` : ''}
                                ${module.inheritance?.parentPath ? `
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-light); border-radius: 4px; font-size: 0.875rem;">
                                        ÔøΩ Parent: <code style="font-size: 0.8rem;">${module.inheritance.parentPath}</code>
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${hasChildren ? `
                                    <button class="btn btn-sm btn-primary" onclick="loadModuleChildren('${module.modulePath}', '${module.title}', '${module.workshopId}', '${module.moduleDir}')" title="View ${module.directChildCount} children">
                                        üëÅÔ∏è View Children
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Update breadcrumb navigation
        function updateBreadcrumb() {
            const breadcrumbContainer = document.getElementById('hierarchy-breadcrumb');
            const breadcrumbItems = document.getElementById('breadcrumb-items');
            
            if (hierarchyView.type === 'top-level' || hierarchyView.breadcrumb.length === 0) {
                breadcrumbContainer.style.display = 'none';
                return;
            }
            
            breadcrumbContainer.style.display = 'block';
            
            let html = `
                <button class="btn btn-sm btn-outline" onclick="navigateToBreadcrumb(-1)" style="padding: 0.25rem 0.75rem;">
                    üè† Top Level
                </button>
                <span style="color: var(--text-light);">‚Ä∫</span>
            `;
            
            hierarchyView.breadcrumb.forEach((item, index) => {
                const isLast = index === hierarchyView.breadcrumb.length - 1;
                
                if (isLast) {
                    html += `<span style="font-weight: 600; color: var(--primary-color);">${item.title}</span>`;
                } else {
                    html += `
                        <button class="btn btn-sm btn-outline" onclick="navigateToBreadcrumb(${index})" style="padding: 0.25rem 0.75rem;">
                            ${item.title}
                        </button>
                        <span style="color: var(--text-light);">‚Ä∫</span>
                    `;
                }
            });
            
            breadcrumbItems.innerHTML = html;
        }

        // Update global statistics (fetch from all modules)
        async function updateGlobalStats() {
            try {
                const response = await fetch('http://localhost:3000/api/modules/all');
                const data = await response.json();
                
                if (data.success) {
                    const modules = data.modules;
                    const total = modules.length;
                    const parents = modules.filter(m => m.childrenCount > 0).length;
                    const children = modules.filter(m => m.inheritance?.parentPath).length;
                    
                    // Calculate max depth
                    let maxDepth = 0;
                    for (const module of modules) {
                        if (module.inheritance?.parentPath) {
                            try {
                                const depthResponse = await fetch(`http://localhost:3000/api/modules/ancestors/${module.workshopId}/${module.moduleDir}`);
                                const depthData = await depthResponse.json();
                                if (depthData.success && depthData.depth > maxDepth) {
                                    maxDepth = depthData.depth;
                                }
                            } catch (err) {
                                console.error('Error fetching depth:', err);
                            }
                        }
                    }
                    
                    document.getElementById('mm-total-count').textContent = total;
                    document.getElementById('mm-parent-count').textContent = parents;
                    document.getElementById('mm-child-count').textContent = children;
                    document.getElementById('mm-depth-count').textContent = maxDepth || '-';
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Filter modules in current view
        function filterModules() {
            const searchTerm = document.getElementById('modules-search').value.toLowerCase();
            
            if (!searchTerm) {
                hierarchyView.currentModules = hierarchyView.allModulesData;
                renderHierarchyView();
                return;
            }
            
            const filtered = hierarchyView.currentModules.filter(module => 
                module.title.toLowerCase().includes(searchTerm) ||
                module.moduleDir.toLowerCase().includes(searchTerm) ||
                module.workshopId.toLowerCase().includes(searchTerm) ||
                (module.description && module.description.toLowerCase().includes(searchTerm))
            );
            
            // Temporarily update view with filtered results
            const originalModules = hierarchyView.currentModules;
            hierarchyView.currentModules = filtered;
            renderHierarchyView();
            hierarchyView.currentModules = originalModules;
        }

        // Toggle test modules visibility
        function toggleTestModules() {
            loadModuleBrowser(); // Reload with filter applied
        }

        // Check if module is a test module
        function isTestModule(module) {
            return module.workshopId?.startsWith('test-') || 
                   module.moduleDir?.startsWith('test-') ||
                   module.title?.toLowerCase().includes('test');
        }

        // Filter modules based on test mode checkbox
        function applyTestFilter(modules) {
            const showTestModules = document.getElementById('show-test-modules')?.checked ?? true;
            
            if (showTestModules) {
                return modules; // Show all
            }
            
            return modules.filter(m => !isTestModule(m));
        }

        // Toggle tree view
        function toggleTreeView() {
            const modal = document.getElementById('tree-view-modal');
            modal.style.display = 'block';
            generateTreeView();
        }

        // Close tree view
        function closeTreeView(event) {
            if (!event || event.target.id === 'tree-view-modal') {
                document.getElementById('tree-view-modal').style.display = 'none';
            }
        }

        // Generate ASCII tree view
        async function generateTreeView() {
            const content = document.getElementById('tree-view-content');
            content.textContent = 'Loading tree structure...';
            
            try {
                // Fetch all modules
                const response = await fetch('http://localhost:3000/api/modules/all');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to load modules');
                }
                
                let modules = data.modules;
                
                // Apply test filter
                modules = applyTestFilter(modules);
                
                // Build tree structure
                const tree = buildTree(modules);
                const treeText = renderTree(tree);
                
                content.textContent = treeText;
            } catch (error) {
                content.textContent = `Error loading tree: ${error.message}`;
            }
        }

        // Build tree structure from flat module list
        function buildTree(modules) {
            // Find top-level modules
            const topLevel = modules.filter(m => !m.inheritance?.parentPath);
            
            // Recursive function to build tree
            function addChildren(node, modules) {
                const children = modules.filter(m => 
                    m.inheritance?.parentPath === node.modulePath
                );
                
                if (children.length > 0) {
                    node.children = children.map(child => {
                        const childNode = { ...child };
                        addChildren(childNode, modules);
                        return childNode;
                    });
                }
                
                return node;
            }
            
            return topLevel.map(root => addChildren({ ...root }, modules));
        }

        // Render tree as ASCII art
        function renderTree(nodes, prefix = '', isLast = true) {
            let output = '';
            
            nodes.forEach((node, index) => {
                const isLastNode = index === nodes.length - 1;
                const connector = isLastNode ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ';
                const childPrefix = prefix + (isLastNode ? '    ' : '‚îÇ   ');
                
                // Node info
                const hasChildren = (node.children?.length || 0) > 0;
                const icon = hasChildren ? 'üìÅ' : 'üìÑ';
                const childCount = hasChildren ? ` (${node.children.length} children)` : '';
                const testBadge = isTestModule(node) ? ' [TEST]' : '';
                
                output += `${prefix}${connector}${icon} ${node.title}${testBadge}${childCount}\n`;
                output += `${childPrefix}   üìÅ ${node.workshopId}/${node.moduleDir}\n`;
                
                if (node.inheritance?.parentPath) {
                    output += `${childPrefix}   üîó Parent: ${node.inheritance.parentPath}\n`;
                }
                
                // Recursively render children
                if (hasChildren) {
                    output += renderTree(node.children, childPrefix, isLastNode);
                }
            });
            
            return output;
        }

        // Load root modules
        async function loadRootModules() {
            try {
                showNotification('Loading root modules...', 'info');
                
                const response = await fetch('http://localhost:3000/api/modules/roots');
                const data = await response.json();
                
                if (data.success) {
                    rootModulesData = data.modules;
                    renderRootModules(rootModulesData);
                    showNotification(`Found ${data.count} root modules`, 'success');
                } else {
                    throw new Error(data.error || 'Failed to load root modules');
                }
            } catch (error) {
                console.error('Error loading root modules:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Render root modules
        function renderRootModules(modules) {
            const container = document.getElementById('root-modules-list');
            
            if (!modules || modules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üå≥</div>
                        <h3>No Root Modules Yet</h3>
                        <p>Root modules are created when you link modules together</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
            
            modules.forEach(module => {
                const childCount = module.inheritance?.usedBy?.length || 0;
                
                html += `
                    <div class="module-card" style="border-left: 4px solid var(--success-color);">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">üå≥</span>
                                    <strong style="font-size: 1.1rem;">${module.title}</strong>
                                    <span class="badge" style="background: var(--success-color); color: white;">
                                        Root Module
                                    </span>
                                </div>
                                <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    üìÅ ${module.workshopId} / ${module.moduleDir}
                                </div>
                                ${module.description ? `<p style="margin: 0.5rem 0;">${module.description}</p>` : ''}
                                ${childCount > 0 ? `
                                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 4px;">
                                        <strong>üë∂ Used by ${childCount} module(s):</strong>
                                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                            ${module.inheritance.usedBy.map(child => `
                                                <li style="margin: 0.25rem 0;">
                                                    <code>${child.workshop}</code> ‚Üí <code>${child.modulePath}</code>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : `
                                    <div style="margin-top: 1rem; padding: 0.5rem; background: var(--bg-light); border-radius: 4px; color: var(--text-light);">
                                        No child modules yet
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Find duplicate modules
        async function findDuplicateModules() {
            try {
                showNotification('Scanning for duplicates...', 'info');
                
                const response = await fetch('http://localhost:3000/api/modules/similar');
                const data = await response.json();
                
                if (data.success) {
                    renderDuplicates(data.groups);
                    showNotification(`Found ${data.count} duplicate group(s)`, data.count > 0 ? 'warning' : 'success');
                } else {
                    throw new Error(data.error || 'Failed to find duplicates');
                }
            } catch (error) {
                console.error('Error finding duplicates:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Render duplicate groups
        function renderDuplicates(groups) {
            const container = document.getElementById('duplicates-list');
            
            if (!groups || groups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <h3>No Duplicates Found</h3>
                        <p>All modules have unique names</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 1.5rem;">';
            
            groups.forEach(group => {
                const hasRoot = group.modules.some(m => m.inheritance?.isRoot);
                const rootModule = hasRoot ? group.modules.find(m => m.inheritance?.isRoot) : group.modules[0];
                
                html += `
                    <div class="module-card" style="border-left: 4px solid var(--warning-color); background: #fff9f0;">
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">üîç</span>
                                <strong style="font-size: 1.1rem;">Duplicate Group: "${group.name}"</strong>
                                <span class="badge" style="background: var(--warning-color); color: white;">
                                    ${group.count} modules
                                </span>
                            </div>
                            ${hasRoot ? `
                                <div style="padding: 0.5rem; background: var(--success-color); color: white; border-radius: 4px; font-size: 0.875rem;">
                                    ‚úÖ Already has a root module
                                </div>
                            ` : `
                                <div style="padding: 0.5rem; background: var(--warning-color); color: white; border-radius: 4px; font-size: 0.875rem;">
                                    ‚ö†Ô∏è No root module - consider linking these together
                                </div>
                            `}
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            ${group.modules.map((module, index) => `
                                <div style="padding: 0.75rem; background: white; border: 1px solid var(--border-color); border-radius: 4px;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        ${module.inheritance?.isRoot ? 'üå≥' : (module.inheritance?.parentPath ? 'üîó' : '‚≠ê')}
                                        <strong>${module.workshopId}</strong> / <code>${module.moduleDir}</code>
                                        ${index === 0 && !hasRoot ? '<span class="badge" style="background: var(--info-color); color: white; font-size: 0.75rem;">Suggested Parent</span>' : ''}
                                        ${module.inheritance?.isRoot ? '<span class="badge" style="background: var(--success-color); color: white; font-size: 0.75rem;">Root</span>' : ''}
                                        ${module.inheritance?.parentPath ? '<span class="badge" style="background: var(--info-color); color: white; font-size: 0.75rem;">Linked</span>' : ''}
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--text-light);">
                                        ${module.title}
                                    </div>
                                    ${!module.inheritance?.parentPath && !module.inheritance?.isRoot && index > 0 ? `
                                        <button class="btn btn-sm btn-primary" style="margin-top: 0.5rem;" 
                                                onclick="quickLinkToRoot('${module.modulePath}', '${rootModule.modulePath}')">
                                            üîó Link to ${rootModule.workshopId}
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Populate link module selects
        function populateLinkSelects() {
            const childSelect = document.getElementById('link-child-module');
            const parentSelect = document.getElementById('link-parent-module');
            
            // Clear existing options
            childSelect.innerHTML = '<option value="">Select a module to make a child...</option>';
            parentSelect.innerHTML = '<option value="">Select a parent module...</option>';
            
            // Populate with modules (exclude already linked children from parent options)
            allModulesData.forEach(module => {
                const option = new Option(
                    `${module.workshopId} / ${module.moduleDir}`,
                    module.modulePath
                );
                childSelect.add(option.cloneNode(true));
                
                // Only add to parent if it's not a child
                if (!module.inheritance?.parentPath) {
                    parentSelect.add(option.cloneNode(true));
                }
            });
            
            // Enable/disable link button based on selection
            childSelect.onchange = parentSelect.onchange = () => {
                const btn = document.getElementById('link-modules-btn');
                btn.disabled = !childSelect.value || !parentSelect.value || childSelect.value === parentSelect.value;
            };
        }

        // Link modules
        async function linkModules() {
            const childPath = document.getElementById('link-child-module').value;
            const parentPath = document.getElementById('link-parent-module').value;
            
            if (!childPath || !parentPath) {
                showNotification('Please select both child and parent modules', 'error');
                return;
            }
            
            if (childPath === parentPath) {
                showNotification('Cannot link a module to itself', 'error');
                return;
            }
            
            try {
                showNotification('Checking for circular dependencies...', 'info');
                
                // First check for circular dependencies
                const checkResponse = await fetch('http://localhost:3000/api/modules/check-circular', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ childPath, parentPath })
                });
                
                const checkData = await checkResponse.json();
                
                if (checkData.success && checkData.isCircular) {
                    showNotification('‚ùå Circular dependency detected!', 'error');
                    document.getElementById('link-result').innerHTML = `
                        <div class="alert alert-error">
                            <strong>‚ùå Circular Dependency Detected!</strong><br>
                            ${checkData.message}<br><br>
                            This link would create a circular reference in the hierarchy. 
                            A module cannot be both an ancestor and descendant of another module.
                        </div>
                    `;
                    return;
                }
                
                showNotification('Linking modules...', 'info');
                
                const response = await fetch('http://localhost:3000/api/modules/link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ childPath, parentPath })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('‚úÖ Modules linked successfully!', 'success');
                    document.getElementById('link-result').innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ Success!</strong><br>
                            Child: <code>${childPath}</code><br>
                            Parent: <code>${parentPath}</code><br>
                            The modules are now linked. The child references the parent.
                        </div>
                    `;
                    resetLinkForm();
                    // Reload top-level modules to refresh the view
                    loadModuleBrowser();
                } else {
                    throw new Error(data.error || 'Failed to link modules');
                }
            } catch (error) {
                console.error('Error linking modules:', error);
                showNotification(`Error: ${error.message}`, 'error');
                document.getElementById('link-result').innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Quick link from duplicate finder
        async function quickLinkToRoot(childPath, parentPath) {
            // Check circular dependency first
            try {
                const checkResponse = await fetch('http://localhost:3000/api/modules/check-circular', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ childPath, parentPath })
                });
                
                const checkData = await checkResponse.json();
                
                if (checkData.success && checkData.isCircular) {
                    showNotification('‚ùå Cannot link: Circular dependency detected!', 'error');
                    alert(`Cannot create this link:\n\n${checkData.message}\n\nThis would create a circular reference in the hierarchy.`);
                    return;
                }
            } catch (error) {
                console.error('Error checking circular dependency:', error);
                showNotification('Error checking dependencies', 'error');
                return;
            }
            
            if (confirm(`Link ${childPath} to ${parentPath}?`)) {
                try {
                    showNotification('Linking modules...', 'info');
                    
                    const response = await fetch('http://localhost:3000/api/modules/link', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ childPath, parentPath })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('‚úÖ Modules linked successfully!', 'success');
                        // Refresh duplicates view
                        findDuplicateModules();
                        // Reload top-level modules
                        loadModuleBrowser();
                    } else {
                        throw new Error(data.error || 'Failed to link modules');
                    }
                } catch (error) {
                    console.error('Error linking modules:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                }
            }
        }

        // Promote module to root
        async function promoteModuleToRoot(modulePath) {
            if (confirm(`Promote ${modulePath} to root/independent module?`)) {
                try {
                    showNotification('Promoting module...', 'info');
                    
                    const response = await fetch('http://localhost:3000/api/modules/promote', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ modulePath })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('‚úÖ Module promoted successfully!', 'success');
                        // Reload top-level modules
                        loadModuleBrowser();
                    } else {
                        throw new Error(data.error || 'Failed to promote module');
                    }
                } catch (error) {
                    console.error('Error promoting module:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                }
            }
        }

        // Reset link form
        function resetLinkForm() {
            document.getElementById('link-child-module').value = '';
            document.getElementById('link-parent-module').value = '';
            document.getElementById('link-modules-btn').disabled = true;
            document.getElementById('link-result').innerHTML = '';
        }

        // Workshop management
        async function saveWorkshop() {
            workshop.workshopId = document.getElementById('workshop-id').value;
            workshop.title = document.getElementById('workshop-title').value;
            workshop.description = document.getElementById('workshop-description').value;
            workshop.difficulty = document.getElementById('workshop-difficulty').value;
            workshop.author = document.getElementById('workshop-author').value;
            
            // Calculate duration from modules (auto-sync)
            const totalDuration = workshop.modules.reduce((sum, m) => sum + (m.duration || 0), 0);
            workshop.duration = totalDuration;
            document.getElementById('workshop-duration').value = totalDuration;

            if (!workshop.workshopId || !workshop.title || !workshop.description) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }

            // Validate workshop ID format
            const idRegex = /^[a-z0-9-]+$/;
            if (!idRegex.test(workshop.workshopId)) {
                alert('Workshop ID can only contain lowercase letters, numbers, and hyphens');
                return;
            }

            // Update lastUpdated timestamp
            workshop.lastUpdated = new Date().toISOString().split('T')[0];

            if (useFilesystem) {
                // Save to filesystem via API
                try {
                    showNotification('Saving workshop to filesystem...', 'info');
                    
                    const workshopData = {
                        title: workshop.title,
                        description: workshop.description,
                        duration: workshop.duration,
                        difficulty: workshop.difficulty,
                        modules: workshop.modules
                    };
                    
                    await saveWorkshopToFilesystem(workshop.workshopId, workshopData);
                    
                    // Check if auto-generate is enabled
                    const autoGenerate = document.getElementById('auto-generate-modules').checked;
                    let generatedModules = null;
                    let filesToCommit = [`workshops/${workshop.workshopId}/README.md`];
                    
                    // Auto-generate module directories if enabled and there are modules
                    if (autoGenerate && workshop.modules && workshop.modules.length > 0) {
                        try {
                            showNotification('üóÇÔ∏è Auto-generating module directories...', 'info');
                            const result = await apiRequest(`/workshops/${workshop.workshopId}/generate-modules`, {
                                method: 'POST'
                            });
                            
                            if (result.success) {
                                generatedModules = result.modules;
                                showNotification(`‚úÖ Generated ${result.modules.length} module directories!`, 'success');
                                
                                // Add module files to commit list
                                result.modules.forEach(module => {
                                    filesToCommit.push(`workshops/${workshop.workshopId}/${module.folderName}/README.md`);
                                });
                            }
                        } catch (error) {
                            console.error('Auto-generate modules error:', error);
                            showNotification(`‚ö†Ô∏è Module auto-generation failed: ${error.message}`, 'warning');
                        }
                    }
                    
                    // Ask if user wants to commit
                    const commitPrompt = generatedModules 
                        ? `Workshop saved with ${generatedModules.length} module directories! Commit to Git?`
                        : 'Workshop saved! Do you want to commit these changes to Git?';
                    
                    const shouldCommit = confirm(commitPrompt);
                    if (shouldCommit) {
                        const defaultMessage = generatedModules
                            ? `Update ${workshop.title} with ${generatedModules.length} modules`
                            : `Update ${workshop.title}`;
                        const commitMessage = prompt('Enter commit message:', defaultMessage);
                        
                        if (commitMessage) {
                            await commitChanges(filesToCommit, commitMessage);
                            showNotification('‚úÖ Workshop saved and committed!', 'success');
                        } else {
                            showNotification('‚úÖ Workshop saved (not committed)', 'success');
                        }
                    } else {
                        const savedMsg = generatedModules
                            ? `‚úÖ Workshop saved with ${generatedModules.length} modules (not committed)`
                            : '‚úÖ Workshop saved (not committed)';
                        showNotification(savedMsg, 'success');
                    }
                    
                    // Also save to localStorage as backup
                    localStorage.setItem(`workshop-${workshop.workshopId}`, JSON.stringify(workshop));
                } catch (error) {
                    showNotification(`‚ùå Failed to save: ${error.message}`, 'error');
                    console.error('Save error:', error);
                }
            } else {
                // Save to localStorage only
                localStorage.setItem(`workshop-${workshop.workshopId}`, JSON.stringify(workshop));
                showNotification('‚úÖ Workshop saved to browser storage!', 'success');
            }
        }

        /**
         * Delete the current workshop
         */
        async function deleteCurrentWorkshop() {
            if (!workshop.workshopId) {
                showNotification('No workshop loaded to delete', 'error');
                return;
            }

            const workshopId = workshop.workshopId;
            const workshopTitle = workshop.title || workshopId;

            // Confirm deletion
            const confirmMessage = `‚ö†Ô∏è DELETE WORKSHOP?\n\n` +
                `Workshop: ${workshopTitle}\n` +
                `ID: ${workshopId}\n\n` +
                `This will permanently delete:\n` +
                `‚Ä¢ All workshop files and directories\n` +
                `‚Ä¢ All module files and content\n` +
                `‚Ä¢ Workshop configuration\n\n` +
                `This action CANNOT be undone!\n\n` +
                `Type the workshop ID to confirm: ${workshopId}`;

            const userInput = prompt(confirmMessage);

            if (userInput !== workshopId) {
                if (userInput !== null) {
                    showNotification('Workshop deletion cancelled - ID did not match', 'info');
                }
                return;
            }

            try {
                if (useFilesystem) {
                    // Delete from filesystem via API
                    showNotification('Deleting workshop from filesystem...', 'info');
                    
                    const response = await apiRequest(`/workshops/${workshopId}`, {
                        method: 'DELETE'
                    });

                    if (response.success) {
                        showNotification(`‚úÖ Workshop "${workshopTitle}" deleted successfully!`, 'success');
                        
                        // Also remove from localStorage
                        localStorage.removeItem(`workshop-${workshopId}`);
                        
                        // Clear the current workshop
                        workshop = {
                            workshopId: '',
                            title: '',
                            description: '',
                            duration: '',
                            difficulty: 'intermediate',
                            author: '',
                            modules: []
                        };
                        
                        // Reset the form
                        document.getElementById('workshop-id').value = '';
                        document.getElementById('workshop-title').value = '';
                        document.getElementById('workshop-description').value = '';
                        document.getElementById('workshop-duration').value = '';
                        document.getElementById('workshop-difficulty').value = 'intermediate';
                        document.getElementById('workshop-author').value = '';
                        
                        // Disable delete button
                        document.getElementById('delete-workshop-btn').disabled = true;
                        
                        // Update display
                        updateSummary();
                        renderModules();
                        renderNavigation();
                    } else {
                        throw new Error(response.error || 'Failed to delete workshop');
                    }
                } else {
                    // Delete from localStorage only
                    localStorage.removeItem(`workshop-${workshopId}`);
                    showNotification(`‚úÖ Workshop "${workshopTitle}" deleted from browser storage!`, 'success');
                    
                    // Clear the current workshop
                    workshop = {
                        workshopId: '',
                        title: '',
                        description: '',
                        duration: '',
                        difficulty: 'intermediate',
                        author: '',
                        modules: []
                    };
                    
                    // Reset the form
                    document.getElementById('workshop-id').value = '';
                    document.getElementById('workshop-title').value = '';
                    document.getElementById('workshop-description').value = '';
                    document.getElementById('workshop-duration').value = '';
                    document.getElementById('workshop-difficulty').value = 'intermediate';
                    document.getElementById('workshop-author').value = '';
                    
                    // Disable delete button
                    document.getElementById('delete-workshop-btn').disabled = true;
                    
                    // Update display
                    updateSummary();
                    renderModules();
                    renderNavigation();
                }
            } catch (error) {
                console.error('Delete workshop error:', error);
                showNotification(`‚ùå Failed to delete workshop: ${error.message}`, 'error');
            }
        }

        async function loadWorkshop(workshopId) {
            if (useFilesystem) {
                // Load from filesystem via API
                try {
                    showNotification('Loading workshop from filesystem...', 'info');
                    const workshopData = await loadWorkshopFromFilesystem(workshopId);
                    
                    console.log('=== LOAD WORKSHOP DEBUG ===');
                    console.log('Full workshopData:', workshopData);
                    console.log('workshopData.modules:', workshopData.modules);
                    console.log('workshopData.frontmatter?.modules:', workshopData.frontmatter?.modules);
                    
                    // Use enriched modules from top level (already loaded with metadata from README.md)
                    // frontmatter.modules only has minimal references {order, moduleRef, required}
                    const modulesList = workshopData.modules || [];
                    
                    console.log('Selected modulesList:', modulesList);
                    console.log('modulesList.length:', modulesList.length);
                    
                    // Transform modules - handle both object and string formats
                    const transformedModules = modulesList.map((moduleRef, index) => {
                        // If it's already an object with proper structure, use it with minimal additions
                        if (typeof moduleRef === 'object' && moduleRef !== null) {
                            return {
                                order: index + 1,
                                name: moduleRef.name || 'Unnamed Module',
                                description: moduleRef.description || '',
                                duration: moduleRef.duration || 30,
                                difficulty: moduleRef.difficulty || 'intermediate',
                                type: moduleRef.type || 'lecture',
                                moduleRef: moduleRef.moduleRef || moduleRef.name || `module-${index + 1}`,
                                required: moduleRef.required !== undefined ? moduleRef.required : true
                            };
                        }
                        
                        // If it's a string reference, create a full module object
                        const moduleName = moduleRef.split('/').pop() || moduleRef;
                        return {
                            order: index + 1,
                            name: moduleName.replace(/-/g, ' ').replace(/^\d+\s*/, '').trim(),
                            moduleRef: moduleRef,
                            type: 'hands-on',
                            difficulty: 'intermediate',
                            duration: 30,
                            description: `Module from ${moduleRef}`,
                            required: true
                        };
                    });
                    
                    console.log('Transformed modules:', transformedModules);
                    console.log('Transformed modules length:', transformedModules.length);
                    
                    // Update workshop object
                    workshop = {
                        workshopId: workshopData.workshopId,
                        version: '1.0.0',
                        title: workshopData.title,
                        description: workshopData.description,
                        duration: workshopData.duration,
                        difficulty: workshopData.difficulty,
                        author: workshopData.frontmatter?.author || '',
                        modules: transformedModules,
                        prerequisites: workshopData.frontmatter?.prerequisites || [],
                        learningObjectives: workshopData.frontmatter?.learningObjectives || [],
                        lastUpdated: new Date().toISOString().split('T')[0]
                    };
                    
                    console.log('Final workshop object:', workshop);
                    console.log('Final workshop.modules:', workshop.modules);
                    console.log('Final workshop.modules.length:', workshop.modules.length);
                    
                    // Update form fields
                    document.getElementById('workshop-id').value = workshop.workshopId;
                    document.getElementById('workshop-title').value = workshop.title;
                    document.getElementById('workshop-description').value = workshop.description;
                    document.getElementById('workshop-duration').value = workshop.duration;
                    document.getElementById('workshop-difficulty').value = workshop.difficulty;
                    document.getElementById('workshop-author').value = workshop.author || '';

                    // Enable delete button since workshop is now loaded
                    document.getElementById('delete-workshop-btn').disabled = false;

                    updateSummary();
                    renderModules();
                    renderNavigation();
                    closeWorkshopBrowser();
                    
                    // Check for module divergence
                    await checkModuleDivergence();
                    
                    showNotification('‚úÖ Workshop loaded from filesystem!', 'success');
                } catch (error) {
                    showNotification(`‚ùå Failed to load: ${error.message}`, 'error');
                    console.error('Load error:', error);
                }
            } else {
                // Load from localStorage
                const saved = localStorage.getItem(`workshop-${workshopId}`);
                if (!saved) {
                    alert('Workshop not found in browser storage');
                    return;
                }

                workshop = JSON.parse(saved);
                
                // Update form fields
                document.getElementById('workshop-id').value = workshop.workshopId;
                document.getElementById('workshop-title').value = workshop.title;
                document.getElementById('workshop-description').value = workshop.description;
                document.getElementById('workshop-duration').value = workshop.duration;
                document.getElementById('workshop-difficulty').value = workshop.difficulty;
                document.getElementById('workshop-author').value = workshop.author || '';

                // Enable delete button since workshop is now loaded
                document.getElementById('delete-workshop-btn').disabled = false;

                updateSummary();
                renderModules();
                renderNavigation();
                closeWorkshopBrowser();
                
                showNotification('‚úÖ Workshop loaded from browser storage!', 'success');
            }
        }

        // Workshop browser functions
        function openWorkshopBrowser() {
            document.getElementById('workshop-browser-modal').classList.add('active');
            renderWorkshopBrowser();
        }

        function closeWorkshopBrowser() {
            document.getElementById('workshop-browser-modal').classList.remove('active');
        }

        async function renderWorkshopBrowser() {
            const container = document.getElementById('workshop-browser-list');
            let savedWorkshops = [];

            if (useFilesystem) {
                // Load from filesystem
                try {
                    const workshops = await loadWorkshopsFromFilesystem();
                    // Filter out test workshops (those with 'test' in workshopId)
                    savedWorkshops = workshops
                        .filter(ws => !ws.workshopId.toLowerCase().includes('test'))
                        .map(ws => ({
                            workshopId: ws.workshopId,
                            title: ws.title,
                            description: ws.description,
                            duration: ws.duration,
                            difficulty: ws.difficulty,
                            modules: ws.frontmatter?.modules || ws.modules || [],
                            lastUpdated: 'From filesystem'
                        }));
                } catch (error) {
                    console.error('Failed to load workshops from filesystem:', error);
                    showNotification('Failed to load workshops from filesystem', 'error');
                }
            } else {
                // Get all workshops from localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('workshop-')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            // Filter out test workshops
                            if (!data.workshopId || !data.workshopId.toLowerCase().includes('test')) {
                                savedWorkshops.push(data);
                            }
                        } catch (e) {
                            console.error('Error parsing workshop:', key, e);
                        }
                    }
                }
            }

            if (savedWorkshops.length === 0) {
                container.innerHTML = `
                    <div class="empty-browser">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                        <h3>No Saved Workshops</h3>
                        <p>${useFilesystem ? 'No workshops found in filesystem.' : 'Create and save a workshop to see it here.'}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            savedWorkshops.forEach(ws => {
                const item = document.createElement('div');
                item.className = 'workshop-browser-item';
                const moduleCount = ws.modules ? ws.modules.length : 0;
                const totalDuration = ws.modules ? ws.modules.reduce((sum, m) => {
                    // Handle both array of strings and array of objects
                    if (typeof m === 'string') return sum;
                    return sum + (m.duration || 0);
                }, 0) : 0;
                
                item.innerHTML = `
                    <h4>
                        ${ws.title || ws.workshopId}
                        <span class="badge ${ws.difficulty}">${ws.difficulty}</span>
                    </h4>
                    <p><strong>ID:</strong> ${ws.workshopId}</p>
                    <p>${ws.description || 'No description'}</p>
                    <div class="meta">
                        <span>üìö ${moduleCount} modules</span>
                        ${totalDuration > 0 ? `<span>‚è±Ô∏è ${totalDuration} min</span>` : ''}
                        <span>üìÖ ${ws.lastUpdated || 'Unknown date'}</span>
                        ${useFilesystem ? '<span style="color: var(--success-color)">üíæ Filesystem</span>' : '<span>üåê Browser</span>'}
                    </div>
                `;
                item.onclick = () => {
                    // Populate the Workshop ID field
                    document.getElementById('workshop-id').value = ws.workshopId;
                    // Load the workshop
                    loadWorkshop(ws.workshopId);
                    // Close the browser modal
                    closeWorkshopBrowser();
                };
                container.appendChild(item);
            });
        }

        async function filterWorkshops() {
            const search = document.getElementById('workshop-search').value.toLowerCase();
            const container = document.getElementById('workshop-browser-list');
            let savedWorkshops = [];

            // Get workshops based on mode
            if (useFilesystem) {
                // Load from filesystem
                try {
                    const workshops = await loadWorkshopsFromFilesystem();
                    savedWorkshops = workshops.map(ws => ({
                        workshopId: ws.workshopId,
                        title: ws.title,
                        description: ws.description,
                        duration: ws.duration,
                        difficulty: ws.difficulty,
                        modules: ws.frontmatter?.modules || ws.modules || [],
                        lastUpdated: 'From filesystem'
                    }));
                } catch (error) {
                    console.error('Failed to load workshops from filesystem:', error);
                }
            } else {
                // Get all workshops from localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('workshop-')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            savedWorkshops.push(data);
                        } catch (e) {
                            console.error('Error parsing workshop:', key, e);
                        }
                    }
                }
            }

            // Filter workshops
            const filtered = savedWorkshops.filter(ws => {
                return ws.workshopId.toLowerCase().includes(search) ||
                       (ws.title && ws.title.toLowerCase().includes(search)) ||
                       (ws.description && ws.description.toLowerCase().includes(search));
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-browser">
                        <p>No workshops found matching "${search}"</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            filtered.forEach(ws => {
                const item = document.createElement('div');
                item.className = 'workshop-browser-item';
                const moduleCount = ws.modules ? ws.modules.length : 0;
                const totalDuration = ws.modules ? ws.modules.reduce((sum, m) => sum + (m.duration || 0), 0) : 0;
                
                item.innerHTML = `
                    <h4>
                        ${ws.title || ws.workshopId}
                        <span class="badge ${ws.difficulty}">${ws.difficulty}</span>
                    </h4>
                    <p><strong>ID:</strong> ${ws.workshopId}</p>
                    <p>${ws.description || 'No description'}</p>
                    <div class="meta">
                        <span>üìö ${moduleCount} modules</span>
                        <span>‚è±Ô∏è ${totalDuration} min</span>
                        <span>üìÖ ${ws.lastUpdated || 'Unknown date'}</span>
                    </div>
                `;
                item.onclick = () => {
                    // Populate the Workshop ID field
                    document.getElementById('workshop-id').value = ws.workshopId;
                    // Load the workshop
                    loadWorkshop(ws.workshopId);
                    // Close the browser modal
                    closeWorkshopBrowser();
                };
                container.appendChild(item);
            });
        }

        // Module management
        function openModuleBrowser() {
            // Reset to parent view when opening
            moduleBrowserState.currentView = 'parents';
            moduleBrowserState.currentParent = null;
            
            document.getElementById('module-browser-modal').classList.add('active');
            filterModules(); // Use new hierarchical view instead of old renderModuleBrowser
        }

        function closeModuleBrowser() {
            document.getElementById('module-browser-modal').classList.remove('active');
        }

        function updateModuleRefFromName() {
            const moduleName = document.getElementById('custom-module-name').value.trim();
            const currentRef = document.getElementById('custom-module-ref').value;
            
            // Extract the current prefix (e.g., "module-03-")
            const prefixMatch = currentRef.match(/^(module-\d+-)/);
            if (prefixMatch && moduleName) {
                const prefix = prefixMatch[1];
                // Generate new base name from the updated module name
                const baseName = moduleName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                // Update the ref while keeping the prefix
                document.getElementById('custom-module-ref').value = `${prefix}${baseName}`;
            }
        }

        function showCreateCustomModule() {
            document.getElementById('module-browser-modal').classList.remove('active');
            document.getElementById('custom-module-modal').classList.add('active');
            // Clear form
            document.getElementById('custom-module-name').value = '';
            document.getElementById('custom-module-description').value = '';
            document.getElementById('custom-module-duration').value = '30';
            document.getElementById('custom-module-difficulty').value = 'intermediate';
            document.getElementById('custom-module-type').value = 'hands-on';
            
            // Generate sequential module directory name suggestion
            const nextOrder = workshop.modules.length + 1;
            const orderPrefix = `module-${String(nextOrder).padStart(2, '0')}`;
            document.getElementById('custom-module-ref').value = `${orderPrefix}-new-module-custom`;
        }

        function closeCustomModule() {
            document.getElementById('custom-module-modal').classList.remove('active');
            // Clear the source module reference if closing without creating
            delete window._sourceModuleForCopy;
        }

        async function createCustomModule() {
            // Prevent duplicate calls
            if (window._isCreatingModule) {
                console.log('Module creation already in progress, ignoring duplicate call');
                return;
            }
            window._isCreatingModule = true;
            
            const name = document.getElementById('custom-module-name').value.trim();
            const description = document.getElementById('custom-module-description').value.trim();
            const duration = parseInt(document.getElementById('custom-module-duration').value);
            const difficulty = document.getElementById('custom-module-difficulty').value;
            const type = document.getElementById('custom-module-type').value;
            const ref = document.getElementById('custom-module-ref').value.trim();

            // Validate required fields
            if (!name) {
                window._isCreatingModule = false;
                alert('Please enter a module name');
                document.getElementById('custom-module-name').focus();
                return;
            }

            if (!description) {
                window._isCreatingModule = false;
                alert('Please enter a module description');
                document.getElementById('custom-module-description').focus();
                return;
            }

            if (!duration || duration < 5 || duration > 300) {
                window._isCreatingModule = false;
                alert('Please enter a valid duration (5-300 minutes)');
                document.getElementById('custom-module-duration').focus();
                return;
            }

            // Check if this is a copy operation (duplicateAndCustomize was called)
            const sourceModuleForCopy = window._sourceModuleForCopy;
            
            if (sourceModuleForCopy) {
                // This is a copy operation - call backend to copy the module
                try {
                    showNotification('üîÑ Copying module files...', 'info');
                    
                    // Check if module directory already exists
                    const targetPath = `workshops/${workshop.workshopId}/${ref}`;
                    const checkResponse = await fetch(`http://localhost:3000/api/modules/exists?path=${encodeURIComponent(targetPath)}`);
                    const existsData = await checkResponse.json();
                    
                    if (existsData.exists) {
                        const overwrite = confirm(`‚ö†Ô∏è A module directory "${ref}" already exists in this workshop.\n\nDo you want to overwrite it?`);
                        if (!overwrite) {
                            window._isCreatingModule = false;
                            return;
                        }
                    }
                    
                    const response = await apiRequest('/modules/copy', {
                        method: 'POST',
                        body: JSON.stringify({
                            sourceModulePath: sourceModuleForCopy.moduleRef, // This should be the actual path
                            workshopId: workshop.workshopId,
                            newModuleName: ref, // Use the ref as the directory name
                            newModuleMetadata: {
                                title: name,
                                description: description,
                                duration: duration,
                                difficulty: difficulty,
                                type: type
                            }
                        })
                    });
                    
                    if (response.success) {
                        // Add the copied module to the workshop
                        const newModule = {
                            order: workshop.modules.length + 1,
                            name: name,
                            description: description,
                            duration: duration,
                            difficulty: difficulty,
                            type: type,
                            moduleRef: response.newModulePath,
                            required: true,
                            customized: true
                        };
                        
                        workshop.modules.push(newModule);
                        
                        // Clear the source module reference
                        delete window._sourceModuleForCopy;
                        window._isCreatingModule = false;
                        
                        closeCustomModule();
                        updateSummary();
                        renderModules();
                        renderNavigation();
                        
                        showNotification(`‚úÖ Module "${name}" copied and added successfully! All files have been copied to: ${response.moduleDir}`, 'success');
                    } else {
                        throw new Error(response.error || 'Failed to copy module');
                    }
                } catch (error) {
                    console.error('Copy module error:', error);
                    alert(`Failed to copy module: ${error.message}\n\nPlease ensure the workshop directory exists.`);
                    // Clear the source module reference on error
                    delete window._sourceModuleForCopy;
                    window._isCreatingModule = false;
                }
            } else {
                // Regular custom module creation (no file copying)
                const moduleRef = ref || `custom/${name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')}`;

                // Check if module with same ref already exists
                if (workshop.modules.some(m => m.moduleRef === moduleRef)) {
                    window._isCreatingModule = false;
                    alert('A module with this reference already exists in the workshop');
                    return;
                }

                // Add the custom module
                const newModule = {
                    order: workshop.modules.length + 1,
                    name: name,
                    description: description,
                    duration: duration,
                    difficulty: difficulty,
                    type: type,
                    moduleRef: moduleRef,
                    required: true
                };

                workshop.modules.push(newModule);
                window._isCreatingModule = false;
                
                closeCustomModule();
                updateSummary();
                renderModules();
                renderNavigation();
                
                showNotification(`‚úÖ Custom module "${name}" added successfully!`, 'success');
            }
        }

        // Duplicate and Customize Module - Creates a full copy of the module
        async function duplicateAndCustomize(sourceModule) {
            if (!sourceModule) {
                alert('Source module not found');
                return;
            }

            // Check if workshop ID is set
            if (!workshop.workshopId) {
                alert('Please set a Workshop ID first before customizing modules');
                return;
            }

            // Close the module browser modal
            closeModuleBrowser();

            // Show custom module modal with pre-filled data
            document.getElementById('custom-module-name').value = `${sourceModule.name} (Custom)`;
            document.getElementById('custom-module-description').value = sourceModule.description;
            document.getElementById('custom-module-duration').value = sourceModule.duration;
            document.getElementById('custom-module-difficulty').value = sourceModule.difficulty;
            document.getElementById('custom-module-type').value = sourceModule.type;
            
            // Store source module reference for later use
            window._sourceModuleForCopy = sourceModule;
            
            // Generate a suggested module directory name with sequential numbering
            const timestamp = Date.now();
            const nextOrder = workshop.modules.length + 1;
            const baseName = sourceModule.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            const orderPrefix = `module-${String(nextOrder).padStart(2, '0')}`;
            document.getElementById('custom-module-ref').value = `${orderPrefix}-${baseName}`;

            // Show the custom module modal
            document.getElementById('custom-module-modal').classList.add('active');

            // Update the alert message
            const alertDiv = document.querySelector('#custom-module-modal .alert');
            if (alertDiv) {
                alertDiv.innerHTML = `
                    <strong>‚úèÔ∏è Customizing Module</strong><br>
                    This will create a <strong>full copy</strong> of "<strong>${sourceModule.name}</strong>" 
                    with all its files and directories.<br><br>
                    <strong>‚ö†Ô∏è Note:</strong> To copy an existing module, use the Module Manager's "Browse Modules" tab 
                    to find real modules from your repository. The "Add Module" feature currently shows sample modules only.
                `;
            }
        }

        // Edit Module Functions
        let editingModuleIndex = -1;

        function editModule(index) {
            editingModuleIndex = index;
            const module = workshop.modules[index];
            
            // Populate form with module data
            document.getElementById('edit-module-name').value = module.name || '';
            document.getElementById('edit-module-description').value = module.description || '';
            document.getElementById('edit-module-duration').value = module.duration || 30;
            document.getElementById('edit-module-difficulty').value = module.difficulty || 'intermediate';
            document.getElementById('edit-module-type').value = module.type || 'hands-on';
            document.getElementById('edit-module-required').checked = module.required !== false;
            document.getElementById('edit-module-ref').value = module.moduleRef || '';
            
            // Show modal
            document.getElementById('edit-module-modal').classList.add('active');
        }

        function closeEditModule() {
            document.getElementById('edit-module-modal').classList.remove('active');
            editingModuleIndex = -1;
        }

        async function saveModuleEdits() {
            if (editingModuleIndex < 0 || editingModuleIndex >= workshop.modules.length) {
                alert('Invalid module index');
                return;
            }

            const name = document.getElementById('edit-module-name').value.trim();
            const description = document.getElementById('edit-module-description').value.trim();
            const duration = parseInt(document.getElementById('edit-module-duration').value);
            const difficulty = document.getElementById('edit-module-difficulty').value;
            const type = document.getElementById('edit-module-type').value;
            const required = document.getElementById('edit-module-required').checked;

            // Validate required fields
            if (!name) {
                alert('Please enter a module name');
                document.getElementById('edit-module-name').focus();
                return;
            }

            if (!description) {
                alert('Please enter a module description');
                document.getElementById('edit-module-description').focus();
                return;
            }

            if (!duration || duration < 5 || duration > 300) {
                alert('Please enter a valid duration (5-300 minutes)');
                document.getElementById('edit-module-duration').focus();
                return;
            }

            const oldModule = workshop.modules[editingModuleIndex];
            const isPhysicalModule = oldModule.moduleRef && !oldModule.moduleRef.startsWith('custom/');
            
            // If it's a physical module, update the README.md frontmatter
            if (isPhysicalModule) {
                try {
                    showNotification('Updating module frontmatter...', 'info');
                    
                    const response = await apiRequest('/modules/update-frontmatter', {
                        method: 'POST',
                        body: JSON.stringify({
                            modulePath: oldModule.moduleRef,
                            metadata: {
                                title: name,
                                description: description,
                                duration: duration,
                                difficulty: difficulty,
                                type: type
                            }
                        })
                    });
                    
                    if (!response.success) {
                        throw new Error(response.error || 'Failed to update module frontmatter');
                    }
                    
                    showNotification(`‚úÖ Module "${name}" updated successfully!`, 'success');
                } catch (error) {
                    console.error('Update frontmatter error:', error);
                    showNotification(`‚ö†Ô∏è Failed to update module: ${error.message}`, 'error');
                    return;
                }
            }
            
            // Update workshop.yaml with minimal metadata (only order and required flag)
            workshop.modules[editingModuleIndex] = {
                order: oldModule.order,
                moduleRef: oldModule.moduleRef,
                required: required
            };

            closeEditModule();
            updateSummary();
            renderModules();
            renderNavigation();
        }

        function renderModuleBrowser() {
            const container = document.getElementById('module-browser-list');
            container.innerHTML = '';

            // Filter out modules that are already in the workshop
            const existingModuleRefs = new Set(workshop.modules.map(m => m.moduleRef));
            const filteredModules = availableModules.filter(module => !existingModuleRefs.has(module.moduleRef));

            if (filteredModules.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-light);">All available modules have been added to this workshop</div>';
                return;
            }

            filteredModules.forEach(module => {
                const item = document.createElement('div');
                item.className = 'module-browser-item';
                item.innerHTML = `
                    <div>
                        <h4>${module.name} <span class="badge ${module.type}">${module.type}</span></h4>
                        <p>${module.description}</p>
                        <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text-light); margin-top: 0.5rem;">
                            <span>‚è±Ô∏è ${module.duration} min</span>
                            <span class="badge ${module.difficulty}">${module.difficulty}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); addModule(availableModules.find(m => m.moduleRef === '${module.moduleRef}'));" style="flex: 1;">
                            ‚ûï Add
                        </button>
                        <button class="btn btn-outline" onclick="event.stopPropagation(); duplicateAndCustomize(availableModules.find(m => m.moduleRef === '${module.moduleRef}'));" style="flex: 1;">
                            ‚úèÔ∏è Customize
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // Track current navigation state
        let moduleBrowserState = {
            currentView: 'parents', // 'parents' or 'children'
            currentParent: null,
            breadcrumbs: []
        };

        function filterModules() {
            const searchInput = document.getElementById('module-search');
            const search = searchInput ? searchInput.value.toLowerCase() : '';

            const container = document.getElementById('module-browser-list');
            container.innerHTML = '';

            // Filter out modules that are already in the workshop
            const existingModuleRefs = new Set(workshop.modules.map(m => m.moduleRef));
            
            const filtered = availableModules.filter(module => {
                // Exclude modules already in the workshop
                if (existingModuleRefs.has(module.moduleRef)) {
                    return false;
                }
                
                // Enhanced search - check multiple fields
                const matchesSearch = !search || // Empty search matches all
                                     (module.name && module.name.toLowerCase().includes(search)) || 
                                     (module.title && module.title.toLowerCase().includes(search)) ||
                                     (module.description && module.description.toLowerCase().includes(search)) ||
                                     (module.workshopId && module.workshopId.toLowerCase().includes(search)) ||
                                     (module.moduleDir && module.moduleDir.toLowerCase().includes(search)) ||
                                     (module.tags && module.tags.some(tag => tag.toLowerCase().includes(search)));
                
                return matchesSearch;
            });

            if (filtered.length === 0) {
                const message = existingModuleRefs.size === availableModules.length 
                    ? 'All available modules have been added to this workshop'
                    : 'No modules found matching your search criteria';
                container.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--text-light);">${message}</div>`;
                return;
            }

            // Show hierarchical view based on current state
            if (moduleBrowserState.currentView === 'parents') {
                renderParentModules(filtered, container);
            } else {
                renderChildModules(filtered, container);
            }
        }

        function renderParentModules(modules, container) {
            // Show only parent modules (those without parents)
            // Count customized children for each potential parent
            const parents = modules.filter(m => {
                const isOriginal = !m.inheritance || !m.inheritance.parentPath;
                return isOriginal;
            });
            
            // For each parent, count how many children are customized (different from parent)
            parents.forEach(parent => {
                // Find children by matching:
                // 1. inheritance.parentPath includes parent.moduleDir, OR
                // 2. Same title AND child has inheritance (for cross-workshop inheritance)
                const children = modules.filter(m => {
                    if (!m.inheritance || !m.inheritance.parentPath) return false;
                    
                    // Direct moduleDir match
                    if (m.inheritance.parentPath.includes(parent.moduleDir)) {
                        return true;
                    }
                    
                    // Cross-workshop match by title (same title + has inheritance)
                    if (m.title === parent.title && m.workshopId !== parent.workshopId) {
                        return true;
                    }
                    
                    return false;
                });
                
                // Count children that have been customized (different duration or description)
                const customizedChildren = children.filter(child => 
                    child.duration !== parent.duration || 
                    child.description !== parent.description
                );
                
                parent.customizedChildrenCount = customizedChildren.length;
            });

            if (parents.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--text-light);">No parent modules found</div>`;
                return;
            }

            parents.forEach(module => {
                const item = document.createElement('div');
                item.className = 'module-browser-item';
                const workshopName = module.workshopId || 'Unknown Workshop';
                const moduleDir = module.moduleDir || '';
                const hasCustomizedChildren = module.customizedChildrenCount > 0;
                
                item.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <h4 style="margin: 0; flex: 1;">
                                ${hasCustomizedChildren ? 'üìÇ' : 'üìÑ'} ${module.name || module.title || 'Unnamed Module'}
                                <span class="badge ${module.type}" style="margin-left: 0.5rem;">${module.type || 'hands-on'}</span>
                            </h4>
                        </div>
                        
                        <div style="font-size: 0.8rem; color: var(--text-light); display: flex; gap: 1rem; flex-wrap: wrap;">
                            <span>üìÅ ${workshopName}</span>
                            ${moduleDir ? `<span style="font-family: monospace; background: var(--bg-light); padding: 0.125rem 0.375rem; border-radius: 3px;">${moduleDir}</span>` : ''}
                        </div>
                        
                        <p style="margin: 0; line-height: 1.5; color: var(--text-dark);">
                            ${module.description || 'No description available'}
                        </p>
                        
                        <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text-light); flex-wrap: wrap; align-items: center;">
                            <span>‚è±Ô∏è ${module.duration || 30} min</span>
                            <span class="badge ${module.difficulty}" style="text-transform: capitalize;">${module.difficulty || 'intermediate'}</span>
                            ${hasCustomizedChildren ? `<span class="item-badge parent">${module.customizedChildrenCount} customized variant${module.customizedChildrenCount !== 1 ? 's' : ''}</span>` : ''}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); addModule(availableModules.find(m => m.moduleRef === '${module.moduleRef}'));" style="flex: 1;">
                            ‚ûï Add
                        </button>
                        <button class="btn btn-outline" onclick="event.stopPropagation(); duplicateAndCustomize(availableModules.find(m => m.moduleRef === '${module.moduleRef}'));" style="flex: 1;">
                            ‚úèÔ∏è Customize
                        </button>
                        ${hasCustomizedChildren ? `
                            <button class="btn btn-outline" onclick="event.stopPropagation(); showModuleVariants('${module.moduleRef}', '${module.name}');" style="flex: 1;">
                                üîç View ${module.customizedChildrenCount} Variant${module.customizedChildrenCount !== 1 ? 's' : ''}
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function renderChildModules(modules, container) {
            const parent = moduleBrowserState.currentParent;
            if (!parent) {
                showParentModules();
                return;
            }

            // Add breadcrumb navigation
            const breadcrumb = document.createElement('div');
            breadcrumb.style.cssText = 'margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-light); border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;';
            breadcrumb.innerHTML = `
                <button class="btn btn-sm btn-outline" onclick="showParentModules();" style="padding: 0.25rem 0.5rem;">
                    ‚Üê Back to All Modules
                </button>
                <span style="color: var(--text-light);">Variants of:</span>
                <strong>${parent.name}</strong>
            `;
            container.appendChild(breadcrumb);

            // Show children of the current parent
            const children = modules.filter(m => 
                m.inheritance && 
                m.inheritance.parentPath && 
                m.inheritance.parentPath.includes(parent.moduleDir)
            );

            if (children.length === 0) {
                const noChildren = document.createElement('div');
                noChildren.style.cssText = 'text-align: center; padding: 2rem; color: var(--text-light);';
                noChildren.textContent = 'No variants found for this module';
                container.appendChild(noChildren);
                return;
            }

            children.forEach(module => {
                const item = document.createElement('div');
                item.className = 'module-browser-item';
                const workshopName = module.workshopId || 'Unknown Workshop';
                const moduleDir = module.moduleDir || '';
                
                item.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <h4 style="margin: 0; flex: 1;">
                                üìÑ ${module.name || module.title || 'Unnamed Module'}
                                <span class="badge ${module.type}" style="margin-left: 0.5rem;">${module.type || 'hands-on'}</span>
                                <span class="item-badge child" style="margin-left: 0.5rem;">variant</span>
                            </h4>
                        </div>
                        
                        <div style="font-size: 0.8rem; color: var(--text-light); display: flex; gap: 1rem; flex-wrap: wrap;">
                            <span>üìÅ ${workshopName}</span>
                            ${moduleDir ? `<span style="font-family: monospace; background: var(--bg-light); padding: 0.125rem 0.375rem; border-radius: 3px;">${moduleDir}</span>` : ''}
                        </div>
                        
                        <p style="margin: 0; line-height: 1.5; color: var(--text-dark);">
                            ${module.description || 'No description available'}
                        </p>
                        
                        <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text-light); flex-wrap: wrap; align-items: center;">
                            <span>‚è±Ô∏è ${module.duration || 30} min</span>
                            <span class="badge ${module.difficulty}" style="text-transform: capitalize;">${module.difficulty || 'intermediate'}</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); addModule(availableModules.find(m => m.moduleRef === '${module.moduleRef}'));" style="flex: 1;">
                            ‚ûï Add
                        </button>
                        <button class="btn btn-outline" onclick="event.stopPropagation(); duplicateAndCustomize(availableModules.find(m => m.moduleRef === '${module.moduleRef}'));" style="flex: 1;">
                            ‚úèÔ∏è Customize
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function showModuleVariants(moduleRef, moduleName) {
            const module = availableModules.find(m => m.moduleRef === moduleRef);
            if (!module) return;

            moduleBrowserState.currentView = 'children';
            moduleBrowserState.currentParent = {
                moduleRef: moduleRef,
                name: moduleName,
                moduleDir: module.moduleDir
            };

            filterModules(); // Re-render with new state
        }

        function showParentModules() {
            moduleBrowserState.currentView = 'parents';
            moduleBrowserState.currentParent = null;
            filterModules(); // Re-render with new state
        }

        function addModule(module) {
            // Check if module already exists
            if (workshop.modules.some(m => m.moduleRef === module.moduleRef)) {
                alert('This module is already in the workshop');
                return;
            }

            workshop.modules.push({
                moduleRef: module.moduleRef,
                name: module.name,
                description: module.description,
                duration: module.duration,
                difficulty: module.difficulty,
                type: module.type,
                required: true,
                order: workshop.modules.length + 1
            });

            closeModuleBrowser();
            updateSummary();
            renderModules();
            renderNavigation();
        }

        function removeModule(index) {
            if (confirm('Remove this module from the workshop?')) {
                workshop.modules.splice(index, 1);
                // Renumber
                workshop.modules.forEach((m, i) => m.order = i + 1);
                updateSummary();
                renderModules();
                renderNavigation();
            }
        }

        function moveModuleUp(index) {
            if (index === 0) return;
            [workshop.modules[index], workshop.modules[index - 1]] = 
            [workshop.modules[index - 1], workshop.modules[index]];
            workshop.modules.forEach((m, i) => m.order = i + 1);
            updateSummary();
            renderModules();
            renderNavigation();
        }

        function moveModuleDown(index) {
            if (index === workshop.modules.length - 1) return;
            [workshop.modules[index], workshop.modules[index + 1]] = 
            [workshop.modules[index + 1], workshop.modules[index]];
            workshop.modules.forEach((m, i) => m.order = i + 1);
            updateSummary();
            renderModules();
            renderNavigation();
        }

        function clearAllModules() {
            if (confirm('Remove all modules from the workshop?')) {
                workshop.modules = [];
                updateSummary();
                renderModules();
            }
        }

        // Store divergence info
        let moduleDivergenceInfo = {};

        /**
         * Check if modules have diverged from their parents
         */
        async function checkModuleDivergence() {
            if (!useFilesystem || !workshop.workshopId) {
                return;
            }
            
            try {
                const response = await apiRequest('/modules/check-divergence', {
                    method: 'POST',
                    body: JSON.stringify({ workshopId: workshop.workshopId })
                });
                
                if (response.success) {
                    moduleDivergenceInfo = {};
                    response.modules.forEach(mod => {
                        moduleDivergenceInfo[mod.moduleName] = mod;
                    });
                    
                    // Re-render modules to show divergence indicators
                    // (Visual indicators on module cards are enough - no notification needed)
                    renderModules();
                }
            } catch (error) {
                console.error('Failed to check module divergence:', error);
            }
        }

        /**
         * Reset a module to match its parent
         */
        async function resetModuleToParent(modulePath, moduleName) {
            if (!confirm(`Reset "${moduleName}" to match its parent?\n\nThis will delete all local changes and re-copy from the parent module.`)) {
                return;
            }
            
            try {
                showNotification('üîÑ Resetting module...', 'info');
                
                const response = await apiRequest('/modules/reset-to-parent', {
                    method: 'POST',
                    body: JSON.stringify({ modulePath: modulePath })
                });
                
                if (response.success) {
                    showNotification(`‚úÖ Module "${moduleName}" reset to parent state`, 'success');
                    
                    // Refresh divergence check
                    await checkModuleDivergence();
                }
            } catch (error) {
                console.error('Failed to reset module:', error);
                showNotification(`‚ùå Failed to reset: ${error.message}`, 'error');
            }
        }

        function renderModules() {
            console.log('=== RENDER MODULES DEBUG ===');
            console.log('workshop object:', workshop);
            console.log('workshop.modules:', workshop.modules);
            console.log('workshop.modules.length:', workshop.modules.length);
            
            const container = document.getElementById('modules-list');
            
            if (workshop.modules.length === 0) {
                console.log('No modules - showing empty state');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No Modules Yet</h3>
                        <p>Click "Add Module" to start building your workshop</p>
                    </div>
                `;
                return;
            }
            
            console.log('Rendering', workshop.modules.length, 'modules');

            container.innerHTML = '';
            workshop.modules.forEach((module, index) => {
                // Handle both object and string formats
                const moduleData = typeof module === 'object' ? module : {
                    order: index + 1,
                    name: module,
                    moduleRef: module,
                    type: 'hands-on',
                    difficulty: 'intermediate',
                    duration: 30,
                    description: module
                };
                
                // Check if this module has diverged
                const divInfo = moduleDivergenceInfo[moduleData.name];
                const hasDiverged = divInfo && divInfo.hasDiverged;
                const hasParent = divInfo && divInfo.hasParent;
                const isCustomized = divInfo && divInfo.isCustomized;
                
                const card = document.createElement('div');
                card.className = 'module-card';
                if (hasDiverged) {
                    card.style.borderLeft = '4px solid var(--warning-color)';
                } else if (isCustomized) {
                    card.style.borderLeft = '4px solid #9333ea'; // Purple for customized
                }
                
                card.innerHTML = `
                    <div class="module-card-header" onclick="editModule(${index})" style="cursor: pointer;" title="Click to edit module">
                        <div style="display: flex; align-items: center; flex: 1;">
                            <div class="module-card-order">${moduleData.order || index + 1}</div>
                            <div style="flex: 1;">
                                <div class="module-card-title">
                                    ${moduleData.name || moduleData.moduleRef || 'Unnamed Module'}
                                    ${hasDiverged ? '<span style="font-size: 0.875rem; color: var(--warning-color); margin-left: 0.5rem;">‚ö†Ô∏è Modified</span>' : ''}
                                    ${isCustomized ? '<span style="font-size: 0.875rem; color: #9333ea; margin-left: 0.5rem;">üé® Customized</span>' : ''}
                                    ${hasParent && !hasDiverged && !isCustomized ? '<span style="font-size: 0.875rem; color: var(--success-color); margin-left: 0.5rem;">‚úì Synced</span>' : ''}
                                    <span style="font-size: 0.75rem; color: var(--primary-color); margin-left: 0.5rem;">‚úèÔ∏è Click to edit</span>
                                </div>
                                <div style="font-size: 0.875rem; color: var(--text-light); margin-top: 0.25rem;">
                                    ${moduleData.moduleRef || ''}
                                </div>
                                ${hasDiverged ? `
                                    <div style="font-size: 0.75rem; color: var(--warning-color); margin-top: 0.25rem; background: #fff3cd; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block;">
                                        ${divInfo.reason}
                                    </div>
                                ` : ''}
                                ${isCustomized ? `
                                    <div style="font-size: 0.75rem; color: #9333ea; margin-top: 0.25rem; background: #f3e8ff; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block;">
                                        üìã From: ${divInfo.parentPath}<br>
                                        ${divInfo.customizationReason || 'Customized from parent'}
                                    </div>
                                ` : ''}
                                ${hasParent && !hasDiverged && !isCustomized ? `
                                    <div style="font-size: 0.75rem; color: var(--success-color); margin-top: 0.25rem; background: #d4edda; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block;">
                                        üîó Synced with: ${divInfo.parentPath}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <span class="badge ${moduleData.type || 'hands-on'}">${moduleData.type || 'hands-on'}</span>
                    </div>
                    <div style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.75rem;" onclick="editModule(${index})" style="cursor: pointer;">
                        ${moduleData.description || 'No description'}
                    </div>
                    <div class="module-card-meta">
                        <span>‚è±Ô∏è ${typeof moduleData.duration === 'string' ? moduleData.duration : (moduleData.duration || 30) + ' min'}</span>
                        <span class="badge ${moduleData.difficulty || 'intermediate'}">${moduleData.difficulty || 'intermediate'}</span>
                    </div>
                    <div class="module-card-actions">
                        <button class="btn btn-secondary btn-sm btn-icon" onclick="event.stopPropagation(); moveModuleUp(${index})" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button class="btn btn-secondary btn-sm btn-icon" onclick="event.stopPropagation(); moveModuleDown(${index})" ${index === workshop.modules.length - 1 ? 'disabled' : ''}>‚Üì</button>
                        ${hasDiverged ? `
                            <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); resetModuleToParent('${divInfo.modulePath}', '${moduleData.name}')" title="Reset to parent state">
                                üîÑ Reset
                            </button>
                        ` : ''}
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); removeModule(${index})">üóëÔ∏è Remove</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateSummary() {
            document.getElementById('modules-count').textContent = workshop.modules.length;
            
            // Handle both object and string formats for duration
            const totalDuration = workshop.modules.reduce((sum, m) => {
                if (typeof m === 'object') {
                    // Parse duration - handle both string ("60 minutes") and number (60)
                    let duration = m.duration || 0;
                    if (typeof duration === 'string') {
                        duration = parseInt(duration.match(/\d+/)?.[0] || '0', 10);
                    }
                    return sum + duration;
                }
                return sum;
            }, 0);
            document.getElementById('total-duration').textContent = totalDuration;
            
            // Auto-update the workshop duration field
            const durationField = document.getElementById('workshop-duration');
            if (durationField && totalDuration > 0) {
                durationField.value = totalDuration;
                workshop.duration = totalDuration;
            }
            
            // Count modules by type
            const handsOn = workshop.modules.filter(m => {
                if (typeof m === 'object') {
                    return m.type === 'hands-on' || m.type === 'lab';
                }
                return false;
            }).length;
            document.getElementById('hands-on-count').textContent = handsOn;
            
            const lectures = workshop.modules.filter(m => {
                if (typeof m === 'object') {
                    return m.type === 'lecture';
                }
                return false;
            }).length;
            document.getElementById('lecture-count').textContent = lectures;
        }

        function renderNavigation() {
            const container = document.getElementById('navigation-preview');
            
            if (workshop.modules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üß≠</div>
                        <h3>No Navigation Yet</h3>
                        <p>Add modules to see the navigation structure</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="max-width: 600px; margin: 0 auto;">';
            
            workshop.modules.forEach((module, index) => {
                // Handle both object and string formats
                const moduleData = typeof module === 'object' ? module : {
                    order: index + 1,
                    name: module,
                    duration: 30,
                    difficulty: 'intermediate'
                };
                
                const isFirst = index === 0;
                const isLast = index === workshop.modules.length - 1;
                
                html += `
                    <div style="background: var(--bg-light); border: 2px solid var(--border-color); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem;">
                            Module ${moduleData.order || (index + 1)} of ${workshop.modules.length}
                        </div>
                        <h3 style="margin-bottom: 0.5rem;">${moduleData.name || 'Unnamed Module'}</h3>
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <span>‚è±Ô∏è ${moduleData.duration || 30} min</span>
                            <span class="badge ${moduleData.difficulty || 'intermediate'}">${moduleData.difficulty || 'intermediate'}</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            ${!isFirst ? '<button class="btn btn-outline btn-sm">‚Üê Previous Module</button>' : ''}
                            <button class="btn btn-outline btn-sm">üè† Workshop Home</button>
                            ${!isLast ? '<button class="btn btn-primary btn-sm">Next Module ‚Üí</button>' : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }


    </script>
</body>
</html>
