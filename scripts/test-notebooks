#!/usr/bin/env bash
#
# test-notebooks - Smart Jupyter Notebook Test Runner
# 
# Usage:
#   test-notebooks           # Test current directory only
#   test-notebooks -m        # Test entire module (parent directory)
#   test-notebooks -a        # Test all notebooks in workshop
#   test-notebooks --help    # Show help
#
# This script can be run from anywhere in the workshop directory structure.

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Find repository root (where .git is located)
find_repo_root() {
    local dir="$PWD"
    while [ "$dir" != "/" ]; do
        if [ -d "$dir/.git" ]; then
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    echo "$PWD"  # Fallback to current directory
}

REPO_ROOT=$(find_repo_root)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Default values
TEST_SCOPE="current"  # current, module, all
DOCKER_REQUIRED=false
VERBOSE=false
TIMEOUT=600  # 10 minutes per notebook

# Parse arguments
show_help() {
    cat << EOF
${CYAN}test-notebooks - Smart Jupyter Notebook Test Runner${NC}

${YELLOW}Usage:${NC}
  test-notebooks [OPTIONS]

${YELLOW}Options:${NC}
  (no options)     Test notebooks in current directory only
  -m, --module     Test entire module (parent directory and subdirectories)
  -a, --all        Test all notebooks in the entire workshop
  -d, --docker     Start Docker containers (PostgreSQL & Redis)
  -v, --verbose    Show detailed output
  --timeout SEC    Set timeout per notebook (default: 600)
  -h, --help       Show this help message

${YELLOW}Examples:${NC}
  # Test current directory
  cd module-08-implement-caching-lab
  test-notebooks

  # Test entire module from any subfolder
  cd module-08-implement-caching-lab/some-subfolder
  test-notebooks -m

  # Test all notebooks with Docker
  test-notebooks -a -d

  # Test with custom timeout
  test-notebooks -m --timeout 300

${YELLOW}Context-Aware:${NC}
  The script automatically detects:
  - Your current location in the workshop
  - Which notebooks to test based on scope
  - Repository root directory

${YELLOW}Docker:${NC}
  Use -d/--docker to automatically start:
  - PostgreSQL 15 (port 5432)
  - Redis 7 (port 6379)
  
  Containers are cleaned up automatically after tests.

EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -m|--module)
            TEST_SCOPE="module"
            shift
            ;;
        -a|--all)
            TEST_SCOPE="all"
            shift
            ;;
        -d|--docker)
            DOCKER_REQUIRED=true
            shift
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        --timeout)
            TIMEOUT="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Header
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘  ğŸ§ª Redis Workshop Notebook Test Runner          â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Show context
echo -e "${BLUE}ğŸ“ Context:${NC}"
echo -e "   Repository: ${REPO_ROOT}"
echo -e "   Current Dir: ${PWD}"
echo -e "   Test Scope: ${YELLOW}${TEST_SCOPE}${NC}"
echo ""

# Determine test directory based on scope
case $TEST_SCOPE in
    current)
        TEST_DIR="$PWD"
        echo -e "${BLUE}ğŸ¯ Testing notebooks in current directory${NC}"
        ;;
    module)
        # Find the module directory (contains module-XX pattern)
        TEST_DIR="$PWD"
        while [[ "$TEST_DIR" != "$REPO_ROOT" && "$TEST_DIR" != "/" ]]; do
            if [[ $(basename "$TEST_DIR") =~ ^module-[0-9]{2}- ]]; then
                break
            fi
            TEST_DIR=$(dirname "$TEST_DIR")
        done
        
        if [[ ! $(basename "$TEST_DIR") =~ ^module-[0-9]{2}- ]]; then
            echo -e "${YELLOW}âš ï¸  Not inside a module directory. Testing current directory instead.${NC}"
            TEST_DIR="$PWD"
        fi
        
        echo -e "${BLUE}ğŸ¯ Testing entire module: $(basename "$TEST_DIR")${NC}"
        ;;
    all)
        # Find workshops directory
        WORKSHOPS_DIR="${REPO_ROOT}/workshops"
        if [ -d "$WORKSHOPS_DIR" ]; then
            TEST_DIR="$WORKSHOPS_DIR"
            echo -e "${BLUE}ğŸ¯ Testing ALL notebooks in workshop${NC}"
        else
            echo -e "${RED}âŒ Cannot find workshops directory${NC}"
            exit 1
        fi
        ;;
esac

echo ""

# Docker setup
if [ "$DOCKER_REQUIRED" = true ]; then
    echo -e "${BLUE}ğŸ³ Docker Setup${NC}"
    
    # Check if Docker is running
    if ! docker info > /dev/null 2>&1; then
        echo -e "${RED}âŒ Docker is not running. Please start Docker first.${NC}"
        exit 1
    fi
    
    # Stop and remove existing containers
    echo "   Cleaning up old containers..."
    docker stop test-postgres test-redis 2>/dev/null || true
    docker rm test-postgres test-redis 2>/dev/null || true
    
    # Start PostgreSQL
    echo "   Starting PostgreSQL 15..."
    docker run -d --name test-postgres \
        -e POSTGRES_PASSWORD=workshop123 \
        -e POSTGRES_USER=workshop \
        -e POSTGRES_DB=workshop \
        -p 5432:5432 \
        postgres:15-alpine > /dev/null
    
    # Start Redis
    echo "   Starting Redis 7..."
    docker run -d --name test-redis \
        -p 6379:6379 \
        redis:7-alpine > /dev/null
    
    echo -e "   ${GREEN}âœ… Docker containers started${NC}"
    echo "   - PostgreSQL: localhost:5432 (user: workshop, password: workshop123)"
    echo "   - Redis: localhost:6379"
    echo ""
    
    # Wait for containers to be ready
    echo "   â³ Waiting for services to be ready..."
    sleep 5
    
    # Cleanup function
    cleanup_docker() {
        echo ""
        echo -e "${BLUE}ğŸ§¹ Cleaning up Docker containers...${NC}"
        docker stop test-postgres test-redis 2>/dev/null || true
        docker rm test-postgres test-redis 2>/dev/null || true
        echo -e "   ${GREEN}âœ… Cleanup complete${NC}"
    }
    
    # Register cleanup on exit
    trap cleanup_docker EXIT
    echo ""
fi

# Check for required tools
check_requirements() {
    local missing=()
    
    if ! command -v python3 &> /dev/null; then
        missing+=("python3")
    fi
    
    if ! command -v jupyter &> /dev/null; then
        missing+=("jupyter")
    fi
    
    if ! python3 -c "import nbformat" 2>/dev/null; then
        missing+=("nbformat (pip install nbformat)")
    fi
    
    if ! python3 -c "import nbconvert" 2>/dev/null; then
        missing+=("nbconvert (pip install nbconvert)")
    fi
    
    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${RED}âŒ Missing required tools:${NC}"
        for tool in "${missing[@]}"; do
            echo "   - $tool"
        done
        echo ""
        echo "Install with:"
        echo "  pip install jupyter nbformat nbconvert"
        exit 1
    fi
}

echo -e "${BLUE}ğŸ”§ Checking requirements...${NC}"
check_requirements
echo -e "   ${GREEN}âœ… All requirements satisfied${NC}"
echo ""

# Discover notebooks
echo -e "${BLUE}ğŸ” Discovering notebooks...${NC}"

# Find all notebooks in test directory
NOTEBOOKS=()
while IFS= read -r -d '' notebook; do
    # Skip checkpoints
    if [[ "$notebook" != *".ipynb_checkpoints"* ]]; then
        NOTEBOOKS+=("$notebook")
    fi
done < <(find "$TEST_DIR" -name "*.ipynb" -print0 2>/dev/null)

NOTEBOOK_COUNT=${#NOTEBOOKS[@]}

if [ $NOTEBOOK_COUNT -eq 0 ]; then
    echo -e "${YELLOW}âš ï¸  No notebooks found in ${TEST_DIR}${NC}"
    exit 0
fi

echo -e "   Found ${GREEN}${NOTEBOOK_COUNT}${NC} notebook(s)"
echo ""

# Display notebooks
if [ "$VERBOSE" = true ]; then
    echo -e "${BLUE}ğŸ““ Notebooks to test:${NC}"
    for notebook in "${NOTEBOOKS[@]}"; do
        rel_path="${notebook#$TEST_DIR/}"
        echo "   - $rel_path"
    done
    echo ""
fi

# Test execution
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘  ğŸš€ Running Tests                                  â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

PASSED_COUNT=0
FAILED_COUNT=0
FAILED_NOTEBOOKS=()

for notebook in "${NOTEBOOKS[@]}"; do
    # Get relative path for display
    if [[ "$notebook" == "$REPO_ROOT"* ]]; then
        rel_path="${notebook#$REPO_ROOT/}"
    else
        rel_path="${notebook#$TEST_DIR/}"
    fi
    
    notebook_name=$(basename "$notebook" .ipynb)
    
    echo -e "${YELLOW}ğŸ““ Testing:${NC} $rel_path"
    
    # Get notebook directory for execution context
    notebook_dir=$(dirname "$notebook")
    
    # Execute notebook
    output_file="/tmp/test-notebook-$$.ipynb"
    
    if [ "$VERBOSE" = true ]; then
        jupyter nbconvert \
            --to notebook \
            --execute \
            --ExecutePreprocessor.timeout=$TIMEOUT \
            --output="$output_file" \
            "$notebook" 2>&1
        result=$?
    else
        jupyter nbconvert \
            --to notebook \
            --execute \
            --ExecutePreprocessor.timeout=$TIMEOUT \
            --output="$output_file" \
            "$notebook" > /dev/null 2>&1
        result=$?
    fi
    
    if [ $result -eq 0 ]; then
        echo -e "   ${GREEN}âœ… PASSED${NC}"
        ((PASSED_COUNT++))
    else
        echo -e "   ${RED}âŒ FAILED${NC}"
        ((FAILED_COUNT++))
        FAILED_NOTEBOOKS+=("$rel_path")
        
        # Show error details if not verbose
        if [ "$VERBOSE" = false ]; then
            echo -e "   ${RED}Run with -v for detailed error output${NC}"
        fi
    fi
    
    # Cleanup temp file
    rm -f "$output_file"
    
    echo ""
done

# Summary
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘  ğŸ“Š Test Summary                                   â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "Total:  ${NOTEBOOK_COUNT} notebook(s)"
echo -e "Passed: ${GREEN}${PASSED_COUNT}${NC} âœ…"
echo -e "Failed: ${RED}${FAILED_COUNT}${NC} âŒ"

if [ $FAILED_COUNT -gt 0 ]; then
    echo ""
    echo -e "${RED}Failed notebooks:${NC}"
    for nb in "${FAILED_NOTEBOOKS[@]}"; do
        echo -e "  ${RED}âŒ${NC} $nb"
    done
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Tips:${NC}"
    echo "  - Run with -v for detailed error output"
    echo "  - Check if Docker containers are needed (-d flag)"
    echo "  - Increase timeout with --timeout <seconds>"
    exit 1
else
    echo ""
    echo -e "${GREEN}ğŸ‰ All notebooks passed!${NC}"
    exit 0
fi
